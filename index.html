<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="时间旅行者" type="application/atom+xml">






<meta name="description" content="Java学习记录博客">
<meta property="og:type" content="website">
<meta property="og:title" content="时间旅行者">
<meta property="og:url" content="https://www.liutianruo.com/index.html">
<meta property="og:site_name" content="时间旅行者">
<meta property="og:description" content="Java学习记录博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="时间旅行者">
<meta name="twitter:description" content="Java学习记录博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.liutianruo.com/">





  <title>时间旅行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">时间旅行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-categories"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/07/21/MongoDB入门之CRUD/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/21/MongoDB入门之CRUD/" itemprop="url">MongoDB入门之CRUD</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-21T19:59:28+08:00">
                2019-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>什么是MongoDB：存储<strong>文档</strong>的非关系型数据库。</p>
<p>数据库 -&gt; 集合 -&gt;文档（json）</p>
<h1 id="基本操作之CRUD"><a href="#基本操作之CRUD" class="headerlink" title="基本操作之CRUD"></a>基本操作之CRUD</h1><p>C 创建</p>
<p>R 读取</p>
<p>U 更新</p>
<p>D 删除</p>
<h2 id="文档主键"><a href="#文档主键" class="headerlink" title="文档主键"></a>文档主键</h2><p>存储在mongodb集合中的文档都有一个文档主键<code>_id</code></p>
<ul>
<li>文档主键的唯一性</li>
<li>支持所有数据类型（数组除外）</li>
<li>复合主键</li>
</ul>
<h3 id="对象主键"><a href="#对象主键" class="headerlink" title="对象主键"></a>对象主键</h3><p>如果我们创建mongodb<strong>文档</strong>的时候，没有设置主键，那么mongdb会默认为我们生成<strong>对象主键</strong><code>ObjectId</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ObjectId</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>默认的文档主键</strong></li>
<li>可以快速生成的12字节id</li>
<li>包含创建时间（创建时间由客户端程序决定）</li>
</ul>
<p>对象主键的顺序<strong>基本</strong>就是文档创建的顺序</p>
<p><code>细节</code>：</p>
<ul>
<li>如果有多个文档同时被创建，那么无法区分这几个文档创建的顺序</li>
<li>多个文档被不同的客户端创建，那么不同客户端的时间也会影响文档的创建顺序</li>
</ul>
<h2 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h2><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ul>
<li><code>db.connection.insert()</code></li>
<li><code>db.connection.save()</code></li>
<li>创建多个文档</li>
</ul>
<h3 id="创建一个文档"><a href="#创建一个文档" class="headerlink" title="创建一个文档"></a>创建一个文档</h3><p>进入mongodb的bin目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\mongodb\bin</span><br></pre></td></tr></table></figure>
<p>使用cmd输入命令：</p>
<ul>
<li><p>mongodb</p>
</li>
<li><p>use test(使用test数据库)</p>
</li>
<li><p>show collections (查看test数据库下的集合)</p>
</li>
<li><p>开始创建第一个文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">db.&lt;collection&gt;.insertOne( // 1. &lt;collection&gt;集合名称</span><br><span class="line"> &lt;document&gt;,</span><br><span class="line">  &#123;</span><br><span class="line">    writeConcern : &lt;document&gt;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>writeConcern</code>文档定义了本次文档创建操作的<strong>安全写级别</strong></p>
<ul>
<li><strong>安全写级别</strong>用来判断一次数据库写操作是否成功。</li>
<li><strong>安全写级别</strong>越高，丢失数据风险越低；但是写入操作的延迟也可能更高。</li>
<li>如果不提供<code>writeConcern</code>文档，mongoDB使用默认的<strong>安全写级别</strong></li>
</ul>
</blockquote>
</li>
</ul>
<ul>
<li><p>准备写入数据库的文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    _id: &quot;account1&quot;, // 主键id</span><br><span class="line">    name: &quot;alice&quot;, // 账户名称</span><br><span class="line">    balance:100 // 账户余额</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>将文档写入<code>accounts</code>集合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.insertOne(</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    _id: &quot;account1&quot;, </span><br><span class="line">    name: &quot;alice&quot;, </span><br><span class="line">    balance:100 </span><br><span class="line">    </span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>db.accounts.insertOne()</code>的返回结果</p>
<p><code>{ &quot;acknowledged&quot; : true, &quot;insertedId&quot; : &quot;accounts1&quot; }</code></p>
<blockquote>
<ol>
<li>“acknowledged” : true 表示安全写级别被启用</li>
</ol>
<p>因为我们没有设置writeConcern文档，所以这里显示的是mongodb<strong>默认的安全写级别</strong>启用状态</p>
<ol>
<li>“insertedId” : “accounts1”  表示被写入的文档的_id</li>
</ol>
</blockquote>
</li>
</ul>
<p>思考：</p>
<ol>
<li><p>刚刚并没有创建accounts集合啊？？？</p>
<blockquote>
<p><code>db.accounts.insertOne(。。。)</code>命令会<strong>自动创建相应的集合</strong>。</p>
</blockquote>
</li>
</ol>
<ol>
<li><p>假如<code>db.accounts.insertOne(。。。)</code>出错了，这行命令会返回什么内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.insertOne( &#123; _id: &quot;accounts1&quot;, name:&quot;ajin&quot;, balance: 100 &#125; )</span><br><span class="line">2019-06-29T19:12:34.533+0800 E QUERY    [thread1] WriteError: E11000 duplicate key error collection: test.accounts index: _id_ dup key: &#123; : &quot;accounts1&quot; &#125; :</span><br><span class="line">WriteError(&#123;</span><br><span class="line">        &quot;index&quot; : 0,</span><br><span class="line">        &quot;code&quot; : 11000,</span><br><span class="line">        &quot;errmsg&quot; : &quot;E11000 duplicate key error collection: test.accounts index: _id_ dup key: &#123; : \&quot;accounts1\&quot; &#125;&quot;,</span><br><span class="line">        &quot;op&quot; : &#123;</span><br><span class="line">                &quot;_id&quot; : &quot;accounts1&quot;,</span><br><span class="line">                &quot;name&quot; : &quot;ajin&quot;,</span><br><span class="line">                &quot;balance&quot; : 100</span><br><span class="line">        &#125;</span><br><span class="line">&#125;)</span><br><span class="line">WriteError@src/mongo/shell/bulk_api.js:466:48</span><br><span class="line">Bulk/mergeBatchResults@src/mongo/shell/bulk_api.js:846:49</span><br><span class="line">Bulk/executeBatch@src/mongo/shell/bulk_api.js:910:13</span><br><span class="line">Bulk/this.execute@src/mongo/shell/bulk_api.js:1154:21</span><br><span class="line">DBCollection.prototype.insertOne@src/mongo/shell/crud_api.js:252:9</span><br><span class="line">@(shell):1:1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>   同时我们可以对<code>db.accounts.insertOne(。。。)</code>抛出的异常进行try-catch处理</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">try&#123;</span><br><span class="line">    db.accounts.insertOne(</span><br><span class="line">        &#123; </span><br><span class="line">            _id: &quot;accounts1&quot;,</span><br><span class="line">            name:&quot;ajin&quot;, </span><br><span class="line">         balance: 100 </span><br><span class="line">        &#125; </span><br><span class="line">    )</span><br><span class="line">&#125; catch (e)&#123;</span><br><span class="line">    print(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   控制台如下所示：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">WriteError(&#123;</span><br><span class="line">        &quot;index&quot; : 0,</span><br><span class="line">        &quot;code&quot; : 11000,</span><br><span class="line">        &quot;errmsg&quot; : &quot;E11000 duplicate key error collection: test.accounts index: _id_ dup key: &#123; : \&quot;accounts1\&quot; &#125;&quot;,</span><br><span class="line">        &quot;op&quot; : &#123;</span><br><span class="line">                &quot;_id&quot; : &quot;accounts1&quot;,</span><br><span class="line">                &quot;name&quot; : &quot;ajin&quot;,</span><br><span class="line">                &quot;balance&quot; : 100</span><br><span class="line">        &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>Tips：</strong></p>
<p>mongodb自动生成_id文档主键：（省略创建文档中的 _id字段）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.insertOne(</span><br><span class="line">        &#123; </span><br><span class="line">         name:&quot;ajin&quot;, </span><br><span class="line">         balance: 50 </span><br><span class="line">        &#125; </span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>控制台如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;acknowledged&quot; : true,</span><br><span class="line">        &quot;insertedId&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;)//自动生成的对象主键</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建多个文档"><a href="#创建多个文档" class="headerlink" title="创建多个文档"></a>创建多个文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.insertMany(</span><br><span class="line">    [&lt;document1&gt;,&lt;document2&gt;,...], //多个文档</span><br><span class="line">    &#123;</span><br><span class="line">        writeConcern : &lt;document&gt;,</span><br><span class="line">        ordered : &lt;boolean&gt;  // 用来决定mongoDB是否按顺序来写入这些文档</span><br><span class="line">    &#125;   </span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ordered : false</code> 代表mongodb可以打乱文档的写入顺序，以便优化写入操作的性能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ordered`默认值为`true</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>例子：写入两篇文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.insertMany([</span><br><span class="line">    </span><br><span class="line">       &#123; </span><br><span class="line">         name:&quot;axin&quot;, </span><br><span class="line">         balance: 500 </span><br><span class="line">        &#125;  ,</span><br><span class="line">       &#123;</span><br><span class="line">        name:&quot;ajay&quot;, </span><br><span class="line">         balance: 600 </span><br><span class="line">       &#125;</span><br><span class="line">    </span><br><span class="line"> ]</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>控制台输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     &quot;acknowledged&quot; : true,</span><br><span class="line">      &quot;insertedIds&quot; : [</span><br><span class="line">             ObjectId(&quot;5d17664c7d532fca455716f6&quot;),</span><br><span class="line">             ObjectId(&quot;5d17664c7d532fca455716f7&quot;)</span><br><span class="line">      ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>insertMany报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">try&#123;</span><br><span class="line">db.accounts.insertMany([</span><br><span class="line">    </span><br><span class="line">       &#123; </span><br><span class="line">         _id:&quot;accounts1&quot;,</span><br><span class="line">         name:&quot;axin&quot;, </span><br><span class="line">         balance: 500 </span><br><span class="line">        &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">        name:&quot;fly&quot;, </span><br><span class="line">         balance: 600 </span><br><span class="line">       &#125;</span><br><span class="line">    </span><br><span class="line"> ]</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    </span><br><span class="line">&#125;catch (e)&#123;</span><br><span class="line">    print(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ordered : true</code>创建多个文档后，如果写入某个文档出错，则这些文档都不会被写入mongodb；（顺序写入）</p>
<p><code>ordered : false</code>创建多个文档后，会写入正确的文档，不会写入错误的文档（乱序写入）</p>
<h2 id="读取文档"><a href="#读取文档" class="headerlink" title="读取文档"></a>读取文档</h2><ul>
<li><p><code>db.collection.find()</code></p>
<blockquote>
<p>匹配查询</p>
<p>查询操作符</p>
</blockquote>
</li>
</ul>
<h3 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h3><h4 id="游标"><a href="#游标" class="headerlink" title="游标"></a>游标</h4><p>​        </p>
<ol>
<li>查询操作返回的结果图标</li>
<li>游标的迭代与操作</li>
</ol>
<h4 id="投射"><a href="#投射" class="headerlink" title="投射"></a>投射</h4><p>匹配查询能够返回完整的文档，但有些时候我们只需要读取文档中几个字段的值。此时返回整篇文档既没有效率，又浪费系统资源。</p>
<p>​    </p>
<ol>
<li>只返回<strong>部分字段</strong></li>
<li>内嵌文档的投射</li>
<li>数组的投射</li>
</ol>
<h3 id="实际操作"><a href="#实际操作" class="headerlink" title="实际操作"></a>实际操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.find(&lt;query&gt;,&lt;projection&gt;)</span><br></pre></td></tr></table></figure>
<p><query>文档定义了读取操作时<strong>筛选文档的条件</strong></query></p>
<p><projection>文档定义了对读取结果进行的<strong>投射</strong></projection></p>
<h4 id="读取全部文档"><a href="#读取全部文档" class="headerlink" title="读取全部文档"></a><strong>读取全部文档</strong></h4><blockquote>
<p>既不筛选也不投射</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find()</span><br></pre></td></tr></table></figure>
<p>控制台输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>更清楚的显示文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find().prettt()</span><br><span class="line">&gt; db.accounts.find().pretty()</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;ajin&quot;,</span><br><span class="line">        &quot;balance&quot; : 50</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;axin&quot;,</span><br><span class="line">        &quot;balance&quot; : 500</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;ajay&quot;,</span><br><span class="line">        &quot;balance&quot; : 600</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;fly&quot;,</span><br><span class="line">        &quot;balance&quot; : 600</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;fly&quot;,</span><br><span class="line">        &quot;balance&quot; : 600</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="筛选文档"><a href="#筛选文档" class="headerlink" title="筛选文档"></a>筛选文档</h4><h5 id="匹配查询"><a href="#匹配查询" class="headerlink" title="匹配查询"></a>匹配查询</h5><p><strong>“读取ajin的银行账户文档”</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(  &#123; name: &quot;ajin&quot;&#125;  )</span><br><span class="line"> db.accounts.find( &#123;name :&quot;ajin&quot;&#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>“读取ajin的余额为50的银行账户文档”</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &quot;ajin&quot; ,balance : 50 &#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>“读取ajin的余额为100的银行账户文档”</strong></p>
<blockquote>
<p>其实不存在这条数据，所以控制台不返回任何信息</p>
</blockquote>
<p><strong>“读取银行账户类型为储蓄账户的文档”</strong></p>
<blockquote>
<p>使用了复合主键</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(  &#123;  &quot;_id.type&quot; : &quot;savings&quot; &#125;  )</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>_id</code>此处指的是一个复合主键，复合主键中有一个type属性，我们对type属性进行匹配查询</p>
</blockquote>
<p>查出来的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;_id&quot;: &#123; &quot;accountNo&quot; : &quot;001&quot; ,&quot;type&quot; :&quot;savings&quot; &#125; ,&quot;name&quot;: &quot;irene&quot; ,&quot;balance&quot; :3000&#125;</span><br></pre></td></tr></table></figure>
<h5 id="比较操作符"><a href="#比较操作符" class="headerlink" title="比较操作符"></a>比较操作符</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;field&gt; : &#123;  $&lt;operator&gt; : &lt;value&gt; &#125;  &#125;</span><br></pre></td></tr></table></figure>
<p>​    </p>
<ul>
<li><field> :   比较的字段</field></li>
<li>$<operator> :  比较操作符</operator></li>
<li><value> :  查询的值</value></li>
</ul>
<p><code>$eq</code>           匹配字段值相等的文档   equal</p>
<p><code>$ne</code>           匹配字段值不相等的文档   not equal</p>
<p><code>$gt</code>           匹配字段值大于查询值的文档 greater than</p>
<p><code>$gte</code>         匹配字段值大于或等于查询值的文档 </p>
<p><code>$lt</code>            匹配字段值小于查询值的文档</p>
<p><code>$lte</code>          匹配字段值小于或等于查询值的文档</p>
<h6 id="eq"><a href="#eq" class="headerlink" title="$eq"></a><code>$eq</code></h6><p><strong>读取ajin的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(  &#123; name : &#123; $eq :&quot;ajin&quot; &#125;     &#125;  )</span><br><span class="line"> db.accounts.find(  &#123; name : &quot;ajin&quot;&#125;) // 此处匹配查询更简洁一些</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &#123; $eq :&quot;ajin&quot; &#125;     &#125;  )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ne"><a href="#ne" class="headerlink" title="$ne"></a><code>$ne</code></h6><p><strong>读取不属于ajin的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;  name  : &#123; $ne : &quot;ajin&quot;&#125;  &#125;)</span><br><span class="line">db.accounts.find( &#123;  name  : &#123; $ne : &quot;ajin&quot;&#125;  &#125;)</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取余额不等于100的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; balance : &#123; $ne : 100&#125;  &#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>$ne</code>操作符也会筛选出并不包含查询字段的文档</p>
</blockquote>
<p><strong>读取银行账户类型不是储蓄账户的文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; &quot;_id.type&quot; : &#123; $ne : &quot;savings&quot; &#125;   &#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p>即使这篇文档并不包含该字段，该文档也会被筛选出来</p>
<blockquote>
<p>因为没有该字段，那么该文档自然满足查询条件</p>
</blockquote>
<h6 id="gt"><a href="#gt" class="headerlink" title="$gt"></a><code>$gt</code></h6><p><strong>读取余额大于500的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; balance : &#123; $gt : 500 &#125;  &#125; )</span><br><span class="line"> db.accounts.find( &#123; balance : &#123; $gt : 500&#125; &#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<h6 id="lt"><a href="#lt" class="headerlink" title="$lt"></a><code>$lt</code></h6><p><strong>读取用户名字排在 ajin之前的银行账户文档</strong>(用户名字按照字母排序)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &#123;  $lt : &quot;ajin&quot; &#125;    &#125; )</span><br><span class="line">&gt; db.accounts.find( &#123; name : &#123;  $lt : &quot;ajin&quot; &#125;    &#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><code>$in</code>    匹配字段值与任一查询值相等的文档</p>
<p><code>$nin</code>    匹配字段值与任何查询值都不相等的文档</p>
<p>tips :  windows系统打开mongdb/bin目录，双击mongo.exe即可连接到本地的mongodb，然后执行各种命令</p>
<h6 id="in"><a href="#in" class="headerlink" title="$in"></a><code>$in</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;  field   : &#123;  $in  :  [  &lt;value1&gt; , &lt;value2&gt; ,  …   &lt;valueN&gt;        ]   &#125;    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取ajin和ajay的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> db.accounts.find( &#123;  name : &#123; $in : [&quot;ajin&quot;,&quot;ajay&quot;]   &#125;    &#125;  )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<h6 id="nin"><a href="#nin" class="headerlink" title="$nin"></a><code>$nin</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;  field   : &#123;  $nin  :  [  &lt;value1&gt; , &lt;value2&gt; ,  …   &lt;valueN&gt;        ]   &#125;    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取除了ajin和ajay以外的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123; name : &#123; $nin : [&quot;ajin&quot;,&quot;ajay&quot;]  &#125;   &#125;  )</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><code>$nin</code>同样会查询出不存在该字段的记录，比如某条记录中不存在该字段，它也会被查询出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> db.accounts.find( &#123; cusere : &#123; $nin : [&quot;ajin&quot;, &quot;ajay&quot;]  &#125;   &#125;  )</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时发现，该集合中不存在这个字段，但是还是把所有文档都查出来了</p>
</blockquote>
<h5 id="逻辑操作符"><a href="#逻辑操作符" class="headerlink" title="逻辑操作符"></a>逻辑操作符</h5><p><code>$not</code>                匹配筛选条件不成立的文档</p>
<p><code>$and</code>                匹配多个筛选条件全部成立的文档</p>
<p><code>$or</code>                  匹配至少一个筛选条件成立的文档</p>
<p><code>$nor</code>                匹配多个筛选条件全部不成立的文档</p>
<h6 id="not"><a href="#not" class="headerlink" title="$not"></a><code>$not</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">( field  : &#123;  $not : &#123; &lt;operator-expression&gt;  &#125;  &#125;  )</span><br></pre></td></tr></table></figure>
<p><strong>读取余额不小于500的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; balance : &#123;  $not :  &#123;   $lt : 500  &#125; &#125; &#125; )</span><br><span class="line">&gt; db.accounts.find( &#123; balance : &#123; $not : &#123; $lt : 500 &#125; &#125; &#125;  )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>$not也会筛选中并不包含查询字段的文档</strong></p>
</blockquote>
<p>读取账户类型不是储蓄账户的银行文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; &quot;_id.type&quot; : &#123; $not : &#123; $eq :&quot;savings&quot; &#125;   &#125;   &#125;)</span><br><span class="line">&gt; db.accounts.find( &#123; &quot;_id.type&quot; : &#123; $not : &#123; $eq :&quot;savings&quot; &#125;   &#125;   &#125;)</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<h6 id="and"><a href="#and" class="headerlink" title="$and"></a><code>$and</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $and : [ &#123; &lt;expression1&gt; &#125;, &#123;&lt;expression2&gt; &#125;...    ]   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取余额大于100并且用户姓名排在ajin后面的银行账户</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(  &#123;  </span><br><span class="line"></span><br><span class="line">    $and  : [      </span><br><span class="line"></span><br><span class="line">        &#123;    balance :  &#123;  $gt  : 100 &#125;  &#125;,     </span><br><span class="line"></span><br><span class="line">        &#123;    name : &#123; $gt  : &quot;ajin&quot;    &#125;  &#125;        </span><br><span class="line"></span><br><span class="line">   ]  </span><br><span class="line"></span><br><span class="line">&#125; )</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123;  $and  : [       &#123;    balance :  &#123;  $gt  : 100 &#125;  &#125;,     &#123;  name : &#123; $gt  : &quot;ajin&quot;    &#125;  &#125;         ]  &#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>当筛选条件应用在不同字段上时，可以省略 $and操作符</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">   &#123; balance : &#123; $gt : 100&#125; &#125;,</span><br><span class="line">   &#123;  name  : &#123; $gt : &quot;ajin&quot;&#125;&#125;</span><br><span class="line">&#125; )</span><br></pre></td></tr></table></figure>
<p><strong>读取余额大于100但小于500的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( </span><br><span class="line"> &#123;  balance : &#123; $gt : 100 ,$lt : 1500&#125; &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<h6 id="or"><a href="#or" class="headerlink" title="$or"></a><code>$or</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $or : [ &#123; &lt;expression1&gt; &#125;, &#123;&lt;expression2&gt; &#125;...    ]   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取属于ajin或ajay的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line"></span><br><span class="line">    $or : [</span><br><span class="line">    &#123; name : &#123; $eq : &quot;ajin&quot; &#125; &#125;,</span><br><span class="line">    &#123; name :  &#123;$eq : &quot;ajay&quot; &#125; &#125;</span><br><span class="line">    </span><br><span class="line">    ]</span><br><span class="line">&#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>换一种简洁的写法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">   name : &#123; $in : [&quot;ajin&quot;, &quot;ajay&quot;]&#125;</span><br><span class="line">&#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取余额小于100或者余额大于500的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">    $or : [</span><br><span class="line">    &#123; balance : &#123; $lt : 100 &#125; &#125;,</span><br><span class="line">    &#123; balance : &#123; $gt : 500 &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f7&quot;), &quot;name&quot; : &quot;ajay&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<h6 id="nor"><a href="#nor" class="headerlink" title="$nor"></a><code>$nor</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $nor : [ &#123; &lt;expression1&gt; &#125;, &#123; &lt;expression2&gt; &#125;...    ]   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取不属于ajin和ajay并且余额不小于100的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">  $nor : [</span><br><span class="line">            &#123; name : &quot;ajin&quot;&#125;,</span><br><span class="line">            &#123; name : &quot;ajay&quot;&#125;,</span><br><span class="line">            &#123; balance : &#123; $lt : 100&#125; &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125; )</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>$nor也会筛选出并不包含查询字段的文档</strong></p>
<p><strong>读取账户类型不是(储蓄类型且余额大于500)的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">    $nor : [</span><br><span class="line">             &#123;&quot;_id.type&quot;:&quot;savings&quot;&#125;,</span><br><span class="line">             &#123; balance : &#123; $gt : 500 &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查出了没有复合主键的文档</p>
</blockquote>
<h5 id="字段操作符"><a href="#字段操作符" class="headerlink" title="字段操作符"></a>字段操作符</h5><p><code>$exists</code>         匹配包含查询字段的文档</p>
<p><code>$type</code>              匹配字段类型符合查询值的文档</p>
<h6 id="exists"><a href="#exists" class="headerlink" title="$exists"></a><code>$exists</code></h6><p><strong>语法：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; field :  &#123; $exists : &lt;boolean&gt; &#125; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取包含账户类型字段的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line"> &quot;_id.type&quot; : &#123;$exists : true &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>读取包含主键的银行账户文档</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> db.accounts.find( &#123;  &quot;_id&quot; : &#123;$exists : true &#125; &#125;)</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取账户类型不是支票用户的银行账户文档</strong></p>
<blockquote>
<p>之前的写法：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">&quot;_id.type&quot; : &#123; $ne : &quot;checking&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#125; )</span><br></pre></td></tr></table></figure>
<p>控制台输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p>仍然会查询出不包含_id.type字段的文档</p>
<p><strong>如果增加一个$exists操作符，就可以得到更准确的结果</strong></p>
<blockquote>
<p>过滤掉不包含该字段的文档</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(  &#123;</span><br><span class="line">&quot;_id.type&quot;: &#123; $ne : &quot;checking&quot; ,$exists : true &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>查出来为空，证明<code>$exists</code>起了作用</p>
<h6 id="type"><a href="#type" class="headerlink" title="$type"></a><code>$type</code></h6><p><strong>语法：</strong></p>
<ul>
<li><code>{ field : { $type : &lt;BSON type&gt; } }</code></li>
<li><code>{ field : { $type : [ &lt;BSON type1&gt; ,&lt;BSON type2&gt; , &lt;BSON type3&gt; , ... ] } }</code></li>
</ul>
<p><strong>读取文档主键是字符串的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">    _id : &#123; $type : &quot;string&quot;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取文档主键是对象主键或者是复合主键的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">   _id : &#123; $type : [&quot;objectId&quot;,&quot;object&quot;]  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>objectId表示对象主键，object表示复合主键</strong></p>
<p><strong>读取用户姓名为null的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line"> name : &#123; $type : &quot;null&quot; &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123;</span><br><span class="line">...  name : &#123; $type : &quot;null&quot; &#125;</span><br><span class="line">... &#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : null, &quot;balance&quot; : 50 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>总结</strong> ：mongodb文档中的字段类型有很多种，string ，null 等等</p>
<p><strong>也可以使用对应的BSON类型序列号作为$type操作符的参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; _id : &#123; $type : 2 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>序号2对应的是字符串类型</p>
</blockquote>
<h5 id="数组操作符"><a href="#数组操作符" class="headerlink" title="数组操作符"></a>数组操作符</h5><ul>
<li><code>$all</code>               匹配数组字段中包含所有查询值的文档</li>
<li><code>elemMatch</code>      匹配数组字段中至少存在一个值满足筛选条件的文档</li>
</ul>
<h6 id="all"><a href="#all" class="headerlink" title="$all"></a><code>$all</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;field&gt; : &#123; $all: [ &lt;value1&gt; ,&lt;value2&gt; ,&lt;value3&gt; ... ]  &#125;   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>创建包含数组和嵌套数组的文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.insert([</span><br><span class="line">    &#123;</span><br><span class="line">      name :&quot;jack&quot;,</span><br><span class="line">      balance : 2000,</span><br><span class="line">      contact : [&quot;11111&quot;,&quot;Alabama&quot;,&quot;US&quot;]</span><br><span class="line">    &#125; ,</span><br><span class="line">    &#123;</span><br><span class="line">      name : &quot;karen&quot;,</span><br><span class="line">      balance : 5000,</span><br><span class="line">      // 嵌套数组</span><br><span class="line">      contact : [ [&quot;22222&quot;,&quot;33333&quot;]  ,&quot;Beijing&quot;,&quot;China&quot;   ] </span><br><span class="line">    &#125;</span><br><span class="line"> ])</span><br><span class="line">BulkWriteResult(&#123;</span><br><span class="line">        &quot;writeErrors&quot; : [ ],</span><br><span class="line">        &quot;writeConcernErrors&quot; : [ ],</span><br><span class="line">        &quot;nInserted&quot; : 2,</span><br><span class="line">        &quot;nUpserted&quot; : 0,</span><br><span class="line">        &quot;nMatched&quot; : 0,</span><br><span class="line">        &quot;nModified&quot; : 0,</span><br><span class="line">        &quot;nRemoved&quot; : 0,</span><br><span class="line">        &quot;upserted&quot; : [ ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>读取联系地址是位于中国北京的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">    contact : &#123; $all : [&quot;China&quot;,&quot;Beijing&quot;] &#125;</span><br><span class="line">&#125;)</span><br><span class="line">// 输出结果：</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;), &quot;name&quot; : &quot;karen&quot;, &quot;balance&quot; : 5000, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取联系电话包含22222和33333的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">    contact : &#123; $all : [ [&quot;22222&quot;,&quot;33333&quot;]  ]  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">// 输出结果：</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;), &quot;name&quot; : &quot;karen&quot;, &quot;balance&quot; : 5000, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h6 id="elemMatch"><a href="#elemMatch" class="headerlink" title="$elemMatch"></a><code>$elemMatch</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; field : &#123; $elemMatch : &#123; &lt;query1&gt;, &lt;query2&gt; , ...  &#125; &#125; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取联系电话范围在10000到20000之间的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">    contact : &#123; $elemMatch :  &#123; $gt :&quot;10000&quot; ,$lt : &quot;20000&quot;  &#125; &#125;</span><br><span class="line">&#125;)</span><br><span class="line">// 输出结果</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;), &quot;name&quot; : &quot;jack&quot;, &quot;balance&quot; : 2000, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<p><strong>将$all和$elemMatch结合在一起使用</strong></p>
<p>实例：</p>
<p><strong>读取包含一个在10000到20000之间，和一个在20000到30000之间的联系电话的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;</span><br><span class="line">    contact : &#123;</span><br><span class="line">     $all : [</span><br><span class="line">       &#123; $elemMatch : &#123; $gt :&quot;10000&quot;,$lt : &quot;20000&quot;&#125; &#125;,</span><br><span class="line">       &#123; $elemMatch : &#123; $gt : &quot;20000&quot;,$lt : &quot;30000&quot;&#125; &#125;</span><br><span class="line">     ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查询结果为空，因为不存在这样的条件</p>
</blockquote>
<h5 id="运算操作符"><a href="#运算操作符" class="headerlink" title="运算操作符"></a>运算操作符</h5><ul>
<li><code>$regex</code>              匹配满足正则表达式的文档</li>
</ul>
<p><strong>语法：</strong></p>
<ul>
<li><code>{ &lt;field&gt; : { : /pattern/ , : &#39;&lt;options&gt;&#39;  } }</code> // 推荐使用</li>
<li><code>{ &lt;field&gt; : { : /pattern/&lt;options&gt;  } }</code></li>
</ul>
<p><strong>兼容PCRE  v8.41正则表达式库</strong></p>
<p><strong>在和$in操作符一起使用时， 只能使用/pattern/<options></options></strong></p>
<p><strong>读取用户姓名与a或者j开头的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &#123; $in : [ /^a/ , /^j/ ]  &#125;  &#125;)</span><br><span class="line"> &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;), &quot;name&quot; : &quot;jack&quot;, &quot;balance&quot; : 2000, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<p><strong>读取用户姓名包含ACK（不区分大小写）的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &#123; $regex : /ACK/ ,$options : &apos;i&apos; &#125;  &#125; )</span><br><span class="line"></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;), &quot;name&quot; : &quot;jack&quot;, &quot;balance&quot; : 2000, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>$options :&#39;i&#39;</code>：忽略大小写，不区分大小写</p>
</blockquote>
<p><strong>关于正则表达式，平时多了解</strong></p>
<h5 id="文档游标"><a href="#文档游标" class="headerlink" title="文档游标"></a>文档游标</h5><p><code>db.collection.find()</code>返回一个文档集合游标</p>
<p><strong>在不迭代游标的情况下，只列出前20个文档</strong>(默认情况下)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var myCursor = db.accounts.find() ;</span><br><span class="line">&gt; db.accounts.find()</span><br><span class="line"></span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : null, &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;), &quot;name&quot; : &quot;jack&quot;, &quot;balance&quot; : 2000, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;), &quot;name&quot; : &quot;karen&quot;, &quot;balance&quot; : 5000, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<p><strong>我们也可以使用游标下标直接访问文档集合中的某一个文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var myCursor = db.accounts.find();</span><br><span class="line">myCursor[1] // 对应文档集合中的第二篇文档</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;),</span><br><span class="line">        &quot;name&quot; : null,</span><br><span class="line">        &quot;balance&quot; : 50</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>游历完游标中所有的文档之后，或者在10分钟之后，游标便会自动关闭</strong></p>
<blockquote>
<p>这是游标的默认行为</p>
</blockquote>
<p><strong>可以使用noCursorTimeout()函数来保持游标一直有效</strong>(但是遍历游标中所有文档后，游标还是会自动关闭)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var myCursor = db.accounts.find().noCursorTimeout();</span><br></pre></td></tr></table></figure>
<p><strong>在这之后，在不遍历游标的情况下，你需要主动关闭游标</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myCursor.close();</span><br></pre></td></tr></table></figure>
<h5 id="游标函数"><a href="#游标函数" class="headerlink" title="游标函数"></a>游标函数</h5><p>###### </p>
<h6 id="cursor-hasNext"><a href="#cursor-hasNext" class="headerlink" title="cursor.hasNext()"></a><strong>cursor.hasNext()</strong></h6><h6 id="cursor-next"><a href="#cursor-next" class="headerlink" title="cursor.next()"></a><strong>cursor.next()</strong></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var myCursor = db.accounts.find( &#123; name : &quot;axin&quot; &#125;);</span><br><span class="line">while(myCursor.hasNext())&#123; </span><br><span class="line">    printjson(myCursor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;axin&quot;,</span><br><span class="line">        &quot;balance&quot; : 500</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;),</span><br><span class="line">        &quot;id&quot; : &quot;accounts1&quot;,</span><br><span class="line">        &quot;name&quot; : &quot;axin&quot;,</span><br><span class="line">        &quot;balance&quot; : 500</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>遍历后，游标就自动关闭了</p>
</blockquote>
<h6 id="cursor-forEach"><a href="#cursor-forEach" class="headerlink" title="cursor.forEach(  )"></a><strong>cursor.forEach( <function> )</function></strong></h6><blockquote>
<p>更方便地遍历游标指向的文档</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var myCursor = db.accounts.find( &#123; name : &quot;axin&quot; &#125;);</span><br><span class="line">myCursor.forEach(printjson);</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;axin&quot;,</span><br><span class="line">        &quot;balance&quot; : 500</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;),</span><br><span class="line">        &quot;id&quot; : &quot;accounts1&quot;,</span><br><span class="line">        &quot;name&quot; : &quot;axin&quot;,</span><br><span class="line">        &quot;balance&quot; : 500</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="cursor-limit"><a href="#cursor-limit" class="headerlink" title="cursor.limit()"></a><strong>cursor.limit(<number>)</number></strong></h6><h6 id="cursor-skip"><a href="#cursor-skip" class="headerlink" title="cursor.skip()"></a><strong>cursor.skip(<offset>)</offset></strong></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &quot;axin&quot;&#125; ).limit(1)</span><br><span class="line"></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 500 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>只返回一篇文档</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &quot;axin&quot;&#125; ).skip(1)</span><br><span class="line"></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>跳过前一篇文档 ，只返回这两篇文档中的第二篇文档</p>
</blockquote>
<p><strong>cursor.limit(0)会返回什么结果？</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 800 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 600 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>返回所有符合条件的文档，不做任何限制</p>
</blockquote>
<h6 id="cursor-apply"><a href="#cursor-apply" class="headerlink" title="cursor.apply()"></a><strong>cursor.apply(<applyskiplimit>)</applyskiplimit></strong></h6><p><strong>默认情况下，<applyskiplimit>为false，即cursor.count()不会考虑cursor.limit() 和 cursor.skip()的效果</applyskiplimit></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &quot;axin&quot; &#125;).limit(1).count()</span><br><span class="line">// 返回2，如果不加limit(1)直接返回1</span><br><span class="line">db.accounts.find( &#123; name : &quot;axin&quot; &#125;).limit(1).count(true)</span><br><span class="line">// 返回1</span><br></pre></td></tr></table></figure>
<p><strong>在不提供筛选条件时，cursor.count()会从集合的元数据metadata中取得结果</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find().count()</span><br><span class="line">// 返回8</span><br></pre></td></tr></table></figure>
<p><strong>当数据库分布式结构较为复杂时，元数据的文档数量可能不准确。</strong></p>
<p><strong>在这种情况下，应该避免应用不提供筛选条件的cursor.count()函数，而使用聚合管道来计算文档数量</strong></p>
<h6 id="cursor-sort-lt-document-gt"><a href="#cursor-sort-lt-document-gt" class="headerlink" title="cursor.sort(&lt;document&gt;)"></a><code>cursor.sort(&lt;document&gt;)</code></h6><p><strong>这里的<document>定义了排序的要求</document></strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; field : ordering &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>1 ： 正向排序</li>
<li>2： 逆向排序</li>
</ul>
<p><strong>按照余额从大到小，用户名字按字母排序的方式排列银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find().sort( &#123;balance: -1  ,name : 1&#125;)</span><br><span class="line">// 排序结果</span><br><span class="line">&gt; db.accounts.find().sort(&#123; balance : -1 , name : 1 &#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;), &quot;name&quot; : &quot;karen&quot;, &quot;balance&quot; : 5000, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;), &quot;name&quot; : &quot;jack&quot;, &quot;balance&quot; : 2000, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 800 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : null, &quot;balance&quot; : 50 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>先按照余额从大到小排序，如果余额一样，就按照用户名字母顺序进行升序排序</p>
</blockquote>
<p><strong>如果用户名和余额都相同的几个文档，该如何确定顺序呢？</strong></p>
<blockquote>
<p>我觉得是按照创建时间来排序的</p>
</blockquote>
<p><strong>读取余额最大的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find().sort( &#123; balance : -1&#125;).limit(1)</span><br><span class="line"></span><br><span class="line">// 结果</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;), &quot;name&quot; : &quot;karen&quot;, &quot;balance&quot; : 5000, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h6 id="游标函数执行顺序"><a href="#游标函数执行顺序" class="headerlink" title="游标函数执行顺序"></a>游标函数执行顺序</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor.skip()`  ，`cursor.limit()` ， `cursor.sort()</span><br></pre></td></tr></table></figure>
<ol>
<li><p><code>cursor.skip()</code>在<code>cursor.limit()</code>之前执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find().limit(5).skip(3)</span><br><span class="line"></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;), &quot;name&quot; : &quot;jack&quot;, &quot;balance&quot; : 2000, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;), &quot;name&quot; : &quot;karen&quot;, &quot;balance&quot; : 5000, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>先跳过前三条文档，再筛选出5条文档</p>
</blockquote>
<ol>
<li><p><code>cursor.sort()</code>永远在<code>cursor.skip()</code>和<code>cursor.limit()</code>之前执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find().skip(3).limit(5).sort( &#123; balance : -1&#125; )</span><br><span class="line"></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : null, &quot;balance&quot; : 50 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>先逆向排序，再跳过前三篇文档，返回5篇文档</p>
</blockquote>
</li>
</ol>
<p><strong>总结：这三个游标函数的执行顺序：sort()，skip() , limit()</strong>(永远)</p>
<h5 id="文档投影"><a href="#文档投影" class="headerlink" title="文档投影"></a>文档投影</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(&lt;query&gt;,&lt;projection&gt;)</span><br></pre></td></tr></table></figure>
<ul>
<li><query> 查询文档</query></li>
<li><projection>  投影文档</projection></li>
</ul>
<p><strong>不使用投影时，db.collection.find()会返回符合筛选条件的完整文档</strong></p>
<p><strong>而使用投影可以有选择性的返回文档中的部分字段</strong></p>
<p><strong>语法</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; field : inclusion&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>1  : 表示返回字段</li>
<li>0  ： 表示不返回字段</li>
</ul>
<p><strong>只返回银行账户文档的用户姓名</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;&#125;, &#123; name : 1 &#125; )</span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;), &quot;name&quot; : &quot;jack&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;), &quot;name&quot; : &quot;karen&quot; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>主键默认是返回的。</p>
</blockquote>
<p><strong>我们可以设置不返回主键</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;&#125; , &#123; name :1 ,_id:0 &#125;)</span><br><span class="line">&#123; &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>不返回银行账户文档中的用户姓名（也不返回文档主键）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;&#125;, &#123; name : 0 ,_id :0 &#125; )</span><br><span class="line">&#123; &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;balance&quot; : 50 &#125;</span><br><span class="line">&#123; &quot;balance&quot; : 800 &#125;</span><br><span class="line">&#123; &quot;id&quot; : &quot;accounts1&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;balance&quot; : 2000, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;balance&quot; : 5000, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<p><strong>除了文档主键外，我们不可以在投影文档中混合使用包含和不包含这两种投影操作。</strong></p>
<p><strong>要么在投影文档中列出所有应该包含的字段，要么列出所有不应该包含的字段。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123;&#125; , &#123; name :1 ,_id:0 ,balance :0&#125;)</span><br><span class="line">Error: error: &#123;</span><br><span class="line">        &quot;ok&quot; : 0,</span><br><span class="line">        &quot;errmsg&quot; : &quot;Projection cannot have a mix of inclusion and exclusion.&quot;,</span><br><span class="line">        &quot;code&quot; : 2,</span><br><span class="line">        &quot;codeName&quot; : &quot;BadValue&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="在数组字段上使用投影"><a href="#在数组字段上使用投影" class="headerlink" title="在数组字段上使用投影"></a>在数组字段上使用投影</h6><p><strong>$slice操作符可以返回数组字段中的部分元素</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;&#125;, &#123; _id : 0 , name : 1 ,contact : 1&#125;)</span><br><span class="line">&#123; &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;&#125; , &#123;_id : 0 ,name : 1 ,contact : &#123; $slice : 1&#125; &#125;)</span><br><span class="line">&#123; &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;contact&quot; : [ &quot;11111&quot; ] &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ] ] &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>$slice : 1</code>只返回contact数组中的第一个元素</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;&#125; , &#123;_id : 0 ,name : 1 ,contact : &#123; $slice : -1&#125; &#125;)</span><br><span class="line">&#123; &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;contact&quot; : [ &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;contact&quot; : [ &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>$slice : -1</strong>返回数组中最后一个元素</p>
</blockquote>
<p><code>$slice : -2</code>返回数组中最后两个元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;contact&quot; : [ &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;contact&quot; : [ &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123;&#125; , &#123;_id : 0 ,name : 1 ,contact : &#123; $slice : 2&#125; &#125;)</span><br><span class="line">&#123; &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;contact&quot; : [ &quot;11111&quot;, &quot;Alabama&quot; ] &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;contact&quot; : [ [ &quot;22222&quot;, &quot;33333&quot; ], &quot;Beijing&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>返回数组中前两个元素</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;&#125;,&#123; _id:0 , name : 1 ,contact : &#123;$slice : [1,2] &#125; &#125;  )</span><br><span class="line">&#123; &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;contact&quot; : [ &quot;Alabama&quot;, &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;contact&quot; : [ &quot;Beijing&quot;, &quot;China&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>skip(1) ，limit(2)  </p>
<p>跳过数组中第一个元素，选择两个元素</p>
</blockquote>
<p><strong>elemMatch和$操作符可以返回数组字段中符合筛选条件的第一个元素</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(&#123;&#125;,&#123; _id :0 , name :1 , contact : &#123;$elemMatch :&#123; $gt :&quot;Alabama&quot; &#125; &#125; &#125; )</span><br><span class="line"></span><br><span class="line">&#123; &quot;name&quot; : &quot;alice&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : null &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;contact&quot; : [ &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;contact&quot; : [ &quot;Beijing&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<p>如下语句可以达到相同的效果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123;contact: &#123; $gt : &quot;Alabama&quot;&#125; &#125;, &#123;_id : 0, name : 1, &quot;contact.$&quot;: 1 &#125;)</span><br><span class="line"></span><br><span class="line"> &quot;name&quot; : &quot;jack&quot;, &quot;contact&quot; : [ &quot;US&quot; ] &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;contact&quot; : [ &quot;Beijing&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><strong>使用db.collection.find()读取文档</strong></p>
<p><strong>比较操作符</strong></p>
<p><strong>逻辑操作符</strong></p>
<p><strong>字段操作符</strong></p>
<p><strong>数组操作符</strong></p>
<p><strong>运算操作符</strong></p>
<p><strong>文档游标函数</strong></p>
<p><strong>文档投影操作</strong></p>
<h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><ul>
<li><code>db.collection.update()</code></li>
<li><code>db.collection.findAndModify()</code></li>
<li><code>db.collection.save()</code></li>
</ul>
<ul>
<li><p>更新文档操作符 </p>
<blockquote>
<p>对感兴趣的字段特定的更新</p>
</blockquote>
</li>
<li><p>更新多个文档</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update()</span><br></pre></td></tr></table></figure>
<p><strong>语法：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.update(&lt;query&gt;,&lt;update&gt;,&lt;options&gt;)</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>&lt;query&gt;</code>文档定义了更新操作时筛选文档的条件</p>
<blockquote>
<p>我们到底要对哪些文档执行更新操作</p>
</blockquote>
</li>
<li><p><code>&lt;update&gt;</code>文档提供了更新的内容</p>
</li>
<li><p><code>&lt;options&gt;</code>文档声明了一些更新操作的参数</p>
</li>
</ul>
<h3 id="更新整篇文档"><a href="#更新整篇文档" class="headerlink" title="更新整篇文档"></a>更新整篇文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update()</span><br><span class="line">db.collection.update(&lt;query&gt;,&lt;update&gt;,&lt;options&gt;)</span><br></pre></td></tr></table></figure>
<p>如果<update>文档不包含任何<strong>更新操作符</strong>，<code>db.collection.update()</code>将会使用<update>文档直接替换集合中符合<query>文档筛选条件的文档。</query></update></update></p>
<p> 根据例子理解下：</p>
<p><strong>先查询alice用户的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123;name : &quot;alice&quot;&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>{ “_id” : “accounts1”, “name” : “alice”, “balance” : 100 }</p>
</blockquote>
<p><strong>将alice的余额改成123</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update( &#123; name : &quot;alice&quot;&#125; , &#123; name : &quot;alice&quot; ,balance : 123 &#125;)</span><br></pre></td></tr></table></figure>
<p><strong>几个需要注意的问题</strong></p>
<p><strong>1. 文档主键_id是不可以修改的</strong></p>
<p><strong>2. 当使用<update> 文档替换整篇被更新文档时，只有第一篇符合<query>条件的文档才会被更新</query></update></strong></p>
<p>假如符合筛选记录的文档有两条，但是只会更新第一条文档。</p>
<blockquote>
<p>{ “<em>id” : “accounts1”, “name” : “changge”, “balance” : 50, “gender” : “F” } { “</em>id” : ObjectId(“5d1749847d532fca455716f5”), “name” : null, “balance” : 50 }</p>
</blockquote>
<p><strong>局限性</strong></p>
<p><strong>更新整篇文档的操作只能应用在单一文档上</strong></p>
<h3 id="更新特定字段"><a href="#更新特定字段" class="headerlink" title="更新特定字段"></a>更新特定字段</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update()</span><br><span class="line">db.collection.update( &lt;query&gt; , &lt;update&gt; , &lt;options&gt; )</span><br></pre></td></tr></table></figure>
<p>如果<update>文档中只包含<strong>更新操作符</strong>，<code>db.collection.update()</code>将会使用<update>文档更新集合中符合<query>文档筛选条件的文档中的<strong>特定字段</strong>。</query></update></update></p>
<h4 id="更新操作符"><a href="#更新操作符" class="headerlink" title="更新操作符"></a>更新操作符</h4><h5 id="文档更新操作符"><a href="#文档更新操作符" class="headerlink" title="文档更新操作符"></a>文档更新操作符</h5><ul>
<li><code>$set</code>            更新或新增字段</li>
<li><code>$unset</code>        删除字段</li>
<li><code>$rename</code>      重命名字段</li>
<li><code>$inc</code>              加减字段值</li>
<li><code>$mul</code>                  相乘字段值</li>
<li><code>$min</code>                  比较后减小字段值</li>
<li><code>$max</code>                  比较后增大字段值</li>
</ul>
<h6 id="set"><a href="#set" class="headerlink" title="$set"></a><code>$set</code></h6><p><strong>更新或新增字段</strong></p>
<p><strong>语法：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $set : &#123; &lt;field1&gt; : &lt;value1&gt;  , ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>例子：</strong></p>
<p><strong>查看jack的银行账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &quot;jack&quot; &#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;balance&quot; : 2000,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;11111&quot;,</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>更新jack的银行账户余额和开户信息</strong></p>
<p>思路 ：</p>
<ol>
<li><p>找到jack对应的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2. 更新银行账户余额</span><br></pre></td></tr></table></figure>
<ol>
<li>新增开户信息字段</li>
</ol>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update( </span><br><span class="line">  &#123; name : &quot;jack&quot;&#125; ,</span><br><span class="line">  &#123; $set : </span><br><span class="line">     &#123;</span><br><span class="line">      balance : 3000,</span><br><span class="line">      info : &#123; </span><br><span class="line">         dateopened : new Date(&quot;2016-05-18T16:00:00z&quot;), </span><br><span class="line">         branch : &quot;branch1&quot; &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<p><code>info</code>本身作为jack这篇文档中的<strong>内嵌文档</strong>而存在。</p>
<p>现在看一下我们刚刚更新的那篇文档。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123;name : &quot;jack&quot; &#125;).pretty()</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;balance&quot; : 3000,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;11111&quot;,</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateopened&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),</span><br><span class="line">                &quot;branch&quot; : &quot;branch1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://liutianruo-2019-go-go-go.oss-cn-shanghai.aliyuncs.com/images/mongodb1.png" alt="img"></p>
<p>contact 是一个数组 Array</p>
<p>info是一个<strong>内嵌文档</strong>，对应Object类型</p>
<p><strong>更新或新增内嵌文档的字段</strong></p>
<p>例子：</p>
<p><strong>更新jack的银行账户的开户时间</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">    &#123; name : &quot;jack&quot; &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">     $set : &#123;</span><br><span class="line">       &quot;info.dateopened&quot; : new Date(&quot;2017-01-01T16:00:00Z&quot;)</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>成功更新后，我们查出该文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(&#123; name : &quot;jack&quot;&#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;balance&quot; : 3000,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;11111&quot;,</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateopened&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;branch&quot; : &quot;branch1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>开户时间已经被成功修改</p>
</blockquote>
<p><strong>更新或新增数组内的字段</strong></p>
<p>例子：</p>
<p><strong>更新jack的联系电话</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;jack&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">    $set : &#123;</span><br><span class="line">        &quot;contact.0&quot; :&quot;18888&quot; // 更新contact数组中的第一个元素</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123; name : &quot;jack&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;balance&quot; : 3000,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;199999&quot;,</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateopened&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;branch&quot; : &quot;branch1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>联系电话已经被修改</p>
</blockquote>
<p><strong>添加jack的联系方式</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;jack&quot;&#125;,</span><br><span class="line">   &#123;</span><br><span class="line">       $set : &#123;</span><br><span class="line">           &quot;contact.3&quot;: &quot;new Contact Way!&quot;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<p>把jack再查出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;balance&quot; : 3000,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;199999&quot;,</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;,</span><br><span class="line">                &quot;new Contact Way!&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateopened&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;branch&quot; : &quot;branch1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>再次添加jack的联系方式</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;jack&quot;&#125;,</span><br><span class="line">   &#123;</span><br><span class="line">       $set : &#123;</span><br><span class="line">           &quot;contact.5&quot;: &quot;another new Contact Way!&quot;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<p>contact数组本来有4个元素，现在添加第6个元素，居然也是成功的！！！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123; name : &quot;jack&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;balance&quot; : 3000,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;199999&quot;,</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;,</span><br><span class="line">                &quot;new Contact Way!&quot;,</span><br><span class="line">                null,</span><br><span class="line">                &quot;another new Contact Way!&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateopened&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;branch&quot; : &quot;branch1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时第5个元素被设置为null</p>
</blockquote>
<p>结论：</p>
<p><strong>如果向现有数组字段范围以外的位置添加新值，数组字段的长度会扩大，未被赋值的数组成员将被设置为null</strong></p>
<h6 id="unset"><a href="#unset" class="headerlink" title="$unset"></a><code>$unset</code></h6><p>删除操作符，用于删除字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $unset : &#123; &lt;field1&gt; : &quot;&quot; ,  … &#125;  &#125;</span><br></pre></td></tr></table></figure>
<p><strong>删除jack的银行账户余额和开户地点</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;jack&quot; &#125;,</span><br><span class="line">   &#123; $unset : &#123;</span><br><span class="line">       balance : &quot;&quot;,</span><br><span class="line">       &quot;info.branch&quot;: &quot;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;199999&quot;,</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;,</span><br><span class="line">                &quot;new Contact Way!&quot;,</span><br><span class="line">                null,</span><br><span class="line">                &quot;another new Contact Way!&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateopened&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意点：</strong></p>
<p><strong>1. 其实$unset命令中的赋值(“”)对操作结果并没有任何影响</strong></p>
<p>例子：</p>
<p><strong>删除jack的银行开户时间</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;jack&quot; &#125;,</span><br><span class="line">   &#123; $unset : &#123;</span><br><span class="line">       &quot;info.dateopened&quot;: &quot; this can be any value&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> db.accounts.find( &#123; name : &quot;jack&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;199999&quot;,</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;,</span><br><span class="line">                &quot;new Contact Way!&quot;,</span><br><span class="line">                null,</span><br><span class="line">                &quot;another new Contact Way!&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 如果$unset命令中的字段根本不存在，那么文档内容将保持不变</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;jack&quot; &#125;,</span><br><span class="line">   &#123; $unset : &#123;</span><br><span class="line">       notExist: &quot;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>经实操验证，这样不会影响文档的内容</p>
</blockquote>
<p><strong>$unset删除数组内字段</strong></p>
<p>例子： 删除jack的联系电话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update( </span><br><span class="line">  &#123;name : &quot;jack&quot;&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   $unset : &#123;</span><br><span class="line">        &quot;contact.0&quot;: &quot;&quot;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> db.accounts.find( &#123; name : &quot;jack&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e22&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;jack&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                null,// 联系方式被删除</span><br><span class="line">                &quot;Alabama&quot;,</span><br><span class="line">                &quot;US&quot;,</span><br><span class="line">                &quot;new Contact Way!&quot;,</span><br><span class="line">                null,</span><br><span class="line">                &quot;another new Contact Way!&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<p><strong>数组的长度是不变的，但是第一个元素的值被设置成null</strong></p>
<h6 id="rename"><a href="#rename" class="headerlink" title="$rename"></a><code>$rename</code></h6><p><strong>重命名字段</strong></p>
<p><strong>注意：</strong></p>
<p><strong>如果rename要重命名的字段并不存在，那么文档内容不会被改变。</strong></p>
<p>比如说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;jack&quot;&#125;,</span><br><span class="line"> &#123;</span><br><span class="line">  $rename : &#123;</span><br><span class="line">     &quot;notExist&quot; :  &quot;renamed&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>如果新的字段名已经存在，那么原有的这个字段会被覆盖。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;jack&quot;&#125; ,</span><br><span class="line">  &#123;</span><br><span class="line">    $rename : &#123;</span><br><span class="line">      &quot;name&quot; : &quot;contact&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时name字段就不存在了</p>
</blockquote>
<p><strong>当$rename命令中的新字段存在时,$rename命令会先$unset新旧字段，然后再$set新字段</strong></p>
<p><strong>重命名内嵌文档的字段</strong></p>
<p>例子 ： </p>
<p>更新karen的银行账户的开户时间和联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update( </span><br><span class="line">  &#123; name : &quot;karen&quot;&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   $set : &#123;</span><br><span class="line">    info : &#123;</span><br><span class="line">      dateOpene : new Date(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">      branch : &quot;branch1&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;contact.3&quot; : &#123;</span><br><span class="line">        primaryEmail : &quot;xx@qq.com&quot;,</span><br><span class="line">        secondEmail : &quot;xx@163.com&quot;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>查询karen的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123; name : &quot;karen&quot; &#125;).pretty()</span><br><span class="line"> &#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;balance&quot; : 5000,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;branch&quot; : &quot;branch1&quot;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>更新账户余额和开户地点字段在文档中的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;karen&quot;&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $rename : &#123;</span><br><span class="line">      &quot;info.branch&quot;: &quot;branch&quot;,</span><br><span class="line">      &quot;balance&quot; : &quot;info.balance&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123; name : &quot;karen&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                   &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;balance&quot; : 5000</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;branch&quot; : &quot;branch1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>重命名数组中内嵌文档的字段</strong>（不可以）</p>
<p>例子： 更新karen的联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $rename : &#123;</span><br><span class="line">       &quot;contact.3.primaryEmail&quot;: &quot;primaryEmail&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这么写是报错的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123;</span><br><span class="line">        &quot;nMatched&quot; : 0,</span><br><span class="line">        &quot;nUpserted&quot; : 0,</span><br><span class="line">        &quot;nModified&quot; : 0,</span><br><span class="line">        &quot;writeError&quot; : &#123;</span><br><span class="line">                &quot;code&quot; : 2,</span><br><span class="line">                &quot;errmsg&quot; : &quot;The source field cannot be an array element, &apos;contact.3.primaryEmail&apos; in doc with _id: ObjectId(&apos;5d2a9adda4078bad80fc7e23&apos;) has an array field called &apos;contact&apos;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;karen&quot;&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   $rename : &#123;</span><br><span class="line">     &quot;branch&quot; : &quot;contact.3.branch&quot;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">WriteResult(&#123;</span><br><span class="line">        &quot;nMatched&quot; : 0,</span><br><span class="line">        &quot;nUpserted&quot; : 0,</span><br><span class="line">        &quot;nModified&quot; : 0,</span><br><span class="line">        &quot;writeError&quot; : &#123;</span><br><span class="line">                &quot;code&quot; : 2,</span><br><span class="line">                &quot;errmsg&quot; : &quot;The destination field cannot be an array element, &apos;contact.3.branch&apos; in doc with _id: ObjectId(&apos;5d2a9adda4078bad80fc7e23&apos;) has an array field called &apos;contact&apos;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>$rename命令中的旧字段和新字段都不可以指向数组元素</strong></p>
<p><strong>但是$unset和$set是可以对数组元素操作的</strong></p>
<h6 id="inc"><a href="#inc" class="headerlink" title="$inc"></a><code>$inc</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $inc : &#123; &lt;field1&gt; : &lt;amount1&gt; , ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>更新字段值</p>
<p>查看ajin的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find( &#123; name : &quot;ajin&quot;&#125; )</span><br><span class="line"> &#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;ajin&quot;,</span><br><span class="line">        &quot;balance&quot; : 50</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>更新ajin的账户余额</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update( </span><br><span class="line">  &#123; name : &quot;ajin&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $inc : &#123;</span><br><span class="line">     balance : -0.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> db.accounts.find( &#123; name : &quot;ajin&quot;&#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;ajin&quot;,</span><br><span class="line">        &quot;balance&quot; : 49.5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="mul"><a href="#mul" class="headerlink" title="$mul"></a><code>$mul</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $mul : &#123; &lt;field1&gt; : &lt;amount1&gt; , ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>更新字段值</p>
<p>例子：</p>
<p>更新ajin的账户余额</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update( </span><br><span class="line">  &#123; name : &quot;ajin&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $mul : &#123;</span><br><span class="line">     balance : 0.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>余额修改为原来的0.5倍</p>
</blockquote>
<p><strong>注意：1. $inc和$mul只能用于数字字段上</strong></p>
<p><strong>2. 如果被更新的字段不存在</strong></p>
<p> 看一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update( </span><br><span class="line">  &#123; name : &quot;ajin&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $inc : &#123;</span><br><span class="line">     notYetExist : 10</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<p>我们把ajin查出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;ajin&quot;,</span><br><span class="line">        &quot;balance&quot; : 25,</span><br><span class="line">        &quot;notYetExist&quot; : 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现  这个字段新增到了文档中</p>
<p>如果是<code>$mul</code>呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update( </span><br><span class="line">  &#123; name : &quot;ajin&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $mul : &#123;</span><br><span class="line">     notYetEither : 10</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<p>把ajin对应的文档查出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;ajin&quot;,</span><br><span class="line">        &quot;balance&quot; : 25,</span><br><span class="line">        &quot;notYetExist&quot; : 10,</span><br><span class="line">        &quot;notYetEither&quot; : 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果被更新的字段不存在，$inc会创建字段，并且将字段值设置为命令中的增减值，而$mul会创建字段，但是把字段值设为0</strong></p>
<h6 id="minand-max"><a href="#minand-max" class="headerlink" title="$minand$max"></a><code>$min</code>and<code>$max</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; $min : &#123; &lt;field1&gt; :&lt;value1&gt; , ... &#125; &#125;</span><br><span class="line">&#123; $max : &#123; &lt;field1&gt; :&lt;value1&gt; , ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>比较之后更新字段值</strong></p>
<p>例子：</p>
<p>查看karen的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(</span><br><span class="line">   &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">   &#123; name : 1 , info :1,_id:0&#125; // 文档投影，声明想获取的部分字段</span><br><span class="line">)</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;info&quot; : &#123; &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;), &quot;balance&quot; : 5000 &#125; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>对应到MySQL中就是 ： select name , info from accounts where name = ‘karen’ ;</p>
</blockquote>
<p>更新karen的账户余额</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $min : &#123;</span><br><span class="line">     &quot;info.balance&quot; : 1000</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>比较balance原有的值(5000)和1000比较，取较小的值1000</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(    &#123; name : &quot;karen&quot; &#125;,    &#123; name : 1 , info :1,_id:0&#125; )</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;info&quot; : &#123; &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;), &quot;balance&quot; : 1000 &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>现在karen的账户余额为1000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $max : &#123;</span><br><span class="line">     &quot;info.balance&quot; : 6000</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line">&gt; db.accounts.find(    &#123; name : &quot;karen&quot; &#125;,    &#123; name : 1 , info :1,_id:0&#125; )</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot;, &quot;info&quot; : &#123; &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;), &quot;balance&quot; : 6000 &#125; &#125;</span><br></pre></td></tr></table></figure>
<p> 1000 和6000比，保留最大的值6000</p>
<p>更新karen的开户时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $min : &#123;</span><br><span class="line">     &quot;info.dateOpene&quot; : new Date(&quot;2016-01-01T18:00:00Z&quot;)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>开户日期会提前到2016年</p>
</blockquote>
<p><strong>$min和$max不仅可用于数字的比较，还可用于其他可以进行大小比较的数据类型</strong></p>
<p><strong>下面是一些特殊情况：</strong></p>
<p><strong>1. 如果被更新的字段不存在</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $min : &#123;</span><br><span class="line">     notExist :10</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"> db.accounts.find(&#123; name : &quot;karen&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;balance&quot; : 6000</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;branch&quot; : &quot;branch1&quot;,</span><br><span class="line">        &quot;notExist&quot; : 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本身不存在的notExist字段被创建出来，而且被设置成10</p>
<p><strong>2. 如果被更新的字段类型和更新值类型不一致</strong></p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $min : &#123;</span><br><span class="line">     &quot;info.balance&quot; : null</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"> db.accounts.find(&#123; name : &quot;karen&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;balance&quot; : null</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;branch&quot; : &quot;branch1&quot;,</span><br><span class="line">        &quot;notExist&quot; : 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>balance竟然被设置成了<code>null</code></p>
</blockquote>
<p><strong>如果被更新的字段类型和更新值类型不一致，$min和$max命令会按照BSON数据类型排序规则进行比较</strong></p>
<p>最小：</p>
<ul>
<li>Null</li>
<li>Numbers(ints,longs,doubles,decimals)</li>
<li>Symbol，String</li>
<li>Object</li>
<li>Array</li>
<li>BinData</li>
<li>ObjectId</li>
<li>Boolean</li>
<li>Date</li>
<li>TimeStamp</li>
</ul>
<p>最大：</p>
<ul>
<li>Regular Expression</li>
</ul>
<h5 id="数组更新操作符"><a href="#数组更新操作符" class="headerlink" title="数组更新操作符"></a>数组更新操作符</h5><ul>
<li><code>$addToSet</code>   向数组中添加元素</li>
<li><code>$pop</code>      从数组中移除元素</li>
<li><code>$pull</code>     从数组中有选择性地移除元素</li>
<li><code>$pullAll</code>   从数组中有选择性地移除元素</li>
<li><code>$push</code>     向数组中添加元素</li>
</ul>
<h6 id="addToSet"><a href="#addToSet" class="headerlink" title="$addToSet"></a><code>$addToSet</code></h6><p>语法：<code>{ $addToSet : { &lt;field1&gt; : &lt;value1&gt; , ... } }</code></p>
<p>例子：</p>
<p>查看karen的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(</span><br><span class="line">  &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">  &#123; name : 1 ,contact : 1 ,_id :0 &#125;</span><br><span class="line">).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>向karen的银行账户文档中添加联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;karen&quot;&#125;,</span><br><span class="line"> &#123;</span><br><span class="line">    $addToSet : &#123;</span><br><span class="line">     contact : &quot;China&quot;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>China在数组中已经存在呢，所以不会被更新。</p>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 0 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(   &#123; name : &quot;karen&quot; &#125;,   &#123; name : 1 ,contact : 1 ,_id :0 &#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                       &quot;22222&quot;,</span><br><span class="line">                       &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                       &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                       &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果要插入的值已经存在数组中，则$addToSet不会再添加重复值</strong></p>
<p><strong>注意，使用$addToSet往原有数组中插入内嵌数组和内嵌文档时，插入值的字段顺序也和已有值重复的时候，才能算作重复值被忽略</strong></p>
<p>例子：</p>
<p>向karen的账户文档中添加新的联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;karen&quot;&#125;,</span><br><span class="line"> &#123;</span><br><span class="line">    $addToSet : &#123;</span><br><span class="line">     contact : &#123;</span><br><span class="line">                 &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                 &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">               &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(   &#123; name : &quot;karen&quot; &#125;,   &#123; name : 1 ,contact : 1 ,_id :0 &#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>向karen的账户文档中添加多个联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;karen&quot;&#125;,</span><br><span class="line"> &#123;</span><br><span class="line">    $addToSet : &#123;</span><br><span class="line">     contact : [ &quot;contact1&quot; , &quot;contact2&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(   &#123; name : &quot;karen&quot; &#125;,   &#123; name : 1 ,contact : 1 ,_id :0 &#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [</span><br><span class="line">                        &quot;contact1&quot;,</span><br><span class="line">                        &quot;contact2&quot;</span><br><span class="line">                ]</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>contact插入了一个内嵌数组。</p>
</blockquote>
<p><strong>如果想要将多个元素直接添加到数组字段中，则需要使用$each操作符</strong></p>
<p>例如：</p>
<p>向karen的账户文档中添加多个联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $addToSet : &#123;</span><br><span class="line">       contact : &#123;</span><br><span class="line">          $each : [ &quot;contact1&quot; ,  &quot;contact2&quot; ]</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<p>我们查看下karen的账户文档。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(   &#123; name : &quot;karen&quot; &#125;,   &#123; name : 1 ,contact : 1 ,_id :0 &#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [</span><br><span class="line">                        &quot;contact1&quot;,</span><br><span class="line">                        &quot;contact2&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;contact1&quot;,</span><br><span class="line">                &quot;contact2&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="pop"><a href="#pop" class="headerlink" title="$pop"></a><code>$pop</code></h6><p>语法：<code>{ $pop : { &lt;field1&gt; : &lt;-1 | 1&gt; , ... } }</code></p>
<p>从数组字段中删除元素</p>
<blockquote>
<p><code>$pop</code>只能删除数组字段中的第一个或者最后一个元素。</p>
</blockquote>
<p>例子： </p>
<p>从karen账户文档中删除最后一个联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $pop : &#123;</span><br><span class="line">      contact : 1 // 1表示最后一个元素</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">&gt; db.accounts.find(   &#123; name : &quot;karen&quot; &#125;,   &#123; name : 1 ,contact : 1 ,_id :0 &#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [</span><br><span class="line">                        &quot;contact1&quot;,</span><br><span class="line">                        &quot;contact2&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>“contact2”已经被删除了</p>
</blockquote>
<p>从karen的账户文档中删除联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $pop : &#123;</span><br><span class="line">      &quot;contact.5&quot;: -1 // -1 表示删除数组中的第一个元素</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">&gt; db.accounts.find(   &#123; name : &quot;karen&quot; &#125;,   &#123; name : 1 ,contact : 1 ,_id :0 &#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [</span><br><span class="line">                        &quot;contact2&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>删除了数组中第五个元素（内嵌数组）的第一个元素</p>
</blockquote>
<p>继续从karen的银行账户删除联系方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $pop : &#123;</span><br><span class="line">      &quot;contact.5&quot;: -1 </span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(   &#123; name : &quot;karen&quot; &#125;,   &#123; name : 1 ,contact : 1 ,_id :0 &#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [ ], // 现在成了一个空数组</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>删除掉数组中最后一个元素后，会留下空数组</strong></p>
<h6 id="pull"><a href="#pull" class="headerlink" title="$pull"></a><code>$pull</code></h6><p><strong>从数组字段中删除特定元素</strong></p>
<p>语法：<code>{ $pull : { &lt;field1&gt; :&lt;value&gt;|&lt;condition&gt; , ...  }}</code></p>
<p><strong>将karen的银行账户文档复制为lawrence的账户文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(</span><br><span class="line"> &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line"> &#123;_id :0&#125;  // 获取karen的银行账户文档（_id不获取）</span><br><span class="line">).forEach( function(doc)&#123;</span><br><span class="line">    var newDoc = doc ;   // 文档复制</span><br><span class="line">    newDoc.name =&quot;lawrence&quot;; // 新文档用户名为lawrence</span><br><span class="line">    db.accounts.insert(newDoc); // 将新文档插入给accounts集合</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>我们把lawrence用户对应的账户文档查出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123; name : &quot;lawrence&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d33d0c6c54bd527b6784a02&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;balance&quot; : null</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;branch&quot; : &quot;branch1&quot;,</span><br><span class="line">        &quot;notExist&quot; : 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例子：</p>
<p>从karen的联系方式中删除包含’hi’的数组元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line"> &#123; $pull : &#123;</span><br><span class="line">    contact : &#123;  $regex : /hi/ &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<p>我们把karen查出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123; name : &quot;karen&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;balance&quot; : null</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;branch&quot; : &quot;branch1&quot;,</span><br><span class="line">        &quot;notExist&quot; : 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们注意到”China”元素被删除了。</p>
<p><strong>如果有数组元素本身就是内嵌数组，我们也可以使用$elemMatch来对这些内嵌数组进行筛选</strong></p>
<p>例如：</p>
<p>从karen的联系方式中删除电话号码22222</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;karen&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $pull : &#123;</span><br><span class="line">    contact : &#123;</span><br><span class="line">      $elemMatch : &#123; $eq : &quot;22222&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find( &#123; name : &quot;karen&quot; &#125;).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;),</span><br><span class="line">        &quot;name&quot; : &quot;karen&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;info&quot; : &#123;</span><br><span class="line">                &quot;dateOpene&quot; : ISODate(&quot;2017-01-01T16:00:00Z&quot;),</span><br><span class="line">                &quot;balance&quot; : null</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;branch&quot; : &quot;branch1&quot;,</span><br><span class="line">        &quot;notExist&quot; : 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>直接将这个内嵌数组给删除了</p>
</blockquote>
<h6 id="pullAll"><a href="#pullAll" class="headerlink" title="$pullAll"></a><code>$pullAll</code></h6><p>从数组字段中删除特定元素</p>
<p>语法：<code>{ $pullAll : { &lt;field1&gt; :[ &lt;value1&gt; ,&lt;value2&gt; , ...] , ...  }}</code></p>
<p>相当于：<code>{ $pull : { &lt;field1&gt; :{ $in :[ &lt;value1&gt; ,&lt;value2&gt;,...] } }}</code></p>
<p><strong>如果要删除的元素是一个内嵌数组，数组元素的值和排列顺序都必须和被删除的数组完全一样。</strong></p>
<p>例子：</p>
<p>查看lawrence的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(</span><br><span class="line"> &#123; name : &quot;lawrence&quot;&#125;,</span><br><span class="line"> &#123; name : 1 , contact : 1 ,_id :0&#125;</span><br><span class="line">).pretty()</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line"> &#123; </span><br><span class="line">   $pullAll : &#123;</span><br><span class="line">       contact : [ [&quot;33333&quot;,&quot;22222&quot;] ]</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>contact数组不存在[“33333”,”22222”]内嵌数组，所以不会删除元素</p>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 0 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line"> &#123; </span><br><span class="line">   $pull : &#123;</span><br><span class="line">       contact: [&quot;22222&quot;] </span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 0 &#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时不会删除任何元素。</p>
</blockquote>
<p><strong>如果要删除的元素是一个文档 …</strong></p>
<ul>
<li><code>$pullAll</code>命令只会删去字段和字段排列顺序都<strong>完全匹配</strong>的内嵌文档元素</li>
<li><code>$pull</code>命令会删除包含指定的文档字段和字段值的文档元素，<strong>字段排列顺序不需要完全匹配</strong>。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $pullAll : &#123;</span><br><span class="line">    contact : [ &#123; &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;&#125;  ]</span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 0 })</p>
</blockquote>
<p>没有匹配，所以不会删除任何数组元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $pullAll : &#123;</span><br><span class="line">    contact : [ &#123; &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,&quot;secondEmail&quot; : &quot;xx@163.com&quot; &#125;  ]</span><br><span class="line">   &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , contact : 1 ,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;,</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>$pullAll</code>只删除了指定的内嵌文档</p>
</blockquote>
<p><strong>$pull命令会删除包含指定的文档字段和字段值的文档元素，字段排列顺序不需要完全匹配</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $pull : &#123; contact : &#123; &quot;primaryEmail&quot; : &quot;xx@qq.com&quot; &#125; &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , contact : 1 ,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将删除的文档元素再添加进contact数组中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123; $addToSet : &#123;</span><br><span class="line">    contact : &#123; &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,&quot;secondEmail&quot; : &quot;xx@163.com&quot; &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>现在的lawrence对应的账户文档如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , contact : 1 ,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;primaryEmail&quot; : &quot;xx@qq.com&quot;,</span><br><span class="line">                        &quot;secondEmail&quot; : &quot;xx@163.com&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们再使用<code>$pull</code>命令来删除数组中的内嵌文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $pull : &#123; contact : &#123; &quot;secondEmail&quot; : &quot;xx@163.com&quot; , &quot;primaryEmail&quot; : &quot;xx@qq.com&quot; &#125; &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
</blockquote>
<p>查出lawrence对应的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , contact : 1 ,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>可以发现内嵌文档已经被删除，$pull使用的筛选条件是乱序的，也是可以删除的。</strong></p>
<h6 id="push"><a href="#push" class="headerlink" title="$push"></a><code>$push</code></h6><p>向数组中添加元素</p>
<p>语法： <code>{ $push : { &lt;field1&gt; : &lt;value1&gt; , ... } }</code></p>
<p><code>$push</code>和<code>$addToSet</code>命令相似，但是<code>$push</code>命令的功能更强大。</p>
<p><strong>和@addToSet命令一样，如果$push命令中指定的数组字段不存在，这个字段会被添加到原文档中。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">  $push : &#123; newArray : &quot;new element&quot; &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , contact : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;new element&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>和$addToSet相似，$push操作符也可以和$each搭配使用</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">  $push : &#123; newArray : &#123;</span><br><span class="line">      $each : [2,3,4]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;new element&quot;,</span><br><span class="line">                2,</span><br><span class="line">                3,</span><br><span class="line">                4</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>将2，3，4作为newArray数组的元素依次添加</p>
</blockquote>
<p><strong>$push和$each操作符还可以和更多的操作符搭配使用，实现比$addToSet更复杂的操作。</strong></p>
<p><strong>使用$position操作符可以将元素插入到数组的指定位置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push : &#123;</span><br><span class="line">       newArray : &#123;</span><br><span class="line">         $each :[&quot;position1&quot;,&quot;position2&quot;],</span><br><span class="line">         $position : 0 // 从头开始插入</span><br><span class="line">       &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , contact : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;new element&quot;,</span><br><span class="line">                2,</span><br><span class="line">                3,</span><br><span class="line">                4</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push : &#123;</span><br><span class="line">       newArray : &#123;</span><br><span class="line">         $each :[&quot;position1&quot;,&quot;position2&quot;],</span><br><span class="line">         $position : -1 // 插入到数组最后一个元素的前面</span><br><span class="line">       &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , contact : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;new element&quot;,</span><br><span class="line">                2,</span><br><span class="line">                3,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                4</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在newArray中<code>$position : -1</code>和<code>$position: 5</code> 对应的位置是相同的。</p>
<p><strong>使用$sort对数组进行排序</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push : &#123;</span><br><span class="line">       newArray : &#123;</span><br><span class="line">         $each :[&quot;sort1&quot;],</span><br><span class="line">         $sort : 1  // 对更新后的数组进行排序， 1： 由小到大的排序</span><br><span class="line">       &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>$sort</code>必须和<code>$each</code>一起使用。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1 , contact : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                2,</span><br><span class="line">                3,</span><br><span class="line">                4,</span><br><span class="line">                &quot;new element&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;sort1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果插入的元素是内嵌文档，也可以根据内嵌文档的字段值排序。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push : &#123;</span><br><span class="line">       newArray : &#123;</span><br><span class="line">         $each :[ &#123; key : &quot;sort&quot; ,value : 100&#125;, &#123; key : &quot;sort&quot; , value : 200&#125;  ],</span><br><span class="line">         $sort : &#123; value : -1 &#125; // 按照value的值对数组从大到小排序 ,如果数组元素并没有value字段，这些数组元素就不参与排序</span><br><span class="line">       &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;key&quot; : &quot;sort&quot;,</span><br><span class="line">                        &quot;value&quot; : 200</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;key&quot; : &quot;sort&quot;,</span><br><span class="line">                        &quot;value&quot; : 100</span><br><span class="line">                &#125;,</span><br><span class="line">                2,</span><br><span class="line">                3,</span><br><span class="line">                4,</span><br><span class="line">                &quot;new element&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;sort1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果不想插入元素，只想对文档中的数组字段进行排序…</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push : &#123;</span><br><span class="line">       newArray : &#123;</span><br><span class="line">         $each :[],</span><br><span class="line">         $sort : -1 </span><br><span class="line">       &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;key&quot; : &quot;sort&quot;,</span><br><span class="line">                        &quot;value&quot; : 200</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;key&quot; : &quot;sort&quot;,</span><br><span class="line">                        &quot;value&quot; : 100</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;sort1&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;new element&quot;,</span><br><span class="line">                4,</span><br><span class="line">                3,</span><br><span class="line">                2</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用$slice来截取部分数组</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push : &#123;</span><br><span class="line">       newArray : &#123;</span><br><span class="line">         $each :[ &quot;slice1&quot;],</span><br><span class="line">         $slice : -8 // 插入元素后，将数组中倒数8个元素保留下来，其他元素删除</span><br><span class="line">       &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;new element&quot;,</span><br><span class="line">                4,</span><br><span class="line">                3,</span><br><span class="line">                2,</span><br><span class="line">                &quot;slice1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>同样地，如果不想插入元素，只想截取文档中的数组字段…</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push : &#123;</span><br><span class="line">       newArray : &#123;</span><br><span class="line">         $each :[],</span><br><span class="line">         $slice : 6  // 将数组中前6个元素保留下来，其他元素删除</span><br><span class="line">       &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;new element&quot;,</span><br><span class="line">                4,</span><br><span class="line">                3</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$sort</code> ,<code>$position</code>和<code>$slice</code>可以一起使用，它们的执行顺序是：</p>
<ol>
<li><p><code>$position</code></p>
</li>
<li><p><code>$sort</code> </p>
</li>
<li><code>$slice</code></li>
</ol>
<p>看一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">  &#123; name : &quot;lawrence&quot; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push : &#123;</span><br><span class="line">       newArray : &#123;</span><br><span class="line">         $each :[ &quot;push1&quot; ,&quot;push2&quot;],</span><br><span class="line">         $position : 2,</span><br><span class="line">         $sort : -1,</span><br><span class="line">         $slice : 5 </span><br><span class="line">       </span><br><span class="line">       &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;push2&quot;,</span><br><span class="line">                &quot;push1&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="更新数组中的特定元素"><a href="#更新数组中的特定元素" class="headerlink" title="更新数组中的特定元素"></a>更新数组中的特定元素</h6><p><strong>$是数组中第一个符合筛选条件的数组元素的占位符，搭配更新操作符使用，可以对满足筛选条件的数组元素进行更新。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line"> &#123; &lt;array&gt; :  &lt;query selector&gt; &#125;,</span><br><span class="line"> &#123; &lt;update selector&gt; : &#123; &quot;array.$&quot; : value &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>我们先把lawrence的银行账户文档查出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;push2&quot;,</span><br><span class="line">                &quot;push1&quot;,</span><br><span class="line">                &quot;position2&quot;,</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line">   &#123; name : &quot;lawrence&quot; ,</span><br><span class="line">     newArray: &quot;position2&quot; // 筛选出newArray数组中匹配&quot;position2&quot;的数组元素</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $set : &#123;</span><br><span class="line">       &quot;newArray.$&quot; : &quot;updated&quot;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>将数组元素更新</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,newArray:1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;newArray&quot; : [</span><br><span class="line">                &quot;push2&quot;,</span><br><span class="line">                &quot;push1&quot;,</span><br><span class="line">                &quot;updated&quot;, // 旧值为position2</span><br><span class="line">                &quot;position1&quot;,</span><br><span class="line">                &quot;position1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="更新数组中的所有元素"><a href="#更新数组中的所有元素" class="headerlink" title="更新数组中的所有元素"></a>更新数组中的所有元素</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;update selector&gt;  : &#123; &quot;&lt;array&gt;.$[]&quot; : value  &#125;   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>$[]代表数组字段中的所有元素</strong></p>
<p><strong>搭配更新操作符，可以对数组中的所有元素进行更新</strong></p>
<p>还是先查出lawrence的银行账户文档:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,contact: 1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;22222&quot;,</span><br><span class="line">                        &quot;33333&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行更新操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;lawrence&quot;&#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $set : &#123;</span><br><span class="line">     &quot;contact.0.$[]&quot; : &quot;88888&quot; // 将contact数组中的第一个元素（内嵌数组）全部更新为&quot;88888&quot;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br><span class="line">&gt; db.accounts.find(  &#123; name : &quot;lawrence&quot;&#125;,  &#123; name : 1  ,contact: 1,_id :0&#125; ).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;name&quot; : &quot;lawrence&quot;,</span><br><span class="line">        &quot;contact&quot; : [</span><br><span class="line">                [</span><br><span class="line">                        &quot;88888&quot;,</span><br><span class="line">                        &quot;88888&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;Beijing&quot;,</span><br><span class="line">                &quot;China&quot;,</span><br><span class="line">                [ ],</span><br><span class="line">                &quot;contact1&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="更新文档选项"><a href="#更新文档选项" class="headerlink" title="更新文档选项"></a>更新文档选项</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.update(&lt;query&gt;,&lt;update&gt;, &lt;options&gt;)</span><br></pre></td></tr></table></figure>
<p><strong><options>文档提供了update命令的更多选项。</options></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; multi : &lt;boolean&gt; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>是否更新多篇文档</p>
</blockquote>
<h5 id="更新多个文档"><a href="#更新多个文档" class="headerlink" title="更新多个文档"></a>更新多个文档</h5><p><strong>目前为止，我们在update命令中使用的筛选条件只对应一篇文档。</strong></p>
<p><strong>在默认情况下，即使筛选条件对应了多篇文档，update命令仍然只会更新一篇文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">   $set : &#123;</span><br><span class="line">     ...</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">     multi : true</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>注意，MongoDB只能保证单个文档操作的原子性，不能保证多个文档操作的原子性。</strong></p>
<p><strong>更新多个文档的操作虽然在单一线程中，但是线程在执行过程中可能被挂起，以便其他线程也有机会对数据进行操作。</strong></p>
<p><strong>如果需要保证多个文档操作时的原子性，就需要使用MongoDB4.0版本引入的事务功能进行操作。</strong></p>
<h5 id="更新或者创建文档"><a href="#更新或者创建文档" class="headerlink" title="更新或者创建文档"></a>更新或者创建文档</h5><p>upset</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; upset : &lt;boolean&gt; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>在默认情况下，如果update命令中的筛选条件没有匹配任何文档，则不会进行任何操作。</strong></p>
<p><strong>将upsert选项设置为true，如果update命令中的筛选条件没有匹配任何文档，则会创建新文档。</strong></p>
<p>查看maggie的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(</span><br><span class="line"> &#123; name : &quot;maggie&quot; &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">  name : 1 ,balance : 1 ,_id:0</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>数据库中不存在该文档，所以查出来为空。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; name : &quot;maggie&quot;&#125;,</span><br><span class="line"> &#123; $set : &#123; balance : 2000&#125; &#125;,</span><br><span class="line"> &#123; upsert : true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这样会创建出一个新的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123;</span><br><span class="line">        &quot;nMatched&quot; : 0,</span><br><span class="line">        &quot;nUpserted&quot; : 1,</span><br><span class="line">        &quot;nModified&quot; : 0,</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;5d3433bab70237ae664b7e5b&quot;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>我们把新文档查出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find( &#123; name : &quot;maggie&quot; &#125; ,&#123; name : 1 ,balance : 1 ,_id:0 &#125;)</span><br><span class="line">&#123; &quot;name&quot; : &quot;maggie&quot;, &quot;balance&quot; : 2000 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>不过，如果无法从筛选条件中推断中确定的字段值，新创建的文档将不会包含筛选条件涉及的字段</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.update(</span><br><span class="line"> &#123; balance : &#123; $gt : 20000 &#125; &#125;,</span><br><span class="line"> &#123; $set : &#123; name : &quot;nick&quot;&#125; &#125;,</span><br><span class="line"> &#123; upsert : true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>我们把新增的文档查出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; name : &quot;nick&quot; &#125;,  &#123;   name : 1 ,balance : 1 ,_id:0  &#125; )</span><br><span class="line">&#123; &quot;name&quot; : &quot;nick&quot; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>balance ： 无法确定值  ,所以balance字段就被去除了。</p>
</blockquote>
<p><strong>另外一个可以更新文档的命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.save(&lt;document&gt;)</span><br></pre></td></tr></table></figure>
<p><strong>如果document文档中包含了_id字段，save()命令会调用db.collection.update()命令(upsert:true)</strong></p>
<p>举例说明：</p>
<p>查看银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(</span><br><span class="line"> &#123;&#125;,</span><br><span class="line"> &#123; name : 1 , _id : 1&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;changge&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1749847d532fca455716f5&quot;), &quot;name&quot; : &quot;ajin&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17664c7d532fca455716f6&quot;), &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f8&quot;), &quot;name&quot; : &quot;axin&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d1767087d532fca455716f9&quot;), &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d17683b7d532fca455716fe&quot;), &quot;name&quot; : &quot;fly&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d2a9adda4078bad80fc7e23&quot;), &quot;name&quot; : &quot;karen&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d32da8f3023d6256879f04f&quot;), &quot;name&quot; : &quot;jack&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d33d0c6c54bd527b6784a02&quot;), &quot;name&quot; : &quot;lawrence&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d3433bab70237ae664b7e5b&quot;), &quot;name&quot; : &quot;maggie&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d3435e8b70237ae664b7e9c&quot;), &quot;name&quot; : &quot;nick&quot; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.save(</span><br><span class="line"> &#123; _id : &quot;accounts1&quot; ,name : &quot;changge&quot; , balance : 100 &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nMatched” : 1, “nUpserted” : 0, “nModified” : 1 })</p>
<p>更新原有文档</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;accounts1&quot;, &quot;name&quot; : &quot;changge&quot;, &quot;balance&quot; : 100 &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.save(</span><br><span class="line"> &#123; _id : &quot;accounts2&quot; ,name : &quot;oliver&quot; , balance : 200 &#125;</span><br><span class="line">)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 0, &quot;nUpserted&quot; : 1, &quot;nModified&quot; : 0, &quot;_id&quot; : &quot;accounts2&quot; &#125;)</span><br><span class="line"></span><br><span class="line">&#123; &quot;_id&quot; : &quot;accounts2&quot;, &quot;name&quot; : &quot;oliver&quot;, &quot;balance&quot; : 200 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>因_id对应的文档不存在，所以是新增了一篇文档。</p>
</blockquote>
<h2 id="文档删除"><a href="#文档删除" class="headerlink" title="文档删除"></a>文档删除</h2><ul>
<li>删除集合</li>
<li>删除特定文档</li>
<li><code>db.collection.remove()</code></li>
</ul>
<h3 id="删除集合的文档"><a href="#删除集合的文档" class="headerlink" title="删除集合的文档"></a>删除集合的文档</h3><p>语法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.remove(&lt;query&gt;,&lt;options&gt;)</span><br></pre></td></tr></table></figure>
<ul>
<li><query>  删除操作时筛选文档的条件</query></li>
<li><options>  声明了一些删除操作的参数</options></li>
</ul>
<p>例子：</p>
<p>查看银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.find(</span><br><span class="line"> &#123; &#125;,</span><br><span class="line"> &#123; name : 1 , balance : 1 , _id :0 &#125;</span><br><span class="line">).sort( &#123; balance : 1 &#125; )</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;lawrence&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;nick&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 25 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;changge&quot;, &quot;balance&quot; : 100 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;oliver&quot;, &quot;balance&quot; : 200 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;fly&quot;, &quot;balance&quot; : 600 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 800 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;maggie&quot;, &quot;balance&quot; : 2000 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;balance&quot; : 3000 &#125;</span><br></pre></td></tr></table></figure>
<p>删除余额为600的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.remove( &#123; balance : 600 &#125; )</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nRemoved” : 3 })</p>
</blockquote>
<p>删除了三篇文档</p>
<p><strong>在默认情况下，remove命令会删除所有符合筛选条件的文档。</strong></p>
<p><strong>如果只想删除满足筛选条件的第一篇文档，可以使用justOne选项。</strong></p>
<p>删除一篇小于200的银行账户文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.remove(</span><br><span class="line"> &#123; balance : &#123; $lt : 200&#125; &#125;,</span><br><span class="line"> &#123; justOne : true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nRemoved” : 1 })</p>
</blockquote>
<p>我们把全部文档查出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.find(  &#123; &#125;,  &#123; name : 1 , balance : 1 , _id :0 &#125; ).sort( &#123; balance : 1 &#125; )</span><br><span class="line">&#123; &quot;name&quot; : &quot;karen&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;lawrence&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;nick&quot; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;ajin&quot;, &quot;balance&quot; : 25 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;oliver&quot;, &quot;balance&quot; : 200 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;axin&quot;, &quot;balance&quot; : 800 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;maggie&quot;, &quot;balance&quot; : 2000 &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;jack&quot;, &quot;balance&quot; : 3000 &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时删除了余额为100的银行账户文档，留下了余额为25的银行账户文档。</p>
</blockquote>
<p><strong>删除集合内所有文档</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.remove(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WriteResult({ “nRemoved” : 8 })</p>
</blockquote>
<p>accounts文档成了空文档。</p>
<h3 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.collection.drop()</span><br><span class="line">db.&lt;collection&gt;.drop( &#123; writeConcern : &lt;document&gt; &#125; )</span><br></pre></td></tr></table></figure>
<p><strong>writeConcern文档定义了集合本次删除操作的安全写级别</strong></p>
<p>学习中暂时使用MongDB默认的安全写级别。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show collections</span><br></pre></td></tr></table></figure>
<blockquote>
<p>accounts // 空集合，不包含任何元素，但是客观存在着 user</p>
</blockquote>
<p><strong>drop命令可以删除整个集合，包括集合内的所有文档，以及集合的索引。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.accounts.drop()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>true // 删除成功</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show collections</span><br></pre></td></tr></table></figure>
<blockquote>
<p>user </p>
</blockquote>
<p>accounts集合已经被删除</p>
<p><strong>如果集合中的文档数量很多，使用remove命令删除所有集合的效率不高。</strong></p>
<p><strong>这种情况下，更加有效率的方法，是使用drop命令删除集合，然后再创建空集合并创建索引。</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/07/14/Spring-Cloud微服务实战笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/14/Spring-Cloud微服务实战笔记/" itemprop="url">Spring Cloud微服务实战笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-14T21:04:26+08:00">
                2019-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="微服务简介"><a href="#微服务简介" class="headerlink" title="微服务简介"></a>微服务简介</h4><blockquote>
<p>微服务是一种架构风格</p>
</blockquote>
<ul>
<li>一系列微小的服务组成</li>
<li>跑在自己单独的进程中</li>
<li>每个服务为独立的<strong>业务</strong>开发</li>
<li>独立部署</li>
<li>分布式的管理</li>
</ul>
<blockquote>
<p>为什么会提出微服务？</p>
</blockquote>
<h5 id="点餐系统设计的架构形态："><a href="#点餐系统设计的架构形态：" class="headerlink" title="点餐系统设计的架构形态："></a>点餐系统设计的架构形态：</h5><ul>
<li><p>单体架构</p>
<blockquote>
<ul>
<li><p>容易测试</p>
</li>
<li><p>容易部署（打包在一个war包中即可）</p>
</li>
<li><p>开发效率低</p>
</li>
<li><p>代码维护难</p>
</li>
<li><p>部署不灵活（构建时间比较长）</p>
</li>
<li><p>稳定性不高</p>
<blockquote>
<p>牵一发动全身，一个代码的问题，可以影响整个系统的运行</p>
</blockquote>
</li>
<li><p>扩展性不够</p>
</li>
</ul>
<p>满足不了高并发的场景</p>
</blockquote>
</li>
<li><p>基于Ajax的前后端分离架构</p>
</li>
<li><p>分布式（水平扩展&amp;&amp;服务拆分）</p>
<ul>
<li>微服务必然是分布式的</li>
<li>分布式系统是多节点</li>
<li>进程间通信</li>
</ul>
</li>
</ul>
<h5 id="微服务架构的基础框架-组件"><a href="#微服务架构的基础框架-组件" class="headerlink" title="微服务架构的基础框架/组件"></a>微服务架构的基础框架/组件</h5><ul>
<li><p>服务注册与发现</p>
</li>
<li><p><strong>服务网关 Service Gateway</strong></p>
<blockquote>
<p>对外屏蔽后端服务的细节，供前端通过路由访问后端服务的接口</p>
<p>限流，监控日志，用户认证与授权，爬虫</p>
</blockquote>
</li>
<li><p>后端通用服务（也称为中间层服务，Middle Tier Service)</p>
<blockquote>
<p>后端服务启动后会将服务注册到服务注册中心中</p>
</blockquote>
</li>
<li><p>前端服务（也称边缘服务，Edge Service)</p>
<blockquote>
<p>前端服务通过查询注册中心的服务注册表信息查询后端服务信息，并发起请求；</p>
<p>对后端服务进行<strong>裁剪</strong>和<strong>聚合</strong>以后暴露后给不同平台访问</p>
</blockquote>
</li>
</ul>
<h5 id="Spring-Cloud简介"><a href="#Spring-Cloud简介" class="headerlink" title="Spring Cloud简介"></a>Spring Cloud简介</h5><ul>
<li>Spring Cloud不是重复造轮子，其实Spring也不是重复造轮子。</li>
<li>Spring Cloud是一个开发工具集，包含多个子项目<ul>
<li>利用Spring Boot的开发便利</li>
<li>主要是对基于Neiflix公司的开源组件的进一步封装</li>
</ul>
</li>
<li>Spring Cloud简化了<strong>分布式开发</strong></li>
</ul>
<blockquote>
<p>掌握如何使用，更要理解分布式、架构的特点</p>
<p>不但要会使用，还要懂其中的原理，为什么这么使用，这么使用的优缺点？</p>
</blockquote>
<h4 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h4><h5 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a>Eureka Server</h5><h6 id="搭建EurekaServer"><a href="#搭建EurekaServer" class="headerlink" title="搭建EurekaServer"></a>搭建EurekaServer</h6><ol>
<li><p>引入pom.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>搭建注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@EnableEurekaServer</code>的作用其实就是激活Eureka Server的自动配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(EurekaServerMarkerConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableEurekaServer &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerMarkerConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Marker <span class="title">eurekaServerMarkerBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Marker();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Marker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看<code>EurekaServerMarkerConfiguration</code>,它知识new了一个Marker对象，而Marker对象是为了实现Eureka Server的自动配置，看完下面的代码你就明白了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(EurekaServerInitializerConfiguration.class)</span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(EurekaServerMarkerConfiguration.Marker.class)<span class="comment">//Marker</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(&#123; EurekaDashboardProperties.class,</span><br><span class="line">		InstanceRegistryProperties.class &#125;)</span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:/eureka/server.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerAutoConfiguration</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>这个就是<code>@ConditionalOnBean(EurekaServerMarkerConfiguration.Marker.class)</code>这个条件注解，配合<code>EurekaServerAutoConfiguration</code>这个Eureka Server的配置类来实现Eureka Server的自动化配置</p>
</li>
<li><p>配置Eureka Server（单节点）</p>
<p><code>applicaion.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## 单节点情况下，Eureka Server不用自己注册到自己</span><br><span class="line">eureka.client.register-with-eureka=false</span><br><span class="line">## 关闭Eureka Server的自我保护机制（该配置只有在开发环境中才可以打开）</span><br><span class="line">eureka.server.enable-self-preservation=false</span><br></pre></td></tr></table></figure>
<p>加上此配置项后，我们启动Eureka Server发现控制台如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> main] com.netflix.discovery.DiscoveryClient    : Disable delta property : false</span><br><span class="line">2019-05-25 16:13:13.660  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Single vip registry refresh property : null</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Force full registry fetch : false</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Application is null : false</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Registered Applications size is zero : true</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Application version is -1: true</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Getting all instance registry info from the eureka server</span><br></pre></td></tr></table></figure>
<blockquote>
<p>该注册中心还没有服务实例注册进来，说明我们刚刚的配置是生效的</p>
</blockquote>
</li>
</ol>
<blockquote>
<p>总结：Eureka Server本身就是一个注册中心，不涉及业务，所以本身的搭建还是比较简单的。</p>
</blockquote>
<h5 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="Eureka Client"></a>Eureka Client</h5><p>Eureka Client需要将自己注册到服务注册中心，这就是<strong>服务注册</strong>。</p>
<h6 id="搭建Eureka-Client"><a href="#搭建Eureka-Client" class="headerlink" title="搭建Eureka Client"></a>搭建Eureka Client</h6><ol>
<li><p>引入pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看注解<code>EnableDiscoveryClient</code>的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(EnableDiscoveryClientImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDiscoveryClient &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * If true, the ServiceRegistry will automatically register the local server.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">autoRegister</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EnableDiscoveryClientImportSelector</code>点进去：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(Ordered.LOWEST_PRECEDENCE - <span class="number">100</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableDiscoveryClientImportSelector</span></span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">SpringFactoryImportSelector</span>&lt;<span class="title">EnableDiscoveryClient</span>&gt; </span>&#123;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不用看下面了，我们直接就知道这个借助了工具类<code>SpringFactoriesLoader</code>去项目所有jar包下面去找<code>spring.factories</code>中如下的配置：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.cloud.client.discovery.EnableDiscoveryClient=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration</span><br></pre></td></tr></table></figure>
<p><code>EurekaDiscoveryClientConfiguration</code>就被我们找到了，我们留意一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(EurekaClientConfig.class)</span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"eureka.client.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaDiscoveryClientConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Marker</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Marker <span class="title">eurekaDiscoverClientMarker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Marker();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>又出现了Marker()，我们很习惯了，这是个标记，没有实际意义，一个辅助的Bean而已。</p>
</blockquote>
<p>我们按alt+F7</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(EurekaClientConfig.class)</span><br><span class="line"><span class="meta">@Import</span>(DiscoveryClientOptionalArgsConfiguration.class)</span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(EurekaDiscoveryClientConfiguration.Marker.class) <span class="comment">//</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"eureka.client.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(&#123; NoopDiscoveryClientAutoConfiguration.class,</span><br><span class="line">		CommonsClientAutoConfiguration.class, ServiceRegistryAutoConfiguration.class &#125;)</span><br><span class="line"><span class="meta">@AutoConfigureAfter</span>(name = <span class="string">"org.springframework.cloud.autoconfigure.RefreshAutoConfiguration"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClientAutoConfiguration</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p><code>@ConditionalOnBean(EurekaDiscoveryClientConfiguration.Marker.class)</code>,</p>
<p>原来千呼万唤使出来，这个<code>Marker</code>只为了召唤出<code>EurekaClientAutoConfiguration</code>自动配置类。</p>
</li>
</ol>
<p>   到这里整个<code>EnableDiscoveyClient</code>注解的意义就很清晰了。（这个注解是Spring Cloud的common包提供的，并不是netflix的）</p>
<ol start="3">
<li><p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">## 注册中心的地址（单节点）</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:8761/eureka/</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Eureka-Server的高可用"><a href="#Eureka-Server的高可用" class="headerlink" title="Eureka Server的高可用"></a>Eureka Server的高可用</h5><p>   单节点的Eureka Server太容易挂掉了，所以我们要部署多台Eureka Server，并且Eureka Server之间要互相注册，这样每个Eureka Server都能获取到注册表的信息。</p>
<p>假设在高可用场景下，其中一台Eureka Server宕机了，会出现怎样的情况？</p>
<blockquote>
<p>另一台eureka Server仍然会维护者注册表信息。</p>
</blockquote>
<h5 id="服务发现的两种方式"><a href="#服务发现的两种方式" class="headerlink" title="服务发现的两种方式"></a>服务发现的两种方式</h5><h6 id="客户端发现"><a href="#客户端发现" class="headerlink" title="客户端发现"></a>客户端发现</h6><ul>
<li>Eureka</li>
</ul>
<p>如果别人的服务不是采用Java语言开发，那还能注册到服务注册中心吗？</p>
<blockquote>
<p>微服务的特点：<strong>异构</strong></p>
<ul>
<li>不同语言</li>
<li>不同类型的数据库</li>
</ul>
</blockquote>
<p>其他语言的服务如何从服务注册中心获取其他服务，并进行调用呢？</p>
<blockquote>
<p>Spring Cloud可以实现其他语言纳入自己的服务治理体系。</p>
</blockquote>
<h6 id="服务端发现"><a href="#服务端发现" class="headerlink" title="服务端发现"></a>服务端发现</h6><p>代理介入</p>
<ul>
<li>Nginx</li>
<li>Zookeeper</li>
<li>Kubernates</li>
</ul>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ul>
<li><p>Eureka Client会定期和Eureka Server维持一个心跳，如果超过某个时间，Eureka Server还是没收到Eureka Client发送的心跳，那么Eureka Server就会把该服务实例从注册表中剔除掉</p>
</li>
<li><p>Eureka Client也会定期去Eureka Server那拉取服务实例的注册表信息，这个时间可以设置</p>
<blockquote>
<p>Eureka Server中在内存中维护的注册表，有三层Map，可以很好的满足Eureka Client对注册表信息的拉取与修改（比如突然新增加了一台服务实例），三层Map很好的满足了多个Eureka Client的高并发访问场景</p>
</blockquote>
</li>
<li><p>我们服务注册中心高可用的场景，Eureka Client设置好多个注册中心的地址即可</p>
</li>
<li><p>我觉得Eureka Server是为了维护分布式系统中的高可用而牺牲了一致性，这个有点过度极端设计的嫌疑</p>
</li>
</ul>
<blockquote>
<p>Eureka 具有心跳检查，健康检查，负载均衡等功能。</p>
<p>Eureka的高可用，生产环境要部署多台Eureka Server。</p>
</blockquote>
<p><strong>在分布式系统中，服务注册中心是最重要的基础部分。</strong></p>
<p>why？</p>
<p>分布式系统中为什么需要服务发现？</p>
<blockquote>
<p>注册中心维护多个服务的实例，就像是一个字典，一个服务要想调用其他服务，就直接从注册中心获取服务就可以了，这个就是服务发现。因为分布式系统中，服务实例有无数多个，并且服务实例也是动态变化的，所以需要依赖注册中心来维护这些变化的无数个服务实例。</p>
</blockquote>
<p><strong>注册中心是服务之间产生各种各样关系的桥梁。</strong></p>
<blockquote>
<p>微服务的落地，不是有什么固定套路，要具体问题具体分析，重要的是微服务的原理，而不是采用何种语言，何种固定套路。</p>
</blockquote>
<h4 id="服务拆分"><a href="#服务拆分" class="headerlink" title="服务拆分"></a>服务拆分</h4><h5 id="如何拆分？"><a href="#如何拆分？" class="headerlink" title="如何拆分？"></a>如何拆分？</h5><ul>
<li><p>先明白起点和终点</p>
</li>
<li><p><strong>需要考虑的因素与坚持的原则</strong></p>
</li>
</ul>
<h5 id="微服务拆分的起点"><a href="#微服务拆分的起点" class="headerlink" title="微服务拆分的起点"></a>微服务拆分的起点</h5><ul>
<li>既有架构的形态</li>
</ul>
<h5 id="微服务拆分的终点"><a href="#微服务拆分的终点" class="headerlink" title="微服务拆分的终点"></a>微服务拆分的终点</h5><ul>
<li><p>好的架构不是设计出来的，而是进化而来的</p>
<blockquote>
<p>进化是演进的意思，ing</p>
</blockquote>
<p>我们的系统适合做微服务架构吗？</p>
</li>
</ul>
<p>  <strong>业务形态不适合微服务的</strong>：</p>
<ul>
<li><p>系统中包含很多强事务场景</p>
<blockquote>
<p>微服务不适合做分布式事务</p>
</blockquote>
</li>
<li><p>业务相对稳定，迭代周期长，没必要切换成微服务</p>
</li>
<li><p>访问压力不大，可用性要求也不高</p>
<blockquote>
<p>企业内部使用的OA系统，访问认识很低，没必要拆分成微服务</p>
</blockquote>
<blockquote>
<p>总结：微服务不是放之四海而皆准的！</p>
</blockquote>
</li>
</ul>
<h5 id="康威定律和微服务"><a href="#康威定律和微服务" class="headerlink" title="康威定律和微服务"></a>康威定律和微服务</h5><blockquote>
<p>任何组织在设计一套系统（广义概念上的系统）时，所交付的设计方案，在结构上都该与该组织的沟通结构保持一致。</p>
</blockquote>
<h5 id="点餐业务服务拆分"><a href="#点餐业务服务拆分" class="headerlink" title="点餐业务服务拆分"></a>点餐业务服务拆分</h5><h6 id="如何拆功能？"><a href="#如何拆功能？" class="headerlink" title="如何拆功能？"></a>如何拆功能？</h6><ul>
<li><p>单一职责，松耦合，高内聚</p>
<blockquote>
<p>降低服务之间的耦合</p>
</blockquote>
</li>
<li><p>关注点分离</p>
<ul>
<li><p>按职责</p>
</li>
<li><p>按通用性</p>
<blockquote>
<p>消息服务，用户服务。。。</p>
<p>把公共组件拆分成服务</p>
</blockquote>
</li>
<li><p>按粒度级别</p>
<blockquote>
<p>微服务不是越小越好；</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h6 id="服务和数据之间的关系"><a href="#服务和数据之间的关系" class="headerlink" title="服务和数据之间的关系"></a>服务和数据之间的关系</h6><ul>
<li>先考虑拆分业务功能，再考虑拆分数据</li>
<li>无状态服务</li>
</ul>
<h6 id="服务拆分的方法论"><a href="#服务拆分的方法论" class="headerlink" title="服务拆分的方法论"></a>服务拆分的方法论</h6><p><strong>1. 如何拆数据</strong></p>
<ul>
<li>每个微服务都有单独的数据存储，并且对其他服务要屏蔽自己的数据库</li>
<li>依据服务特点选择不同结构的数据库类型</li>
<li>难点在于确定边界</li>
</ul>
<p><strong>2. 针对边界设计API</strong></p>
<p><strong>3. 依据边界权衡数据冗余</strong></p>
<h4 id="应用通信"><a href="#应用通信" class="headerlink" title="应用通信"></a>应用通信</h4><p>Spring Cloud中服务间两种restful调用方式：</p>
<ul>
<li><code>RestTemplate</code></li>
<li><code>Feign</code></li>
</ul>
<p>Ribbon的原理</p>
<ol>
<li>获取服务列表<code>ServerList</code></li>
<li>通过<code>ServerListFilter</code>过滤掉一些服务</li>
<li>根据<code>IRule</code>规则选择一台服务实例</li>
<li>发起调用</li>
</ol>
<h4 id="统一配置中心"><a href="#统一配置中心" class="headerlink" title="统一配置中心"></a>统一配置中心</h4><p>为什么需要统一配置中心？</p>
<ul>
<li><p>不方便维护</p>
</li>
<li><p>配置内容安全与权限</p>
<blockquote>
<p>配置内容不能泄漏出去</p>
</blockquote>
</li>
<li><p>更新配置项目需重启</p>
<blockquote>
<p>统一配置中心支持动态刷新配置，无需重启当前项目</p>
</blockquote>
</li>
</ul>
<p><img src="https://liutianruo-2019-go-go-go.oss-cn-shanghai.aliyuncs.com/images/Spring Cloud配置中心简图.jpg" alt=""></p>
<h5 id="搭建Config-Server"><a href="#搭建Config-Server" class="headerlink" title="搭建Config Server"></a>搭建Config Server</h5><h6 id="引入pom"><a href="#引入pom" class="headerlink" title="引入pom"></a>引入pom</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="添加注解"><a href="#添加注解" class="headerlink" title="添加注解"></a>添加注解</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span> <span class="comment">// 声明Config Server</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="设置远程仓库"><a href="#设置远程仓库" class="headerlink" title="设置远程仓库"></a>设置远程仓库</h6><p>在<code>github</code>中新建一个仓库，新建一份配置文件，如<code>order.properties</code></p>
<h6 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">## 应用名称</span><br><span class="line">spring.application.name=config-server</span><br><span class="line"></span><br><span class="line">## 服务端口</span><br><span class="line">server.port=10000</span><br><span class="line"></span><br><span class="line">## 注册到注册中心</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:8761/eureka/</span><br><span class="line"></span><br><span class="line">## 配置远程仓库的地址（私有仓库，保证安全性）</span><br><span class="line">spring.cloud.config.server.git.uri=https://github.com/tianruoliu/config-server-git.git</span><br><span class="line">spring.cloud.config.server.git.username=********</span><br><span class="line">spring.cloud.config.server.git.password=*******</span><br><span class="line"></span><br><span class="line">## 本地路径</span><br><span class="line">spring.cloud.config.server.git.basedir=F:\\imooc_workspace_springcloud\\SpringCloud_Sell\\config-basedir</span><br></pre></td></tr></table></figure>
<p>如何获取Git仓库中的配置文件</p>
<blockquote>
<p>访问<code>http://localhost:10000/order-a.properties</code></p>
<p>或者 <code>http://localhost:10000/master/order-a.properties</code></p>
<p>这两种方式，根据公司需要选择</p>
</blockquote>
<p><strong>注意</strong></p>
<p>配置中心的高可用：即启动多实例运行。</p>
<h5 id="搭建Config-Client"><a href="#搭建Config-Client" class="headerlink" title="搭建Config Client"></a>搭建Config Client</h5><h6 id="引入pom-1"><a href="#引入pom-1" class="headerlink" title="引入pom"></a>引入pom</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h6><p>新建<code>bootstrap.properties</code></p>
<p>添加如下配置项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">### 应用名称</span><br><span class="line">spring.application.name=order</span><br><span class="line"></span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:8761/eureka/</span><br><span class="line"></span><br><span class="line">## 发现Config Server</span><br><span class="line">spring.cloud.config.discovery.enabled=true</span><br><span class="line">spring.cloud.config.discovery.service-id=config-server</span><br><span class="line">spring.cloud.config.profile=dev</span><br><span class="line">spring.cloud.config.label=master</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Config Client找到config-server的配置服务器，根据自己的应用名称<code>order</code>和环境<code>dev</code>等参数，获取配置文件<code>order-dev.properties</code>中的配置信息</p>
</blockquote>
<h5 id="自动刷新配置"><a href="#自动刷新配置" class="headerlink" title="自动刷新配置"></a>自动刷新配置</h5><p>我们引入配置中心，就是为了使得应用的配置可以动态刷新，而不用重启就能更新配置。</p>
<p>我们可以借助<code>Spring Cloud Bus</code>刷新配置。</p>
<h4 id="消息和异步"><a href="#消息和异步" class="headerlink" title="消息和异步"></a>消息和异步</h4><p>MQ使用场景:</p>
<ul>
<li><p>异步处理：用户注册之后，需要发送短信，让用户领取积分，完全可以异步处理</p>
</li>
<li><p>流量削峰：适用于秒杀场景和用户访问量高峰期（ 限制流量）</p>
<blockquote>
<p>秒杀场景，可以在秒杀系统前端加入消息队列，限制流量，提高秒杀系统的可用性</p>
</blockquote>
</li>
<li><p>日志处理</p>
<p>Kafka接收海量日志数据，并转发</p>
</li>
<li><p>和应用解耦</p>
</li>
</ul>
<blockquote>
<p>RabbitMQ还有很多高级特性,延时队列等</p>
</blockquote>
<h5 id="RabbitMQ基本使用"><a href="#RabbitMQ基本使用" class="headerlink" title="RabbitMQ基本使用"></a>RabbitMQ基本使用</h5><h6 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- RabbitMQ --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## RabbitMQ配置</span><br><span class="line">spring.rabbitmq.host=localhost</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.username=guest</span><br><span class="line">spring.rabbitmq.password=guest</span><br></pre></td></tr></table></figure>
<h6 id="消息接收"><a href="#消息接收" class="headerlink" title="消息接收"></a>消息接收</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数码供应商服务 接收消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">        exchange = <span class="meta">@Exchange</span>(<span class="string">"myOrder"</span>), <span class="comment">// 交换机</span></span><br><span class="line">        key = <span class="string">"computer"</span>,              <span class="comment">// 路由键</span></span><br><span class="line">        value = <span class="meta">@Queue</span>(<span class="string">"compute-Order"</span>) <span class="comment">// 队列</span></span><br><span class="line"></span><br><span class="line">))</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processComputer</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">"Computer MqReceiever ：&#123;&#125;"</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 水果供应商服务 接收消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">        exchange = <span class="meta">@Exchange</span>(<span class="string">"myOrder"</span>), <span class="comment">// 交换机</span></span><br><span class="line">        key = <span class="string">"fruit"</span>,              <span class="comment">// 路由键</span></span><br><span class="line">        value = <span class="meta">@Queue</span>(<span class="string">"fruit-Order"</span>) <span class="comment">// 队列</span></span><br><span class="line"></span><br><span class="line">))</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processFruit</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">"Fruit MqReceiever ：&#123;&#125;"</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> AmqpTemplate amqpTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 发送消息给数码提供商</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       amqpTemplate.convertAndSend(<span class="string">"myOrder"</span>,<span class="string">"computer"</span>, <span class="string">"数码供应商 now: "</span> + <span class="keyword">new</span> Date());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>##### </p>
<h5 id="Spring-Cloud-Stream"><a href="#Spring-Cloud-Stream" class="headerlink" title="Spring Cloud Stream"></a>Spring Cloud Stream</h5><p>这是另一种使用消息队列的方式</p>
<h6 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Cloud Stream --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="配置RabbitMQ"><a href="#配置RabbitMQ" class="headerlink" title="配置RabbitMQ"></a>配置RabbitMQ</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">## RabbitMQ配置</span><br><span class="line">spring.rabbitmq.host=localhost</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.username=guest</span><br><span class="line">spring.rabbitmq.password=guest</span><br><span class="line"></span><br><span class="line"># 解决自己给自己发消息时的同名问题</span><br><span class="line">spring.cloud.stream.bindings.example-topic-input.destination=aaa-topic</span><br><span class="line">spring.cloud.stream.bindings.example-topic-output.destination=aaa-topic</span><br><span class="line"></span><br><span class="line"># 分组,确保多实例情况下只有一个实例消费消息</span><br><span class="line">spring.cloud.stream.bindings.example-topic-input.group=order</span><br><span class="line">spring.cloud.stream.bindings.example-topic-output.group=order</span><br></pre></td></tr></table></figure>
<h6 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StreamClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String OUTPUT = <span class="string">"example-topic-output"</span>;</span><br><span class="line">    String INPUT = <span class="string">"example-topic-input"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Input</span>(INPUT)</span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Output</span>(OUTPUT)</span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Stream接收消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ajin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding</span>(StreamClient.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamReceiever</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener</span>(value = StreamClient.INPUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"Stream Receiever:&#123;&#125;"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StreamClient streamClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/sendMessage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String message = <span class="string">"currentTime is"</span> + <span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">        streamClient.output().send(MessageBuilder.withPayload(message).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="服务网关和Zuul"><a href="#服务网关和Zuul" class="headerlink" title="服务网关和Zuul"></a>服务网关和Zuul</h4><p>客户端访问后端服务，需要网关作为客户端请求的统一入口</p>
<h5 id="服务网关的要素"><a href="#服务网关的要素" class="headerlink" title="服务网关的要素"></a>服务网关的要素</h5><ol>
<li>稳定性和高可用  7*24</li>
<li>性能和并发性 网关并发访问压力大</li>
<li>安全性</li>
<li>扩展性</li>
</ol>
<blockquote>
<p>处理非业务逻辑</p>
</blockquote>
<p>Zuul在并发和性能方面相较于Nginx来说，有些欠缺。</p>
<h5 id="Zuul的特点"><a href="#Zuul的特点" class="headerlink" title="Zuul的特点"></a>Zuul的特点</h5><ul>
<li>路由+过滤器=Zuul</li>
<li>核心就是一系列的过滤器</li>
</ul>
<h5 id="Zuul-的四种过滤器API"><a href="#Zuul-的四种过滤器API" class="headerlink" title="Zuul 的四种过滤器API"></a>Zuul 的四种过滤器API</h5><ul>
<li><p>前置（Pre）</p>
<blockquote>
<ul>
<li>参数校验</li>
<li>限流，流量过大的情况下，根据某种规则拦截请求，不再处理后续请求</li>
<li>鉴权</li>
</ul>
</blockquote>
</li>
<li><p>后置（Post）</p>
<blockquote>
<ul>
<li>统计</li>
<li>日志</li>
</ul>
</blockquote>
</li>
<li><p>路由（Route）</p>
<blockquote>
<p>路由转发</p>
</blockquote>
</li>
<li><p>错误（Error）</p>
</li>
</ul>
<blockquote>
<p>此时去路由配置服务器的url请求时，报超时的异常，其实就是将请求路由后到返回响应时的时间超过了阈值。</p>
</blockquote>
<h5 id="通过Zuul不过滤Cookie"><a href="#通过Zuul不过滤Cookie" class="headerlink" title="通过Zuul不过滤Cookie"></a>通过Zuul不过滤Cookie</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">## 1. 访问的url</span><br><span class="line">zuul.routes.myProduct.path=/myProduct/** </span><br><span class="line">## 2.  对此url如何路由，路由到哪个服务</span><br><span class="line">zuul.routes.myProduct.service-id=product</span><br><span class="line">## 设置不过滤Cookie</span><br><span class="line">zuul.routes.myProduct.sensitive-headers=</span><br></pre></td></tr></table></figure>
<h5 id="Zuul的动态路由"><a href="#Zuul的动态路由" class="headerlink" title="Zuul的动态路由"></a>Zuul的动态路由</h5><p>就是改了配置，不用重启Zuul程序，即可实现路由</p>
<blockquote>
<p>通过配置中心即可实现</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现Zuul配置的动态注入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(<span class="string">"zuul"</span>)</span><br><span class="line">    <span class="meta">@RefreshScope</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ZuulProperties <span class="title">zuulProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ZuulProperties();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Zuul的高可用"><a href="#Zuul的高可用" class="headerlink" title="Zuul的高可用"></a>Zuul的高可用</h5><ul>
<li><p>多个节点注册到Eureka Server</p>
</li>
<li><p>Nginx和Zuul混合使用</p>
<blockquote>
<p>Nginx通过负载均衡转发请求，转发到不同的Zuul实例上，缓解单台Zuul服务的压力，提高Zuul的可用性。</p>
</blockquote>
</li>
</ul>
<h5 id="Zuul综合使用"><a href="#Zuul综合使用" class="headerlink" title="Zuul综合使用"></a>Zuul综合使用</h5><h6 id="Pre过滤器"><a href="#Pre过滤器" class="headerlink" title="Pre过滤器"></a>Pre过滤器</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line"> * 前置过滤器，对Token进行校验</span><br><span class="line"> *</span><br><span class="line"> * <span class="meta">@author</span> ajin</span><br><span class="line"> */</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义过滤器的类型：前置过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterConstants.PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置过滤器的优先级，优先级越小，越先执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterConstants.PRE_DECORATION_FILTER_ORDER - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置需要过滤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取请求的上下文</span></span><br><span class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="comment">// 获取当前请求</span></span><br><span class="line">        HttpServletRequest request = requestContext.getRequest();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从url中获取参数，也可以从Cookie，Header中获取</span></span><br><span class="line">        String token = request.getParameter(<span class="string">"token"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="comment">// 不通过</span></span><br><span class="line">            requestContext.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 设置Http状态码</span></span><br><span class="line">            requestContext.setResponseStatusCode(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Post过滤器"><a href="#Post过滤器" class="headerlink" title="Post过滤器"></a>Post过滤器</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Post过滤器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ajin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddResponseHeaderFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterConstants.POST_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterConstants.SEND_RESPONSE_FILTER_ORDER - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line"></span><br><span class="line">        HttpServletResponse response = requestContext.getResponse();</span><br><span class="line"></span><br><span class="line">        response.setHeader(<span class="string">"haha"</span>, UUID.randomUUID().toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">浏览器显示结果：</span><br><span class="line">Response Headers </span><br><span class="line"></span><br><span class="line">Content-Type:application/json;charset=UTF-<span class="number">8</span></span><br><span class="line">    </span><br><span class="line">Date:Fri,<span class="number">31</span> May <span class="number">2019</span> <span class="number">07</span>:<span class="number">00</span>:<span class="number">29</span> GMT </span><br><span class="line"></span><br><span class="line">haha:<span class="number">778</span>c9501-d6c3-<span class="number">4</span>bca-<span class="number">8316</span>-<span class="number">6</span>b085ece9564</span><br><span class="line"></span><br><span class="line">Transfer-Encoding:chunked</span><br></pre></td></tr></table></figure>
<h6 id="Zuul限流"><a href="#Zuul限流" class="headerlink" title="Zuul限流"></a>Zuul限流</h6><p>比如我们的短信API，不能被恶意调用无数次，要做好限流保证API的稳定性。</p>
<blockquote>
<p>在请求被转发之前调用</p>
</blockquote>
<p>限流应该早于鉴权，采用前置过滤器实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 限流拦截器</span></span><br><span class="line"><span class="comment"> * 采用令牌桶算法(Guava)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ajin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"all"</span>)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiterFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每秒钟往里面放多少个令牌</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RateLimiter RATE_LIMITER = RateLimiter.create(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// pre过滤器</span></span><br><span class="line">        <span class="keyword">return</span> FilterConstants.PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最高的优先级</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterConstants.SERVLET_DETECTION_FILTER_ORDER - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 去取一个令牌</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果没有拿到令牌 抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (!RATE_LIMITER.tryAcquire()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RateLimitException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Zuul鉴权"><a href="#Zuul鉴权" class="headerlink" title="Zuul鉴权"></a>Zuul鉴权</h6><ul>
<li>/order/create  只能买家访问（买家下单）</li>
<li>/order/finish   只能卖家访问（买家完结订单）</li>
<li>/product/list   都可访问</li>
</ul>
<p>我们的鉴权是拦截请求的cookie来实现的，如果是移动端或者小程序，没有Cookie，我们不能让网关直接取用户数据库进行查询鉴权，而是让用户服务在用户登录状态变化的时候通过MQ发消息通知，然后我们Zuul网关服务接收到了消息，会去Redis中修改用户的信息和状态等。这样做对性能有帮助，缓解了用户服务数据库的压力。（不用去调用用户服务去查询用户数据了）</p>
<blockquote>
<p>分布式Session（Redis) 保存用户登录状态</p>
<p>OAuth 2.0  Spring Security 保存用户登录状态</p>
</blockquote>
<h6 id="Zuul跨域"><a href="#Zuul跨域" class="headerlink" title="Zuul跨域"></a>Zuul跨域</h6><ul>
<li><p>跨域问题</p>
</li>
<li><p>在被调用的类或方法上增加<code>@CrossOrigin</code>注解</p>
<blockquote>
<p>只能作用于类或方法，具有局限性</p>
</blockquote>
</li>
<li><p>在Zuul里增加CorsFilter过滤器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跨域配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ajin</span></span><br><span class="line"><span class="comment"> * Cross Orgin Resource Share</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"all"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsFilter <span class="title">corsFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> CorsConfiguration config = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        config.setAllowCredentials(<span class="keyword">true</span>); <span class="comment">// 允许Cookie传递</span></span><br><span class="line">        config.setAllowedOrigins(Arrays.asList(<span class="string">"*"</span>));  <span class="comment">// http://www.1.com</span></span><br><span class="line">        config.setAllowedHeaders(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        config.setAllowedMethods(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        <span class="comment">// 缓存时间，在时间内相同的时间不再进行跨域检查</span></span><br><span class="line">        config.setMaxAge(<span class="number">300L</span>);</span><br><span class="line"></span><br><span class="line">        source.registerCorsConfiguration(<span class="string">"/**"</span>, config);</span><br><span class="line"></span><br><span class="line">        CorsFilter corsFilter = <span class="keyword">new</span> CorsFilter(source);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> corsFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Spring-Cloud-Hystrix与服务容错"><a href="#Spring-Cloud-Hystrix与服务容错" class="headerlink" title="Spring Cloud Hystrix与服务容错"></a>Spring Cloud Hystrix与服务容错</h4><h5 id="Hystrix简介"><a href="#Hystrix简介" class="headerlink" title="Hystrix简介"></a>Hystrix简介</h5><ul>
<li>防雪崩利器</li>
<li>为一系列服务提供服务保护功能</li>
</ul>
<h5 id="Hystrix的作用"><a href="#Hystrix的作用" class="headerlink" title="Hystrix的作用"></a>Hystrix的作用</h5><ul>
<li>服务降级</li>
<li>服务熔断</li>
<li>依赖隔离</li>
<li>监控(Hystrix Dashboard)</li>
</ul>
<h6 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h6><p>双11，抢购，提示网络异常等信息，比正常业务逻辑降了级别的逻辑就是服务的降级。</p>
<ul>
<li><p>优先核心服务，非核心服务不可用或弱可用</p>
</li>
<li><p>通过<code>HystrixCommand</code>注解来指定</p>
</li>
<li><p><code>fallbackMethod(回退函数)中具体实现降级逻辑</code></p>
<p>不一定是调用其他服务出现异常会触发降级，而且我们自己的接口内部抛出异常，它也会触发降级</p>
</li>
</ul>
<ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Hystrix --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@EnableCircuitBreaker</span></span><br><span class="line"><span class="comment">//@EnableDiscoveryClient</span></span><br><span class="line"><span class="comment">//basePackages 定义需要扫描的包，不然无法通过Feign调用商品等服务</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span>(basePackages = <span class="string">"com.ajin.product.client"</span>)</span><br><span class="line"><span class="comment">//@SpringBootApplication</span></span><br><span class="line"><span class="meta">@SpringCloudApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用商品服务获取商品信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/getProductInfoList"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProductInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(<span class="string">"http://localhost:8080/product/listForOrder"</span>,</span><br><span class="line">                Arrays.asList(<span class="string">"157875196366160022"</span>), String.class</span><br><span class="line">        );</span><br><span class="line"><span class="comment">//        throw new RuntimeException("异常");</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">fallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"太拥挤了，请稍后再试"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们此时关闭商品服务，那么我们再次调用上述接口（<code>http://localhost:8081/getProductInfoList</code>）就会触发降级方法，浏览器显示如下：</p>
<blockquote>
<p>太拥挤了，请稍后再试</p>
</blockquote>
</li>
</ol>
<h6 id="依赖隔离"><a href="#依赖隔离" class="headerlink" title="依赖隔离"></a>依赖隔离</h6><p><strong>线程池隔离</strong></p>
<p>Hystrix自动实现了依赖隔离</p>
<h6 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用商品服务获取商品信息</span></span><br><span class="line"><span class="comment">     * fallbackMethod = "fallback"</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span>(commandProperties = &#123;</span><br><span class="line">            <span class="comment">// 超时时间 根据具体业务去设置</span></span><br><span class="line"><span class="comment">//            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "3000"),</span></span><br><span class="line">            <span class="comment">// 设置熔断</span></span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.enabled"</span>, value = <span class="string">"true"</span>),</span><br><span class="line">            <span class="comment">// 在使用统计数据进行打开/关闭决策之前必须在statisticsWindow中进行的请求数</span></span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.requestVolumeThreshold"</span>, value = <span class="string">"10"</span>),</span><br><span class="line">            <span class="comment">// 断路器打开后，过了这个时间后进入半开状态，如果此时调用正常，则断路器关闭；</span></span><br><span class="line">            <span class="comment">// 如果此时调用还是失败，则将断路器重新设置成打开状态</span></span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.sleepWindowInMilliseconds"</span>, value = <span class="string">"10000"</span>),</span><br><span class="line">            <span class="comment">// 服务调用失败比例大于60%，则打开断路器；</span></span><br><span class="line">            <span class="comment">// 打开断路器后，不会去调用服务，而是打破原有逻辑，直接去调用设置的降级方法</span></span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.errorThresholdPercentage"</span>, value = <span class="string">"60"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这些配置也可以写到配置项中</p>
</blockquote>
<h4 id="Spring-Cloud-Sleuth-链路追踪"><a href="#Spring-Cloud-Sleuth-链路追踪" class="headerlink" title="Spring Cloud Sleuth 链路追踪"></a>Spring Cloud Sleuth 链路追踪</h4><h5 id="分布式追踪系统"><a href="#分布式追踪系统" class="headerlink" title="分布式追踪系统"></a>分布式追踪系统</h5><ul>
<li>数据采集</li>
<li>数据存储</li>
<li>数据展示</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/05/30/ArrayList和LinkedList理解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/30/ArrayList和LinkedList理解/" itemprop="url">《ArrayList和LinkedList理解》</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-30T17:06:14+08:00">
                2019-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ArrayList是基于数组实现的，LinkedList是基于链表实现的，这是我们都知道的。但是这只是表面，今天，我们从</p>
<p>ArrayList和LinkedList的源码实现来深入理解，并且阐述一些性能优化的问题。</p>
<p>如下，这是ArrayList和LinkedList的继承关系图。</p>
<p><img src="https://static001.geekbang.org/resource/image/ab/36/ab73021caa4545ae0ac917e0f36cde36.jpg" alt=""></p>
<h1 id="ArrayList是如何实现的？"><a href="#ArrayList是如何实现的？" class="headerlink" title="ArrayList是如何实现的？"></a>ArrayList是如何实现的？</h1><p>学习之前想想这些问题：</p>
<p>问题 1：我们在查看ArrayList的实现类源码时，你会发现对象数组 <code>elementData</code>使用了<code>transient</code>修饰，我们知道<code>transient</code>关键字修饰该属性，则表示该属性不会被序列化，然而我们并没有看到文档中说明<code>ArrayList</code>不能被序列化，这是为什么？</p>
<p>问题2：我们在使用<code>ArrayList</code> 进行新增、删除时，经常被提醒“使用<code>ArrayList</code>做新增删除操作会影响效率”。那是不是<code>ArrayList</code>在大量新增元素的场景下效率就一定会变慢呢？</p>
<h2 id="继承实现关系"><a href="#继承实现关系" class="headerlink" title="继承实现关系"></a>继承实现关系</h2><ul>
<li><p>ArrayList实现了List接口，继承了AbstractList抽象类</p>
</li>
<li><p>ArrayList实现了<code>RandomAccess</code>接口</p>
<p><code>RandomAccess</code>是一个空接口，空接口的意义就是一个标记。</p>
<p>看了jdk的注释，是允许随机访问的意思；只要实现该接口的 List 类，都能实现快速随机访问</p>
</li>
</ul>
<ul>
<li><p>还实现了<code>Cloneable</code>和<code>Serilizable</code>，可以实现克隆和序列化</p>
<p><code>private static final long serialVersionUID = 8683452581122892189L;</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure>
<h2 id="ArrayList的属性"><a href="#ArrayList的属性" class="headerlink" title="ArrayList的属性"></a>ArrayList的属性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> 	</span><br><span class="line"><span class="comment">// 默认初始化容量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象数组</span></span><br><span class="line"><span class="keyword">transient</span> Object[] elementData; <span class="comment">// 非私有，以简化嵌套类访问</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组长度，数组现有几个元素</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> size;</span><br></pre></td></tr></table></figure>
<p>我们现在想想问题1，就是<code>transient</code>修饰了elementData，不支持序列化，然后ArrayList还偏偏实现了<code>Serializable</code>接口，到底ArrayList能不能实现序列化呢？</p>
<p>如果能序列化，那序列化如何实现的呢？</p>
<p>我们来探索一番。</p>
<p>ArrayList是基于数组实现的，ArrayList的数组是基于动态增长的。</p>
<blockquote>
<p> 因此并不是所有被分配的内存空间都存储了数据</p>
</blockquote>
<p>所以我们的外部序列化会序列化整个数组。ArrayList 为了避免这些没有存储数据的内存空间被序列化，内部提供了两个私有方法<code>writeObject</code>以及<code>readObject</code> 来自我完成序列化与反序列化，从而在序列化与反序列化数组时节省了空间和时间。</p>
<blockquote>
<p>可以类比一下，HashMap的序列化和反序列化，也是内部自己实现的。</p>
</blockquote>
<blockquote>
<p>所以我们的<code>transient</code>只是为了不让这个对象数组被外部序列化所作的一种保护。</p>
</blockquote>
<h2 id="ArrayList构造方法"><a href="#ArrayList构造方法" class="headerlink" title="ArrayList构造方法"></a>ArrayList构造方法</h2><p>ArrayList有三个构造方法，我们分别看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造一个空的对象数组</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这是我们默认的写法，<code>List&lt;String&gt; list = new ArrayList&lt;String&gt;();
    }</code>,这个构造器会构造一个空的对象数组elementData</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// 传入一个集合给ArrayList</span></span><br><span class="line">    	<span class="comment">// 将集合转成对象数组</span></span><br><span class="line">        elementData = c.toArray();</span><br><span class="line">        <span class="keyword">if</span> ((size = elementData.length) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span></span><br><span class="line">            <span class="keyword">if</span> (elementData.getClass() != Object[].class)</span><br><span class="line">                elementData = Arrays.copyOf(elementData, size, Object[].class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// replace with empty array.</span></span><br><span class="line">            <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// 按照初始容量创建数组大小</span></span><br><span class="line">       <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// 使用默认的空数组</span></span><br><span class="line">           <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 参数小于0，报异常</span></span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+</span><br><span class="line">                                              initialCapacity);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们还要注意一个细节Arrays.asList()方法，产生的ArrayList是Arrays类中的一个静态私有内部类对象，而并非我们这里的java.util.ArrayList</p>
</blockquote>
<p>调优小攻略：</p>
<blockquote>
<p>当ArrayList新增元素时，如果所存储的元素已经超过其已有大小，它会计算元素大小后再进行动态扩容，数组的扩容会导致整个数组进行一次内存复制。</p>
<p>因此，我们在初始化ArrayList时，可以通过<code>ArrayList(int initialCapacity)</code> 构造函数合理指定数组初始大小，这样有助于减少数组的扩容次数，从而提高系统性能。</p>
</blockquote>
<h2 id="ArrayList新增元素"><a href="#ArrayList新增元素" class="headerlink" title="ArrayList新增元素"></a>ArrayList新增元素</h2><ol>
<li><p>直接将元素加到数组的末尾</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 确认数组容量是否足够</span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加元素到任意位置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    rangeCheckForAdd(index);</span><br><span class="line"></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,</span><br><span class="line">                     size - index);</span><br><span class="line">    elementData[index] = element;</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>两个方法的相同之处是在添加元素之前，都会先确认容量大小，如果容量够大，就不用进行扩容；如果容量不够大，就会按照原来数组的1.5倍大小进行扩容，在扩容之后需要将数组复制到新分配的内存地址。</p>
<p>​    <code>ensureCapacityInternal()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">     ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><code>ensureExplicitCapacity</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>grow</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>扩容就会生成一个新的对象数组，把之前数组的元素拷贝过来。</p>
<p>猜想一下，之前的对象数组是不是可能会被GC干掉呢？</p>
</blockquote>
<p>两个方法也有不同之处，添加元素到任意位置，会导致在该位置后的所有元素都需要重新排列，而将元素添加到数组的末尾，在没有发生扩容的前提下，是不会有元素复制排序过程的。</p>
<p>所以刚刚第二个问题，ArrayList添加元素，如果是添加到数组末尾，而没有发生扩容，它的性能也是足够好的。</p>
<p>要做到这一点，就需要我们新建ArrayList的时候，需要初始化数组的容量。</p>
<h2 id="ArrayList删除元素"><a href="#ArrayList删除元素" class="headerlink" title="ArrayList删除元素"></a>ArrayList删除元素</h2><p>ArrayList的删除方法和添加任意位置元素的方法是有些相同的。ArrayList 在每一次有效的删除元素操作之后，都要进行数组的重组，并且删除的元素位置越靠前，数组重组的开销就越大。</p>
<blockquote>
<p>其实这就是线性结构的缺陷了。</p>
</blockquote>
<h1 id="LinkedList的实现"><a href="#LinkedList的实现" class="headerlink" title="LinkedList的实现"></a>LinkedList的实现</h1><p>LinkedList是基于<strong>双向链表</strong>数据结构实现的，LinkedList定义了一个<code>Node</code>结构，<code>Node</code>结构中包含了3个部分：元素内容item、前指针prev以及后指针next。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    	<span class="comment">// 元素内容</span></span><br><span class="line">       E item;</span><br><span class="line">    	<span class="comment">// 前指针</span></span><br><span class="line">       Node&lt;E&gt; next;</span><br><span class="line">    	<span class="comment">// 后指针</span></span><br><span class="line">       Node&lt;E&gt; prev;</span><br><span class="line"></span><br><span class="line">       Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">           <span class="keyword">this</span>.item = element;</span><br><span class="line">           <span class="keyword">this</span>.next = next;</span><br><span class="line">           <span class="keyword">this</span>.prev = prev;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>总结一下，LinkedList 就是由<code>Node</code>结构对象连接而成的一个双向链表。</p>
<h2 id="实现类"><a href="#实现类" class="headerlink" title="实现类"></a>实现类</h2><ul>
<li><p>LinkedList实现了List接口，继承了AbstractSequentialList类</p>
</li>
<li><p>它实现了Deque类</p>
<blockquote>
<p><code>Deque</code>: 线性集合，支持两端的元素插入和移除(队列)</p>
</blockquote>
</li>
<li><p>实现了Cloneable和java.io.Serializable接口，支持克隆和序列化</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractSequentialList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">Deque</span>&lt;<span class="title">E</span>&gt;, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure>
<h2 id="LinkedList新增元素"><a href="#LinkedList新增元素" class="headerlink" title="LinkedList新增元素"></a>LinkedList新增元素</h2><p>LinkedList 添加元素的实现很简洁，但添加的方式却有很多种。</p>
<p>默认的add（E e）方法是将添加的元素加到队尾，首先是将last元素置换到临时变量中，生成一个新的Node节点对象，然后将last引用指向新节点对象，之前的last对象的前指针指向新节点对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        linkLast(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 链接e作为最后一个元素。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">linkLast</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(l, e, <span class="keyword">null</span>);</span><br><span class="line">        last = newNode;</span><br><span class="line">        <span class="keyword">if</span> (l == <span class="keyword">null</span>)</span><br><span class="line">            first = newNode;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            l.next = newNode;</span><br><span class="line">        size++;</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="LinkedList-删除元素"><a href="#LinkedList-删除元素" class="headerlink" title="LinkedList 删除元素"></a>LinkedList 删除元素</h2><p>在LinkedList 删除元素的操作中，我们首先要通过循环找到要删除的元素，如果要删除的位置处于List的前半段，就从前往后找；若其位置处于后半段，就从后往前找。<br>这样做的话，无论要删除较为靠前或较为靠后的元素都是非常高效的，但如果List 拥有大量元素，移除的元素又在List的中间段，那效率相对来说会很低。</p>
<h2 id="LinkedList-遍历元素"><a href="#LinkedList-遍历元素" class="headerlink" title="LinkedList 遍历元素"></a>LinkedList 遍历元素</h2><p>LinkedList的获取元素操作实现跟LinkedList的删除元素操作基本类似，通过分前后半段来循环查找到对应的元素。但是通过这种方式来查询元素是非常低效的，特别是在for循环遍历的情况下，每一次循环都会去遍历半个List。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/05/30/《字符串性能优化的一点总结》/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/30/《字符串性能优化的一点总结》/" itemprop="url">《字符串性能优化的一点总结》</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-30T16:58:21+08:00">
                2019-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本篇会从基本概念和优化方案这两个方面来阐述字符串性能优化方面的原理。</p>
<p>String是内存中占用空间最大的对象。</p>
<p>我们首先看下面的代码，运行一下，查看下自己对String的基本原理是否掌握。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      String str1 = <span class="string">"abc"</span>;</span><br><span class="line">      String str2 = <span class="keyword">new</span> String(<span class="string">"abc"</span>);</span><br><span class="line">      String str3 = str2.intern();</span><br><span class="line"></span><br><span class="line">      System.out.println(str1==str2); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">      System.out.println(str2==str3); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">      System.out.println(str1==str3); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>str1是在字符串常量池创建的</li>
<li>str2是在堆中创建</li>
<li>str3去字符串常量池找到了str1引用的对象，所以就不会新建字符串对象，而是返回str1指向的对象了</li>
</ol>
</blockquote>
<h2 id="String对象的不可变性"><a href="#String对象的不可变性" class="headerlink" title="String对象的不可变性"></a>String对象的不可变性</h2><p>在实现代码中<code>String</code>类被final关键字修饰了，而且变量char数组也被final修饰了。</p>
<p>我们知道类被<code>final</code> 修饰代表该类不可继承，而char被final+private修饰，代表了<code>String</code>对象不可被更改。Java实现的这个特性叫作<code>String</code>对象的不可变性，即<code>String</code> 对象一旦创建成功，就不能再对它进行改变。</p>
<p><strong>好处：</strong></p>
<blockquote>
<p>第一，保证 String对象的安全性。假设String 对象是可变的，那么String对象将可能被恶意修改。</p>
<p>第二，保证 hash 属性值不会频繁变更，确保了唯一性，使得类似HashMap容器才能实现相应的key-value缓存功能。</p>
<p>第三，可以实现字符串常量池。在Java中，通常有两种创建字符串对象的方式，一种是通过字符串常量的方式创建，如String str=“abc”；另一种是字符串变量通过new形式的创建，如String str=new String（”abc”）。</p>
<p>当代码中使用第一种方式创建字符串对象时，JVM首先会检查该对象是否在字符串常量池中，如果在，就返回该对象引用，否则新的字符串将在常量池中被创建。这种方式可以减少同一个值的字符串对象的重复创建，节约内存。</p>
</blockquote>
<h2 id="String对象的优化"><a href="#String对象的优化" class="headerlink" title="String对象的优化"></a><strong>String对象的优化</strong></h2><ol>
<li><p>字符串的拼接建议使用<code>StringBuffer</code>和<code>StringBuilder</code></p>
<blockquote>
<p><code>StringBuffer</code>是线程安全的，但是性能比不上<code>StringBuilder</code></p>
</blockquote>
</li>
<li><p>在字符串常量中，默认会将对象放入常量池；在字符串变量中，对象是会创建在堆内存中。如果调用<code>intern</code>方法，会去查看字符串常量池中是否有等于该对象的字符串，如果没有则在常量池中新增该对象，并返回该对象引用；如果有，则返回常量池中的字符串。堆内存中原有的对象由于没有引用指向它，将会通过垃圾回收器回收。</p>
</li>
<li><p>字符串的分割，这种方法在编码中也很最常见。</p>
<p><code>Split()</code>方法使用了正则表达式实现了其强大的分割功能，而正则表达式的性能是非常不稳定的，使用不恰当会引起回溯问题，很可能导致CPU居高不下。</p>
<p>所以我们应该慎重使用<code>Split()</code>方法，我们可以用<code>String.indexOf()</code>方法代替<code>Split()</code>方法完成字符串的分割。如果实在无法满足需求，你就在使用<code>split()</code>方法时，对回溯问题加以重视就可以了。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/05/25/Spring-Cloud-Eureka服务注册与发现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/25/Spring-Cloud-Eureka服务注册与发现/" itemprop="url">Spring Cloud Eureka服务注册与发现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-25T21:34:45+08:00">
                2019-05-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h2><p>服务注册与发现是微服务必须面对的问题，而Eureka Server是被广泛应用的高可用服务注册与发现的组件，本篇主要从实际操作和基本原理方面探讨Eureka的服务注册与发现原理。</p>
<h2 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a>Eureka Server</h2><h3 id="搭建EurekaServer"><a href="#搭建EurekaServer" class="headerlink" title="搭建EurekaServer"></a>搭建EurekaServer</h3><ol>
<li><p>引入pom.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>搭建注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@EnableEurekaServer</code>的作用其实就是激活Eureka Server的自动配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(EurekaServerMarkerConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableEurekaServer &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerMarkerConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Marker <span class="title">eurekaServerMarkerBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Marker();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Marker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看<code>EurekaServerMarkerConfiguration</code>,它知识new了一个Marker对象，而Marker对象是为了实现Eureka Server的自动配置，看完下面的代码你就明白了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(EurekaServerInitializerConfiguration.class)</span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(EurekaServerMarkerConfiguration.Marker.class)<span class="comment">//Marker</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(&#123; EurekaDashboardProperties.class,</span><br><span class="line">		InstanceRegistryProperties.class &#125;)</span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:/eureka/server.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerAutoConfiguration</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>这个就是<code>@ConditionalOnBean(EurekaServerMarkerConfiguration.Marker.class)</code>这个条件注解，配合<code>EurekaServerAutoConfiguration</code>这个Eureka Server的配置类来实现Eureka Server的自动化配置</p>
</li>
<li><p>配置Eureka Server（单节点）</p>
<p><code>applicaion.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## 单节点情况下，Eureka Server不用自己注册到自己</span><br><span class="line">eureka.client.register-with-eureka=false</span><br><span class="line">## 关闭Eureka Server的自我保护机制（该配置只有在开发环境中才可以打开）</span><br><span class="line">eureka.server.enable-self-preservation=false</span><br></pre></td></tr></table></figure>
<p>加上此配置项后，我们启动Eureka Server发现控制台如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> main] com.netflix.discovery.DiscoveryClient    : Disable delta property : false</span><br><span class="line">2019-05-25 16:13:13.660  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Single vip registry refresh property : null</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Force full registry fetch : false</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Application is null : false</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Registered Applications size is zero : true</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Application version is -1: true</span><br><span class="line">2019-05-25 16:13:13.661  INFO 15912 --- [           main] com.netflix.discovery.DiscoveryClient    : Getting all instance registry info from the eureka server</span><br></pre></td></tr></table></figure>
<blockquote>
<p>该注册中心还没有服务实例注册进来，说明我们刚刚的配置是生效的</p>
</blockquote>
</li>
</ol>
<blockquote>
<p>总结：Eureka Server本身就是一个注册中心，不涉及业务，所以本身的搭建还是比较简单的。</p>
</blockquote>
<h3 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="Eureka Client"></a>Eureka Client</h3><p>Eureka Client需要将自己注册到服务注册中心，这就是<strong>服务注册</strong>。</p>
<h3 id="搭建Eureka-Client"><a href="#搭建Eureka-Client" class="headerlink" title="搭建Eureka Client"></a>搭建Eureka Client</h3><ol>
<li><p>引入pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看注解<code>EnableDiscoveryClient</code>的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(EnableDiscoveryClientImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDiscoveryClient &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * If true, the ServiceRegistry will automatically register the local server.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">autoRegister</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EnableDiscoveryClientImportSelector</code>点进去：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(Ordered.LOWEST_PRECEDENCE - <span class="number">100</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableDiscoveryClientImportSelector</span></span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">SpringFactoryImportSelector</span>&lt;<span class="title">EnableDiscoveryClient</span>&gt; </span>&#123;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不用看下面了，我们直接就知道这个借助了工具类<code>SpringFactoriesLoader</code>去项目所有jar包下面去找<code>spring.factories</code>中如下的配置：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.cloud.client.discovery.EnableDiscoveryClient=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration</span><br></pre></td></tr></table></figure>
<p><code>EurekaDiscoveryClientConfiguration</code>就被我们找到了，我们留意一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(EurekaClientConfig.class)</span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"eureka.client.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaDiscoveryClientConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Marker</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Marker <span class="title">eurekaDiscoverClientMarker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Marker();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>又出现了Marker()，我们很习惯了，这是个标记，没有实际意义，一个辅助的Bean而已。</p>
</blockquote>
<p>我们按alt+F7</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(EurekaClientConfig.class)</span><br><span class="line"><span class="meta">@Import</span>(DiscoveryClientOptionalArgsConfiguration.class)</span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(EurekaDiscoveryClientConfiguration.Marker.class) <span class="comment">//</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"eureka.client.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(&#123; NoopDiscoveryClientAutoConfiguration.class,</span><br><span class="line">		CommonsClientAutoConfiguration.class, ServiceRegistryAutoConfiguration.class &#125;)</span><br><span class="line"><span class="meta">@AutoConfigureAfter</span>(name = <span class="string">"org.springframework.cloud.autoconfigure.RefreshAutoConfiguration"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClientAutoConfiguration</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p><code>@ConditionalOnBean(EurekaDiscoveryClientConfiguration.Marker.class)</code>,</p>
<p>原来千呼万唤使出来，这个<code>Marker</code>只为了召唤出<code>EurekaClientAutoConfiguration</code>自动配置类。</p>
</li>
</ol>
<p>   到这里整个<code>EnableDiscoveyClient</code>注解的意义就很清晰了。（这个注解是Spring Cloud的common包提供的，并不是netflix的）</p>
<ol start="3">
<li><p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">## 注册中心的地址（单节点）</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:8761/eureka/</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Eureka-Server的高可用"><a href="#Eureka-Server的高可用" class="headerlink" title="Eureka Server的高可用"></a>Eureka Server的高可用</h2><p>   单节点的Eureka Server太容易挂掉了，所以我们要部署多台Eureka Server，并且Eureka Server之间要互相注册，这样每个Eureka Server都能获取到注册表的信息。</p>
<p>假设在高可用场景下，其中一台Eureka Server宕机了，会出现怎样的情况？</p>
<blockquote>
<p>另一台eureka Server仍然会维护者注册表信息。</p>
</blockquote>
<h2 id="服务发现的两种方式"><a href="#服务发现的两种方式" class="headerlink" title="服务发现的两种方式"></a>服务发现的两种方式</h2><h3 id="客户端发现"><a href="#客户端发现" class="headerlink" title="客户端发现"></a>客户端发现</h3><ul>
<li>Eureka</li>
</ul>
<p>如果别人的服务不是采用Java语言开发，那还能注册到服务注册中心吗？</p>
<blockquote>
<p>微服务的特点：<strong>异构</strong></p>
<ul>
<li>不同语言</li>
<li>不同类型的数据库</li>
</ul>
</blockquote>
<p>其他语言的服务如何从服务注册中心获取其他服务，并进行调用呢？</p>
<blockquote>
<p>Spring Cloud可以实现其他语言纳入自己的服务治理体系。</p>
</blockquote>
<h3 id="服务端发现"><a href="#服务端发现" class="headerlink" title="服务端发现"></a>服务端发现</h3><p>代理介入</p>
<ul>
<li>Nginx</li>
<li>Zookeeper</li>
<li>Kubernates</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p>Eureka Client会定期和Eureka Server维持一个心跳，如果超过某个时间，Eureka Server还是没收到Eureka Client发送的心跳，那么Eureka Server就会把该服务实例从注册表中剔除掉</p>
</li>
<li><p>Eureka Client也会定期去Eureka Server那拉取服务实例的注册表信息，这个时间可以设置</p>
<blockquote>
<p>Eureka Server中在内存中维护的注册表，有三层Map，可以很好的满足Eureka Client对注册表信息的拉取与修改（比如突然新增加了一台服务实例），三层Map很好的满足了多个Eureka Client的高并发访问场景</p>
</blockquote>
</li>
<li><p>我们服务注册中心高可用的场景，Eureka Client设置好多个注册中心的地址即可</p>
</li>
<li><p>我觉得Eureka Server是为了维护分布式系统中的高可用而牺牲了一致性，这个有点过度极端设计的嫌疑</p>
</li>
</ul>
<blockquote>
<p>Eureka 具有心跳检查，健康检查，负载均衡等功能。</p>
<p>Eureka的高可用，生产环境要部署多台Eureka Server。</p>
</blockquote>
<p><strong>在分布式系统中，服务注册中心是最重要的基础部分。</strong></p>
<p>why？</p>
<p>分布式系统中为什么需要服务发现？</p>
<blockquote>
<p>注册中心维护多个服务的实例，就像是一个字典，一个服务要想调用其他服务，就直接从注册中心获取服务就可以了，这个就是服务发现。因为分布式系统中，服务实例有无数多个，并且服务实例也是动态变化的，所以需要依赖注册中心来维护这些变化的无数个服务实例。</p>
</blockquote>
<p><strong>注册中心是服务之间产生各种各样关系的桥梁。</strong></p>
<blockquote>
<p>微服务的落地，不是有什么固定套路，要具体问题具体分析，重要的是微服务的原理，而不是采用何种语言，何种固定套路。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/05/10/Kafka的主题与分区/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/Kafka的主题与分区/" itemprop="url">Kafka的主题与分区</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-10T14:39:12+08:00">
                2019-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/消息队列/" itemprop="url" rel="index">
                    <span itemprop="name">消息队列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>主题在kafka中可看作是消息的分类，而分区是消息的进一步分类。</p>
<blockquote>
<p>需要注意的是，主题与分区是逻辑上的概念。</p>
</blockquote>
<h2 id="主题的管理"><a href="#主题的管理" class="headerlink" title="主题的管理"></a>主题的管理</h2><h3 id="创建主题"><a href="#创建主题" class="headerlink" title="创建主题"></a>创建主题</h3><p>我们采用<code>kafka-topics.sh</code> 脚本来创建主题</p>
<p>例如：<code>bin/kafka-topics .sh -- zookeeper localhost: 2181/kafka --create --topic topic-create --partitions 4 --replication- factor 2</code> </p>
<blockquote>
<p>创建一个分区数为4，副本因子为2的主题topic-create</p>
</blockquote>
<p>在执行完脚本之后， Kafka 会在 log.dir 或 log.dirs 参数所配置的目录下创建相应的主题分区，默认情况下这个目录为/tmp/kafka-logs/ 。</p>
<p><img src="https://liutianruo-2019-go-go-go.oss-cn-shanghai.aliyuncs.com/images/Kafka主题，分区，副本的关系.jpg" alt=""></p>
<p>​                                                                [<strong>Kafka主题，分区和副本之间的关系</strong>]</p>
<p>主题和分区是逻辑上的，而副本是物理上的一个存在，而每一个副本都对应一个日志文件。同时我们可以通过zookeeper获取该主题分区下。</p>
<p>我们回顾下创建主题的指令：</p>
<p><code>bin/kafka-topics .sh -- zookeeper localhost: 2181/kafka --create --topic topic-create --partitions 4 --replication-factor 2</code> </p>
<ul>
<li><p><code>zookeeper</code>：zookeeper的连接地址</p>
</li>
<li><p><code>partitions</code>：该主题的分区数</p>
</li>
<li><p><code>replication-factor</code>：副本因子</p>
</li>
<li><p><code>--topic topic-create</code>：主题名称</p>
</li>
<li><p><code>--create</code>：创建主题</p>
<blockquote>
<ul>
<li>list  </li>
<li>describe</li>
<li>alter</li>
<li>delete</li>
</ul>
</blockquote>
</li>
</ul>
<p>我们将create换成describe，顾名思义，就是描述我们之前创建好的主题信息</p>
<p><code>bin/kafka-topics.sh -- zookeeper localhost:2181/kafka --describe --topic topic-create</code> </p>
<p>该指令的输出为：</p>
<blockquote>
<p>Topic:   topic-create     PartitionCount:4     ReplicationFactor:2  Configs: </p>
<p>Topic:  topic-create    Partition:0    Leader:2    Replicas:2,0    Isr:2,0</p>
<p>Topic:  topic-create    Partition:1    Leader:0    Replicas:0,1   Isr:0,1</p>
<p>Topic:  topic-create    Partition:2    Leader:1    Replicas:1,2   Isr:1,2</p>
<p>Topic:  topic-create   Partition:3   Leader:2     Replicas:2,1   Isr:2,1</p>
</blockquote>
<ul>
<li><code>Topic</code>：主题名</li>
<li><code>Partition</code>：分区号</li>
<li><code>PartitionCount</code>：分区总数</li>
<li><code>ReplicationFactor</code>：副本因子</li>
<li><code>Leader</code>：表示该分区leader对应的brokerId</li>
<li><code>Configs</code>：表示创建和修改主题时的配置信息</li>
<li><code>Replicas</code>：分区所有的副本分配情况</li>
<li><code>Isr</code>：表示分区的 ISR 集合 </li>
</ul>
<p>现在归纳一下使用<code>kafka-topics.sh</code>创建主题的模板指令：</p>
<blockquote>
<p>kafka-topics.sh–zookeeper <a href="String:hosts" target="_blank" rel="noopener">String:hosts</a>-create–topic [String:topic]–<br>partitions&lt;Integer:# of partitions&gt;-replication-factor &lt;Integer:replication factor&gt;</p>
</blockquote>
<p><code>kafka-topics.sh</code>提供了一个<code>replica-assignment</code> 参数指定分区部分的方案用来创建一个主题。</p>
<blockquote>
<p>[root@ node1kafka 2.11-2.0.0]# bin/kafka-topics. sh–zookeeper 1ocalhost:2181/ kafka –create  –topic topic-create-same    –replica-assignment    2:0,0:1,1:2,2:1<br>Created topic “topic-create-same”.</p>
</blockquote>
<p>我们用<code>describle</code>指令查看分区副本的详细情况</p>
<blockquote>
<p>[ rootenodel kafka 2.11-2.0.0]# bin/kafka-topics. sh–zookeeper localhost:2181/kafka<br>–describe–topic   topic-create-same  Topic: topic-create-same   PartitionCount:4 ReplicationFactor:2 Configs: </p>
<p>Topic: topic-create-same  Partition:0   Leader:2     Replicas:2,0    Isr:2,0<br>Topic: topic-create-same  Partition:1   Leader:0     Replicas:0,1    Isr:0,1<br>Topic: topic-create-same  Partition:2   Leader:1     Replicas:1,2    Isr:1,2<br>Topic: topic-create-same  Partition:3   Leader:2      Replicas:2,1    Isr:2,1</p>
</blockquote>
<p>其实<code>kafka-topics.sh</code>就是通过<code>kafka.admin.TopicCommand</code>来创建主题</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>创建主题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createTopic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       String[] options = <span class="keyword">new</span> String[]&#123;</span><br><span class="line">               <span class="string">"--zookeeper"</span>, <span class="string">"localhost:2181/kafka"</span>,</span><br><span class="line">               <span class="string">"--create"</span>,</span><br><span class="line">               <span class="string">"--replication-factor"</span>, <span class="string">"1"</span>,</span><br><span class="line">               <span class="string">"--partitions"</span>, <span class="string">"1"</span>,</span><br><span class="line">               <span class="string">"--topic"</span>, <span class="string">"topic-create-api"</span></span><br><span class="line">       &#125;;</span><br><span class="line">       TopicCommand.main(options);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>控制台输出结果：</p>
<blockquote>
<p>Created topic “topic-create-api”.</p>
</blockquote>
<h3 id="分区副本的分配"><a href="#分区副本的分配" class="headerlink" title="分区副本的分配"></a>分区副本的分配</h3><p>其实之前生产者与消费者，就有分区分配的概念：</p>
<ul>
<li><p>生产者的分区分配：为每条消息分配要发往的分区</p>
</li>
<li><p>消费者的分区分配：为消费者指定可以消费的分区</p>
</li>
</ul>
<blockquote>
<p>而创建主题的分区副本分配：为Kafka集群制定创建主题时的分区分配副本方案，就是在哪个broker中创建哪些分区的副本。</p>
</blockquote>
<h3 id="查看主题信息"><a href="#查看主题信息" class="headerlink" title="查看主题信息"></a>查看主题信息</h3><p><code>kafka-topics.sh</code>的<code>describe/list</code>指令可以用来查看主题信息。</p>
<ol>
<li><p>list</p>
<blockquote>
<p>bin /kafka-topics.sh  –zookeeper localhost : 2181/kafka   -list </p>
</blockquote>
<p>查看当前所有可用的主题</p>
</li>
<li><p>describe</p>
<blockquote>
<p>bin/kafka-topics.sh – zookeeper localhost:2181/kafka  –describe –topic  topic-create,topic-demo </p>
</blockquote>
<p>查看多个主题的信息</p>
</li>
</ol>
<h3 id="修改主题"><a href="#修改主题" class="headerlink" title="修改主题"></a>修改主题</h3><p>在主题被创建之后，我们仍然可以修改主题的信息，比如修改分区个数等等。</p>
<blockquote>
<p>bin/kafka-topics . sh – zookeeper localhost:2181/kafka –alter –topic topic-config  –partitions 3 </p>
</blockquote>
<p>修改topic-config主题的分区数为3</p>
<blockquote>
<p>修改分区数的时候，会影响生产者的发消息时，根据相同的key计算分区下标的结果，导致原来发往A分区的，随着分区数的变化，发给B分区。</p>
</blockquote>
<p>Kafka目前不支持减少分区，很明显的，如果减少了一个分区，那么这个分区中的消息是删除掉还是交给其他的主题，没有一个可靠的方案。</p>
<blockquote>
<p>bin/kafka-topics. sh – zookeeper localhost:2181/kafka – alter –topic topic- config –config max.message.bytes=20000 </p>
</blockquote>
<p> 修改主题的配置信息</p>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>之前我们创建，查看和修改主题，都是用的<code>kafka-topics.sh</code>脚本来实现的，而配置管理主要是通过<code>kafka-configs.sh</code>来实现的。</p>
<p>我们之前也可以通过<code>kafka-topics.sh</code>来实现配置修改和查看，但是更推荐使用<code>kafka-configs.sh</code>。</p>
<blockquote>
<p>[ rootenodel kafka_2.11-2.0.0]# bin/kafka-topics. sh–zookeeper localhost:2181/<br>kafka–describe –topic topic-config–topics-with-overrides</p>
<p> Topic: topic-config    PartitionCount:3   ReplicationFactor:1</p>
<p>Configs:  max. message. bytes=10000,    cleanup. policy=compact</p>
</blockquote>
<h3 id="删除主题"><a href="#删除主题" class="headerlink" title="删除主题"></a>删除主题</h3><blockquote>
<p>[rootenodel kafka_2.11-2.0.0]#<code>bin/kafka-topics.sh  --zookeeper localhost:2181/kafka  --delete  --topic topic-delete</code> </p>
<p>Topic topic-delete is marked for deletion.</p>
<p>Note:This will have no impact if delete.topic.enable is not set to true.</p>
</blockquote>
<h2 id="KafkaAdminClient"><a href="#KafkaAdminClient" class="headerlink" title="KafkaAdminClient"></a>KafkaAdminClient</h2><p>我们可以使用<code>KakfaAdminClient</code>对主题进行管理</p>
<ul>
<li>创建主题：<code>CreateTopicsResult createTopics（Collection-NewTopic&gt;newTopics）</code></li>
<li>删除主题：<code>DeleteTopicsResult deleteTopics（Collection&lt;String&gt;topics）</code></li>
<li>列出所有可用的主题：<code>ListTopicsResult listTopics(）</code></li>
<li>查看主题的信息：<code>DescribeTopicsResult describe Topics（Collection&lt;String&gt;topicNames）</code></li>
<li>查询配置信息：<code>DescribeConfigsResult describeConfigs（Collection&lt;ConfigResource&gt; resources）</code></li>
<li>修改配置信息：<code>AlterConfigsResult alterConfigs（Map&lt;ConfigResource，Config&gt;configs）</code></li>
<li>增加分区：<code>CreatePartitionsResult createPartitions（Map&lt;String，NewPartitions&gt;newPartitions）</code></li>
</ul>
<p>创建一个分区数为4，副本因子为1的主题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建主题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createTopic</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String brokerList = <span class="string">"localhost:9092"</span>;</span><br><span class="line">    String topic = <span class="string">"topic-admin"</span>;</span><br><span class="line"></span><br><span class="line">    Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">    props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, brokerList);</span><br><span class="line">    props.put(AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG, <span class="number">30000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据配置项创建AdminClient</span></span><br><span class="line">    AdminClient client = AdminClient.create(props);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建主题信息： 主题名称，分区数，副本因子</span></span><br><span class="line">    NewTopic newTopic = <span class="keyword">new</span> NewTopic(topic, <span class="number">4</span>, (<span class="keyword">short</span>) <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建主题的核心：</span></span><br><span class="line"><span class="comment">     * 1. 客户端根据方法的调用创建相应的协议请求CreateTopicRequest</span></span><br><span class="line"><span class="comment">     * 2. 客户端将请求发送至服务端</span></span><br><span class="line"><span class="comment">     * 3. 服务端处理客户端的请求并返回响应CreateTopicResponse</span></span><br><span class="line"><span class="comment">     * 4. 客户端接收响应并解析处理</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建主题</span></span><br><span class="line">    CreateTopicsResult result = client.createTopics(Collections.singleton(newTopic));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result.all().get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭AdminClient</span></span><br><span class="line">    client.close();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分区的管理"><a href="#分区的管理" class="headerlink" title="分区的管理"></a>分区的管理</h2><h3 id="优先副本的选举"><a href="#优先副本的选举" class="headerlink" title="优先副本的选举"></a>优先副本的选举</h3><p>分区使用多副本机制来提升可靠性，但是只有leader副本对外提供读写服务，而follower副本只负责在内部进行消息的同步。</p>
<p>如果一个分区的leader副本不可用，那么就意味着整个分区不可用，Kafka就会从剩余的follower副本中挑选出一个新的leader副本来继续对外提供副本。</p>
<blockquote>
<p>这个就是分布式消息的可靠性体现，这个leader选举，可以类比Redis的主从中的哨兵模式，主库挂了，哨兵就会对从库进行选举，原理不一定一样，但是思路可能相似（也就是怎么选leader/master的问题）</p>
</blockquote>
<p>当宕机恢复后的leader,只能作为follower副本存在。</p>
<h4 id="负载不均衡"><a href="#负载不均衡" class="headerlink" title="负载不均衡"></a>负载不均衡</h4><p>随着时间的更替，Kafka 集群的 broker 节点不可避免地会遇到岩机或崩溃的问题 ， 当分区的 leader 节点发生故障时 ，其中一个 follower 节点就会成为新的 leader 节点，这样就会导致集群的<strong>负载不均衡</strong> ， 从而影响整体的健壮性和稳定性 。  </p>
<h4 id="优先副本"><a href="#优先副本" class="headerlink" title="优先副本"></a>优先副本</h4><p>为了能够有效地治理负载失衡的情况 ， Kafka 引入了<strong>优先副本</strong>（ preferred replica ） 的概念 。所谓的优先副本是指在 AR 集合列表中的第一个副本 。 比如主题 topic-partitions 中分区0的 AR 集合列表（ Replicas ）为 ［ 1 ,2 ,0］ ， 那么分区 0 的优先副本即为 1 。 理想情况下，优先副本就是该分区的 leader 副本，所以也可以称之为 preferred leader。 Kafka 要确保所有主题的优先副本在 Kafka 集群中均匀分布，这样就保证 了所有分区 的 leader 均衡分布 。 如果 leader 分布过于集中， 就会造成集群负载不均衡 。</p>
<p>所谓的优先副本的选举是指通过一定的方式促使优先副本选举为 leader 副本，以此来促进集群的负载均衡 ， 这一行为也可以称为“分区平衡” 。</p>
<p>需要注意 的是 ， 分区平衡并不意味着 Kafka 集群的负载均衡，因为还要考虑集群中的分区分配是否均衡。更进一步，每个分区的 leader 副本的负载也是各不相同 的， 有些 leader 副本的负载很高，比如需要承载 TPS为 30000 的负荷， 而有些 leader 副本只需承载个位数的 负荷 。 也就是说 ， 就算集群中的分区分配均衡、 leader 分配均衡 ，也并不能确保整个集群的负载就是均衡的 ，还需要其他一些硬性的指标来做进一步的衡量。</p>
<blockquote>
<p>参考自朱忠华《深入理解Kafka：核心设计与实践原理》p133</p>
</blockquote>
<h3 id="修改副本因子"><a href="#修改副本因子" class="headerlink" title="修改副本因子"></a>修改副本因子</h3><p>创建主题之后我们还可以修改分区的个数，同样可以修改副本因子（副本数）。</p>
<p>修改副本因子的使用场景也很多，比如在创建主题时填写了错误的副本因子数而需要修改，再比如运行一段时间之后想要通过增加副本因子数来提高容错性和可靠性。 </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/04/29/3-消费者/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/29/3-消费者/" itemprop="url">3.消费者</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-29T20:21:21+08:00">
                2019-04-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/消息队列/" itemprop="url" rel="index">
                    <span itemprop="name">消息队列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="消费者与消费者组"><a href="#消费者与消费者组" class="headerlink" title="消费者与消费者组"></a>消费者与消费者组</h1><p>生产者发送消息到Kafka Broker节点，而我们的消费者就订阅了Kafka的主题，从订阅的主题中拉取消息。</p>
<p>而每一个消费者都对应一个消费者组。当消息被发布到主题后，只会被投递给订阅它的消费者组中的一个消费者。</p>
<p>每一个分区只能被一个消费者所消费。</p>
<p>对于消息中间件而言 ， 一般有两种消息投递模式：</p>
<p><strong>点对点 （ P2P, Point-to-Point）模式和发布／订阅（ Pub/Sub ）模式</strong> 。</p>
<p> 点对点模式是基于队列的，消息生产者发送消息到队列，消息消费者从队列中接收消息。</p>
<p>发布订阅模式定义了如何向一个内容节点发布和订阅消息，这个内容节点称为主题（ Topic ），主题可以认为是消息传递的中介，消息发布者将消息发布到某个主题，而消息订阅者从主题中订阅消息。</p>
<p>主题使得消息的订阅者和发布者互相保持独立，不需要进行接触即可保证消息的传递，发布／订阅模式在消息的一对多广播时采用 。</p>
<p> Kafka 同时支持两种消息投递模式，而这正是得益于消费者与消费组模型的契合：</p>
<p>如果所有的消费者都隶属于同一个消费组，那么所有的消息都会被均衡地投递给每一个消费者，即每条消息只会被一个消费者处理，这就相当于点对点模式的应用 。</p>
<p>如果所有的消费者都隶属于不同的消费组，那么所有的消息都会被广播给所有的消费者，即每条消息会被所有的消费者处理，这就相当于发布／订阅模式的应用 。 </p>
<blockquote>
<p>消费者组是一个逻辑概念，而消费者是一个实际存在的应用。</p>
</blockquote>
<h1 id="消费者客户端开发"><a href="#消费者客户端开发" class="headerlink" title="消费者客户端开发"></a>消费者客户端开发</h1><ol>
<li>配置消费者客户端参数及创建相应的消费者实例</li>
<li>订阅主题</li>
<li>拉取消息并消费</li>
<li>提交消费位移</li>
<li>关闭消费者实例</li>
</ol>
<h2 id="问题处理"><a href="#问题处理" class="headerlink" title="问题处理"></a>问题处理</h2><p><strong>一个注意点</strong></p>
<p>zk启动（下面这种方式是不正确的，要自己去安装zk，用kafka自带zk会出错）</p>
<p><code>bin\windows\zookeeper-server-start.bat config\zookeeper.properties</code></p>
<p>kafka启动</p>
<p><code>bin\windows\kafka-server-start.bat config\server.properties</code></p>
<blockquote>
<p>我发现一个问题，在windows平台使用kafka_2.12-2.1.0的时候，不能使用kafka自带的zookeeper，需要自行安装zk并启动。</p>
</blockquote>
<p>为什么突然间kafka就不能正常地进行消息的生产与消费？</p>
<p>我决定重装zookeeper和Kafka，创建了一个新的Topic “test”</p>
<p><code>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181/kafka --replication-factor 1 --partitions 1 --topic test</code></p>
<blockquote>
<p>zookeeperh后面的地址是Kafka在bin/server.properties中配置的。这里多了 /kafka，一定要注意。</p>
</blockquote>
<p>接下来就使用了命令行测试是否能够正常的生产和消费消息。==It’s OK==</p>
<p>==<a href="https://blog.csdn.net/tianmanchn/article/details/78943147" target="_blank" rel="noopener">Kafka安装详细过程，无错误</a>==</p>
<h2 id="消费者客户端代码"><a href="#消费者客户端代码" class="headerlink" title="消费者客户端代码"></a>消费者客户端代码</h2><p>现在测试客户端，依然可以正常的收发消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">topic =test, partition = <span class="number">0</span>, offset =<span class="number">17</span></span><br><span class="line">key =<span class="keyword">null</span>,value =Hello,Kafka</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerFastStart</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String brokerList = <span class="string">"127.0.0.1:9092"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String topic = <span class="string">"test"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String groupId = <span class="string">"group.demo"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Properties <span class="title">initConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Kafka的配置参数很多，根据业务需要灵活调整</span></span><br><span class="line">        properties.put(<span class="string">"key.deserializer"</span>,</span><br><span class="line">                <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        properties.put(<span class="string">"value.deserializer"</span>,</span><br><span class="line">                <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        <span class="comment">// 设置要连接到Kafka集群的broker清单，一般建议设置2个，防止其中一个broker宕机后，消费者仍然能够连接到Kafka集群</span></span><br><span class="line">        properties.put(<span class="string">"bootstrap.servers"</span>, brokerList);</span><br><span class="line">        <span class="comment">//设置消费组的名称 ,一般要表明业务</span></span><br><span class="line">        properties.put(<span class="string">"group.id"</span>, groupId);</span><br><span class="line">        properties.put(<span class="string">"client.id"</span>, <span class="string">"consumer.client.id.demo"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Properties props = initConfig();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建消费者实例</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(props);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 订阅一个主题</span></span><br><span class="line">        consumer.subscribe(Arrays.asList(topic));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环消费信息</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"topic ="</span> + record.topic() +</span><br><span class="line">                        <span class="string">", partition = "</span> + record.partition() +</span><br><span class="line">                        <span class="string">", offset ="</span> + record.offset());</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"key ="</span> + record.key() +</span><br><span class="line">                        <span class="string">",value ="</span> + record.value());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="订阅某些主题的特定分区"><a href="#订阅某些主题的特定分区" class="headerlink" title="订阅某些主题的特定分区"></a>订阅某些主题的特定分区</h2><p>API : <code>KafkaConsumer#assign(Collection&lt;TopicPartition&gt; partitions)</code></p>
<h3 id="TopicPartition"><a href="#TopicPartition" class="headerlink" title="TopicPartition"></a>TopicPartition</h3><p>看下方法的成员变量中的<code>TopicPartition</code>,它在客户端表示分区。重点在于主题与分区之间的映射关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicPartition</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> hash = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> partition;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String topic;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TopicPartition</span><span class="params">(String topic, <span class="keyword">int</span> partition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.partition = partition;</span><br><span class="line">        <span class="keyword">this</span>.topic = topic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> partition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">topic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> topic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略hashCode(),equals(),toString()方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>TopicPartition</code>让我们看到了主题topic和分区partition之间的映射关系</p>
</blockquote>
<p><code>consumer.assign(Arrays.asList(new TopicPartition(&quot;test&quot;, 0)));</code></p>
<blockquote>
<p>订阅test主题下的0分区</p>
</blockquote>
<p><code>Arrays.asList()</code>就是将多个对象放进一个新的ArrayList中。相当于：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;TopicPartition&gt; list=<span class="keyword">new</span> ArrayList();</span><br><span class="line">list.add(<span class="keyword">new</span> TopicPartition(<span class="string">"test"</span>, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>
<h3 id="PartitionInfo"><a href="#PartitionInfo" class="headerlink" title="PartitionInfo"></a>PartitionInfo</h3><p>但是实际场景，我们可能不清楚某个主题到底有多少个分区。那么我们可以通过如下方法来获取某个主题下的分区</p>
<p> <code>List&lt;PartitionInfo&gt; partitionInfoList =consumer.partitionsFor(&quot;test&quot;);</code></p>
<p><code>PartitionInfo</code>为主题的分区元数据信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PartitionInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String topic; <span class="comment">//主题名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> partition; <span class="comment">// 分区编号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node leader; <span class="comment">// 分区的leader副本所在位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node[] replicas; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node[] inSyncReplicas;</span><br><span class="line">	<span class="comment">// 省略了方法   </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Node</code>类主要参数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Node NO_NODE = <span class="keyword">new</span> Node(-<span class="number">1</span>, <span class="string">""</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String idString;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String rack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="订阅某主题下所有分区"><a href="#订阅某主题下所有分区" class="headerlink" title="订阅某主题下所有分区"></a>订阅某主题下所有分区</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">		       </span><br><span class="line">List&lt;TopicPartition&gt; topicPartitionList = <span class="keyword">new</span> ArrayList&lt;TopicPartition&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取某主题下所有分区的信息</span></span><br><span class="line">      List&lt;PartitionInfo&gt; partitionInfoList = consumer.partitionsFor(topic);</span><br><span class="line"><span class="keyword">if</span> (partitionInfoList == <span class="keyword">null</span> || partitionInfoList.size()==<span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (PartitionInfo partitionInfo : partitionInfoList) &#123;</span><br><span class="line"></span><br><span class="line">          topicPartitionList.add(<span class="keyword">new</span> TopicPartition(partitionInfo.topic(), 			              partitionInfo.partition()));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 订阅主题的全部分区</span></span><br><span class="line">      consumer.assign(topicPartitionList);</span><br></pre></td></tr></table></figure>
<h2 id="取消订阅"><a href="#取消订阅" class="headerlink" title="取消订阅"></a>取消订阅</h2><p>取消订阅，就是在之前订阅的基础上取消订阅关系。就是清空订阅关系。</p>
<p><code>consumer.unsubscribe()</code></p>
<p><code>consumer.unsubscribe()</code></p>
<p>其实取消订阅就相当于订阅了空的主题。</p>
<p><code>consumer.subscribe(new ArraList&lt;String&gt;())</code></p>
<h2 id="订阅总结"><a href="#订阅总结" class="headerlink" title="订阅总结"></a>订阅总结</h2><p>其实我们<code>subscribe()</code>订阅一个主题，而不是某个主题的特定分区时，Kafka集群会分配消费者与分区之间的关系。这是一个动态的过程。有点类似于负载均衡。</p>
<p>而<code>align()</code>方法时没有这个功能的，它本身也不需要这个功能。</p>
<h1 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h1><p>我们收到的消息，只有经过反序列化才能正确读取。</p>
<p>先实现之前的序列化器</p>
<ol>
<li><p>需要传递的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ajin.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产者传递到消费者的消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ajin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Company</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">4606513799375884096L</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line">    <span class="keyword">private</span> String position;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Company</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Company</span><span class="params">(String companyName, String position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.companyName = companyName;</span><br><span class="line">        <span class="keyword">this</span>.position = position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCompanyName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> companyName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompanyName</span><span class="params">(String companyName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.companyName = companyName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPosition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPosition</span><span class="params">(String position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.position = position;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>序列化器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ajin.serilaizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ajin.domain.Company;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义序列化器 &#123;<span class="doctag">@link</span> org.apache.kafka.common.serialization.Serializer&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ajin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompanySerializer</span> <span class="keyword">implements</span> <span class="title">Serializer</span>&lt;<span class="title">Company</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs, <span class="keyword">boolean</span> isKey)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(String topic, Company data) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] name, position;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data.getCompanyName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                name = data.getCompanyName().getBytes();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                name = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (data.getPosition() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                position = data.getPosition().getBytes();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                position = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocate(<span class="number">4</span> + <span class="number">4</span> +</span><br><span class="line">                    name.length + position.length);</span><br><span class="line"></span><br><span class="line">            buffer.putInt(name.length);</span><br><span class="line">            buffer.put(name);</span><br><span class="line"></span><br><span class="line">            buffer.putInt(position.length);</span><br><span class="line">            buffer.put(position);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> buffer.array();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ByteBuffer ：字节缓冲区</p>
</blockquote>
</li>
<li><p>反序列化器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ajin.deserilaizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ajin.domain.Company;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Deserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义的反序列化器 &#123;<span class="doctag">@link</span> org.apache.kafka.common.serialization.Deserializer&#125;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 与序列化器 &#123;<span class="doctag">@link</span> com.ajin.serilaizer.CompanySerializer&#125;对应</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ajin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompanyDeSerializer</span> <span class="keyword">implements</span> <span class="title">Deserializer</span>&lt;<span class="title">Company</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENCODING = <span class="string">"UTF-8"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs, <span class="keyword">boolean</span> isKey)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Company <span class="title">deserialize</span><span class="params">(String topic, <span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (data.length &lt; <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"data is not expected"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.wrap(data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备好接收参数</span></span><br><span class="line">        <span class="keyword">int</span> nameLen, positionLen;</span><br><span class="line">        String name, position;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在此缓冲区的当前位置读取接下来的四个字节</span></span><br><span class="line">        nameLen = buffer.getInt();</span><br><span class="line">        <span class="keyword">byte</span>[] nameBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[nameLen];</span><br><span class="line">        <span class="comment">//字节从此缓冲区传输到给定的目标数组</span></span><br><span class="line">        buffer.get(nameBytes);</span><br><span class="line"></span><br><span class="line">        positionLen = buffer.getInt();</span><br><span class="line">        <span class="keyword">byte</span>[] positionBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[positionLen];</span><br><span class="line">        buffer.get(positionBytes);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            name = <span class="keyword">new</span> String(nameBytes, ENCODING);</span><br><span class="line">            position = <span class="keyword">new</span> String(positionBytes, ENCODING);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Company(name, position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>厮大的建议：不要使用自定义的序列化或反序列化器。这样会增加生产者与消费者之间的耦合。</p>
<p>如果需要自定义，可以使用fastjson等工具来辅助编码。</p>
</blockquote>
<h1 id="消息消费模式"><a href="#消息消费模式" class="headerlink" title="消息消费模式"></a>消息消费模式</h1><p>Kafka中的消息消费，是消费者主动从服务端拉取消息，属于拉模式。</p>
<p>我们每次消费，需要根据上一次消费的位移来继续消费消息。就相当于看书一样，从上一次看过的地方往后继续看。这个消费位移不能直接存在内存中，需要做持久化处理。</p>
<blockquote>
<p>在旧消费者客户端中，消费位移是存储在 ZooKeeper 中的 。 而在新消费者客户端中，消费<br>位移存储在 Kafka 内部的主题 consumer offsets 中 。 这里把将消费位移存储起来（持久化）的<br>动作称为“提交“，消费者在消费完消息之后需要执行消费位移的提交。 </p>
</blockquote>
<p>消费者提交的位移是下一次需要消费的信息的位置。</p>
<h1 id="位移提交"><a href="#位移提交" class="headerlink" title="位移提交"></a>位移提交</h1><p>自动的位移提交是在poll方法拉取消息之后进行的，拉取完消息后，如果消费者挂了，那么它重启后会消费下面的消息，而不会继续消费上次宕机时没处理完的消息。这就是消息丢失的情形。</p>
<p>我们需要设置为手动提交位移，这样更能保证消息消费的完整性与准确性。</p>
<h1 id="再均衡"><a href="#再均衡" class="headerlink" title="再均衡"></a>再均衡</h1><blockquote>
<p>再均衡是指分区的所属权从一个消费者转移到另一消费者的行为，它为消费组具备高可用性和伸缩性提供保障，使我们可以既方便又安全地删除消费组内的消费者或往消费组内添加消费者。</p>
</blockquote>
<p>不过在再均衡发生期间，消费组内的消费者是无法读取消息的。 也就是说，在再均衡发生期间的这一小段时间 内，消费组会变得不可用 。</p>
<p>另外，当一个分区被重新分配给另一个消费者时， 消费者当前的状态也会丢失。比如消费者消费完某个分区中的一部分消息时还没有来得及提交消费位移就发生了再均衡操作 ，之后这个分区又被分配给了消费组内的另一个消费者，原来被消费完的那部分消息又被重新消费一遍，也就是发生了重复消费。一般情况下，应尽量避免不必要的再均衡的发生。</p>
<h2 id="ConsumerRebalanceListener"><a href="#ConsumerRebalanceListener" class="headerlink" title="ConsumerRebalanceListener"></a>ConsumerRebalanceListener</h2><p><strong>再均衡监听器</strong></p>
<p>我们<code>asign</code>方法直接订阅的某个Topic下的分区，那么它不适用于<code>ConsumerRebalanceListener</code> 。</p>
<p>在<code>subscribe()</code>方法中可以看到<code>ConsumerRebalanceListener</code> 的影子</p>
<blockquote>
<p>再均衡监昕器用来设定发生再均衡动作前后的一些准备或收尾的动作。 </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Collection&lt;String&gt; topics, ConsumerRebalanceListener listener)</span> </span>&#123;</span><br><span class="line">    acquire();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (topics.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// treat subscribing to empty topic list as the same as unsubscribing</span></span><br><span class="line">            <span class="keyword">this</span>.unsubscribe();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">"Subscribed to topic(s): &#123;&#125;"</span>, Utils.join(topics, <span class="string">", "</span>));</span><br><span class="line">            <span class="keyword">this</span>.subscriptions.subscribe(topics, listener);</span><br><span class="line">            metadata.setTopics(subscriptions.groupSubscription());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">	<span class="comment">// 这个是正则表达式实现的模糊主题的匹配</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Pattern pattern, ConsumerRebalanceListener listener)</span> </span>&#123;</span><br><span class="line">        acquire();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">"Subscribed to pattern: &#123;&#125;"</span>, pattern);</span><br><span class="line">            <span class="keyword">this</span>.subscriptions.subscribe(pattern, listener);</span><br><span class="line">            <span class="keyword">this</span>.metadata.needMetadataForAllTopics(<span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们看一下<code>ConsumerRebalanceListener</code> 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConsumerRebalanceListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 这个方法会在再均衡开始之前和消费者停止读取消息之后被调用。可以通过这个回调方法</span></span><br><span class="line"><span class="comment"> 来处理消费位移的提交，以此来避免一些不必要的重复消费现象的发生。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	参数 partitions 表示再均衡前所分配到的分区。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPartitionsRevoked</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span></span>;</span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">这个方法会在重新分配分区之后和消费者开始读取消费之前被调用。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	参数partitions表示再均衡后所分配到的分区 。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPartitionsAssigned</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 定义主题分区与该消费者应用程序对应的提交位移的映射关系</span></span><br><span class="line">      <span class="keyword">final</span> Map&lt;TopicPartition, OffsetAndMetadata&gt; currentOffSets = <span class="keyword">new</span> HashMap&lt;TopicPartition, OffsetAndMetadata&gt;();</span><br><span class="line">      consumer.subscribe(Collections.singletonList(topic),</span><br><span class="line">              <span class="keyword">new</span> ConsumerRebalanceListener() &#123;</span><br><span class="line">                  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPartitionsRevoked</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;			</span><br><span class="line">                      <span class="comment">// 发生再均衡的时候，提交当前消费者的位移</span></span><br><span class="line">                      consumer.commitSync(currentOffSets);</span><br><span class="line">                      <span class="comment">// 清空映射关系 ，因为已经取做再均衡了</span></span><br><span class="line">                      currentOffSets.clear();</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPartitionsAssigned</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;);</span><br><span class="line"></span><br><span class="line">     		 <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">          ConsumerRecords&lt;String, Company&gt; records = consumer.poll(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (ConsumerRecord&lt;String, Company&gt; record : records) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">              currentOffSets.put(</span><br><span class="line">                      <span class="keyword">new</span> TopicPartition(</span><br><span class="line">                              record.topic(), record.partition()</span><br><span class="line">                      ), <span class="keyword">new</span> OffsetAndMetadata(record.offset() + <span class="number">1</span>)</span><br><span class="line">              );</span><br><span class="line">              System.out.println(<span class="string">"topic ="</span> + record.topic() +</span><br><span class="line">                      <span class="string">", partition ="</span> + record.partition() +</span><br><span class="line">                      <span class="string">", offset ="</span> + record.offset());</span><br><span class="line"></span><br><span class="line">              System.out.println(<span class="string">"key ="</span> + record.key() +</span><br><span class="line">                      <span class="string">",value ="</span> + record.value());</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h1 id="多线程实现"><a href="#多线程实现" class="headerlink" title="多线程实现"></a>多线程实现</h1><p>消费者每次拉取消息的时候，会判断是否只有一个线程在操作。如果有多个线程就会抛出异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConsumerRecords&lt;K, V&gt; <span class="title">poll</span><span class="params">(<span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">    acquire();</span><br><span class="line">    <span class="comment">// 省略其他方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Kafka是非线程安全的。</p>
<p>我们可以开启多个线程增强一个消费者客户端的消费能力。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/04/29/Ribbon源码学习/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/29/Ribbon源码学习/" itemprop="url">Ribbon源码学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-29T09:23:01+08:00">
                2019-04-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>​    学习Ribbon和客户端负载均衡之后，对Ribbon基本会使用了，但是还是想深入了解下Ribbon是如何实现负载均衡，怎么去通过从注册中心Eureka Server拉取到的服务提供者信息去进行调用某一服务的某一个实例的。所以就决定学习下Ribbon的相关源码，以此达到更深入地理解Ribbon。</p>
<blockquote>
<p>注：本篇源码基于Spring Cloud Edgware.SR5版本</p>
</blockquote>
<h1 id="Spring-Cloud-Netflix-Ribbon-核⼼接⼝"><a href="#Spring-Cloud-Netflix-Ribbon-核⼼接⼝" class="headerlink" title="Spring Cloud Netflix Ribbon 核⼼接⼝"></a>Spring Cloud Netflix Ribbon 核⼼接⼝</h1><h2 id="负载均衡器客户端"><a href="#负载均衡器客户端" class="headerlink" title="负载均衡器客户端"></a>负载均衡器客户端</h2><p><strong><code>LoadBalanceClient</code></strong></p>
<p>主要职责：</p>
<ul>
<li>转化URI：将含应用名称URI转化成主机+端口号的形式</li>
<li>选择服务实例：通过负载算法。选择指定服务中的某一台实例</li>
<li>请求执行回调：针对选择后服务实例，执行具体的请求回调操作</li>
</ul>
<p>默认实现：<code>RibbonLoadBalancerClient</code></p>
<p>⾃动装配源： <code>RibbonAutoConfiguration#loadBalancerClient()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoadBalancerClient</span> <span class="keyword">extends</span> <span class="title">ServiceInstanceChooser</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	&lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, LoadBalancerRequest&lt;T&gt; request)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest&lt;T&gt; request)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用真实主机和端口创建适当的URI以供系统使用</span></span><br><span class="line">	<span class="function">URI <span class="title">reconstructURI</span><span class="params">(ServiceInstance instance, URI original)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="转化URI"><a href="#转化URI" class="headerlink" title="转化URI"></a>转化URI</h3><p>将含应用名称URI转化成ip+port的形式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">restTemplate.postForObject(<span class="string">"http://"</span> +</span><br><span class="line">                        serviceProviderName + <span class="string">"/greeting"</span>,</span><br><span class="line">                <span class="keyword">new</span> User(<span class="number">2</span>, <span class="string">"wwww"</span>),</span><br><span class="line">                String.class);</span><br></pre></td></tr></table></figure>
<p>我们需要将<code>RestTemplate#postForObject()</code>第一个参数，转化成具体的URI，例如：<a href="http://localhost:9090/greeting的形式。" target="_blank" rel="noopener">http://localhost:9090/greeting的形式。</a></p>
<blockquote>
<p>为什么这个URI转化过程是通过<code>LoadBalanceClient</code>的实现类来完成的，debug过程中貌似没进<code>LoadBalanceClient</code>里面去。</p>
</blockquote>
<h3 id="选择服务实例"><a href="#选择服务实例" class="headerlink" title="选择服务实例"></a>选择服务实例</h3><blockquote>
<p>如果一个服务由多个实例，（事实上生产环境为了高可用，是不可能但实力运行的），我们怎么去选择其中一个服务实例去调用呢？由什么负载算法吗？就一定按照算法来做吗？有没有特殊情况？</p>
</blockquote>
<h3 id="请求执行回调"><a href="#请求执行回调" class="headerlink" title="请求执行回调"></a>请求执行回调</h3><p>​    选择完服务对应的实例后，就需要去执行请求回调工作。</p>
<h2 id="负载均衡器上下文"><a href="#负载均衡器上下文" class="headerlink" title="负载均衡器上下文"></a>负载均衡器上下文</h2><p><code>LoadBalancerContext</code></p>
<p><strong>默认实现</strong>： <code>RibbonLoadBalancerContext</code></p>
<p><code>RibbonLoadBalancerContext</code>是<code>LoadBalancerContext</code>的子类，它的全部方法都是来自于父类，这样设计我觉得没有什么意义。</p>
<p>主要职责</p>
<ul>
<li><p>转化 URI：将含应⽤名称URI 转化成具体主机+端⼝的形式</p>
</li>
<li><p>组件关联：关联 <code>RetryHandler</code>、 <code>ILoadBalancer</code> 等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.netflix.ribbon.RibbonLoadBalancerContext</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RibbonLoadBalancerContext</span><span class="params">(ILoadBalancer lb, IClientConfig clientConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">		RetryHandler handler)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(lb, clientConfig, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  这里顺着<code>RibbonLoadBalancerContext</code>的构造器，看到了<code>RetryHandler</code>接口。</p>
<blockquote>
<p>确定负载均衡器是否可以重试异常的处理程序，<em>以及是否应将异常或错误响应视为与电路相关的故障</em>，以便负载均衡器可以避免此类服务器。</p>
</blockquote>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// com.netflix.client.RetryHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RetryHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RetryHandler DEFAULT = <span class="keyword">new</span> DefaultLoadBalancerRetryHandler();</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">// 测试负载均衡器的异常是否可重试</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRetriableException</span><span class="params">(Throwable e, <span class="keyword">boolean</span> sameServer)</span></span>;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 测试是否应将异常视为电路故障</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCircuitTrippingException</span><span class="params">(Throwable e)</span></span>;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 在一台服务器上完成的最大重试次数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxRetriesOnSameServer</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   	<span class="comment">// 要重试的最大不同服务器数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxRetriesOnNextServer</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这让我联想到Kafka中为了高可用，让消息生产者发消息给broker，然后如果消息发送产生异常，生产者需要重试，重新发送信息。也有可能这个异常，我重试也无法恢复，那就直接抛出异常了，因为重试也没用成功发送的可能。</p>
<p>然后我们设置发送成功的标准是一个分区leader和其他follower都接收到了数据，才算发送成功。这样就能维持一个高可用。</p>
</blockquote>
<ul>
<li><p>记录服务统计信息：记录请求相应时间、错误数量等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.netflix.ribbon.RibbonLoadBalancerContext</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noteOpenConnection</span><span class="params">(ServerStats serverStats)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.noteOpenConnection(serverStats);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Timer <span class="title">getExecuteTracer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.getExecuteTracer();</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noteRequestCompletion</span><span class="params">(ServerStats stats, Object response, Throwable e,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">long</span> responseTime)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.noteRequestCompletion(stats, response, e, responseTime);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noteRequestCompletion</span><span class="params">(ServerStats stats, Object response, Throwable e,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">long</span> responseTime, RetryHandler errorHandler)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.noteRequestCompletion(stats, response, e, responseTime, errorHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这些方法主要是对请求时间，异常错误信息等等进行统计。然后信息交给<code>ServerStats</code>来处理，比如下面的代码：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.netflix.loadbalancer.ServerStats</span></span><br><span class="line"><span class="meta">@Monitor</span>(name = <span class="string">"OverallResponseTimeMillisAvg"</span>, type = DataSourceType.INFORMATIONAL,</span><br><span class="line">             description = <span class="string">"Average total time for a request, in milliseconds"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getResponseTimeAvg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> responseTimeDist.getMean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>⾃动装配源： <code>RibbonClientConfiguration#ribbonLoadBalancerContext(…)</code> </p>
<h2 id="负载均衡器"><a href="#负载均衡器" class="headerlink" title="负载均衡器"></a>负载均衡器</h2><p><code>ILoadBalancer</code> </p>
<p><strong>主要职责</strong></p>
<ul>
<li>增加服务器</li>
<li>获取服务器：通过关联 Key 获取、获取所有服务列表、获取可⽤服务器列表</li>
<li>服务器状态：标记服务器宕机</li>
</ul>
<blockquote>
<p>默认实现： <code>ZoneAwareLoadBalancer</code></p>
</blockquote>
<p> ⾃动装配源： <code>RibbonClientConfiguration#ribbonLoadBalancer(…)</code> </p>
<p>我们看一下<code>ILoadBalancer</code> `接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILoadBalancer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化服务器列表；也可以在后续进行服务器的添加</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServers</span><span class="params">(List&lt;Server&gt; newServers)</span></span>;</span><br><span class="line">    <span class="comment">// 从负载均衡器中选择服务器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">chooseServer</span><span class="params">(Object key)</span></span>;</span><br><span class="line">    <span class="comment">// 标记服务器Down</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markServerDown</span><span class="params">(Server server)</span></span>;</span><br><span class="line">    <span class="comment">// 获取启动并且可访问的服务器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Server&gt; <span class="title">getReachableServers</span><span class="params">()</span></span>;</span><br><span class="line">     <span class="comment">// 获取所有的服务器，包含可访问和不可访问的  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Server&gt; <span class="title">getAllServers</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有一个废弃方法，直接忽略。</p>
</blockquote>
<h2 id="三者总结"><a href="#三者总结" class="headerlink" title="三者总结"></a>三者总结</h2><p>负载均衡器客户端主要是执行者，而负载均衡器上下文是贯彻整个执行过程的，负载均衡器主要是维护服务器状态的。</p>
<h2 id="规则接口"><a href="#规则接口" class="headerlink" title="规则接口"></a>规则接口</h2><p><code>IRule</code></p>
<p> <strong>主要职责</strong></p>
<ul>
<li><p>选择服务器：根据负载均衡器以及关联Key 获取候选的服务器</p>
<blockquote>
<p>我们之前说负载均衡器客户端去选择服务实例，就是调用<code>IRule</code>接口来完成的。</p>
</blockquote>
</li>
<li><p>默认实现： <code>ZoneAvoidanceRule</code></p>
</li>
<li><p>⾃动装配源： <code>RibbonClientConfiguration#ribbonRule(…)</code> </p>
</li>
</ul>
<ul>
<li>随机规则：RandomRule</li>
</ul>
<ul>
<li>最可用规则：BestAvailableRule</li>
<li>轮训规则：RoundRobinRule</li>
<li>重试实现：RetryRule</li>
<li>客户端配置：ClientConfigEnabledRoundRobinRule</li>
<li>可用性过滤规则：AvailabilityFilteringRule</li>
<li>RT权重规则：WeightedResponseTimeRule</li>
<li>规避区域规则：ZoneAvoidanceRule</li>
</ul>
<h2 id="Ping策略"><a href="#Ping策略" class="headerlink" title="Ping策略"></a>Ping策略</h2><p><code>IPing</code></p>
<p> 主要职责</p>
<ul>
<li>活动检测：根据指定的服务器，检测其是否活动<blockquote>
<p>默认实现： <code>DummyPing</code></p>
</blockquote>
</li>
</ul>
<p>⾃动装配源： <code>RibbonClientConfiguration#ribbonPing(…)</code> </p>
<h2 id="服务器列表"><a href="#服务器列表" class="headerlink" title="服务器列表"></a>服务器列表</h2><p><code>ServerList</code></p>
<p><strong>主要职责</strong></p>
<ul>
<li><p>获取初始化服务器列表</p>
</li>
<li><p>获取更新服务器列表</p>
</li>
</ul>
<p>默认实现： <code>ConfigurationBasedServerList</code> 或 <code>DiscoveryEnabledNIWSServerList</code> </p>
<p>⾃动装配源： <code>RibbonClientConfiguration</code> </p>
<h1 id="Netflix-Ribbon-⾃动装配"><a href="#Netflix-Ribbon-⾃动装配" class="headerlink" title="Netflix Ribbon ⾃动装配"></a>Netflix Ribbon ⾃动装配</h1><ul>
<li><p><code>RibbonAutoConfiguration</code></p>
<ul>
<li><p><code>LoadBalancerClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(LoadBalancerClient.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> LoadBalancerClient <span class="title">loadBalancerClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> RibbonLoadBalancerClient(springClientFactory());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>  &gt; 你可以自己定制一些bean，然后交给IoC容器，然后我这边就不再new了，这是利用了条件装配的特性。
  &gt;
  &gt; 如果我们的application.properties/application.yml文件有了一些配置项，Spring Boot就会利用条件装配的特性，就加载我们的配置项，而不加载默认的配置项。
  &gt;
  &gt; @EnableAutoConfiguration这个注解就是去加载那些自动配置项，这里自然包含条件装配，我们可以覆盖默认配置，通过动态代理形成一个Java Config配置类。
  &gt;
  &gt; 这里解释了什么是约定优于配置的核心原理。
  &gt;
  &gt; 我们的自动配置，就会说，我有这个比如说 server.port配置，你那边别整了；或者我自定义了一个bean，你框架别帮我自动加载了。请忽略框架你自己的代码，用我程序员的自定义bean。

+ `PropertiesFactory`

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PropertiesFactory <span class="title">propertiesFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PropertiesFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PropertiesFactory</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PropertiesFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		classToProperty.put(ILoadBalancer.class, <span class="string">"NFLoadBalancerClassName"</span>);</span><br><span class="line">		classToProperty.put(IPing.class, <span class="string">"NFLoadBalancerPingClassName"</span>);</span><br><span class="line">		classToProperty.put(IRule.class, <span class="string">"NFLoadBalancerRuleClassName"</span>);</span><br><span class="line">		classToProperty.put(ServerList.class, <span class="string">"NIWSServerListClassName"</span>);</span><br><span class="line">		classToProperty.put(ServerListFilter.class, <span class="string">"NIWSServerListFilterClassName"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>


  &gt; 这个构造器说明，PropertiesFactory对ILoadBalancer等bean在内存中进行了一份缓存。
</code></pre><ul>
<li><p><code>LoadBalancerAutoConfiguration</code></p>
<ul>
<li><code>@LoadBalanced</code></li>
<li><code>RestTemplate</code> </li>
</ul>
</li>
<li><p><code>RibbonClientConfiguration</code></p>
<ul>
<li>LoadBalancerContext</li>
</ul>
<ul>
<li><p>IRule</p>
</li>
<li><p>IPing</p>
</li>
<li><p>ServerList</p>
<ul>
<li>ILoadBalancer</li>
</ul>
</li>
<li><p>IClientConfig </p>
<p><code>org.springframework.cloud.netflix.ribbon.RibbonClientConfiguration</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IClientConfig <span class="title">ribbonClientConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	DefaultClientConfigImpl config = <span class="keyword">new</span> DefaultClientConfigImpl();</span><br><span class="line">	config.loadProperties(<span class="keyword">this</span>.name);</span><br><span class="line">	config.set(CommonClientConfigKey.ConnectTimeout, DEFAULT_CONNECT_TIMEOUT);</span><br><span class="line">	config.set(CommonClientConfigKey.ReadTimeout, DEFAULT_READ_TIMEOUT);</span><br><span class="line">	<span class="keyword">return</span> config;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IRule <span class="title">ribbonRule</span><span class="params">(IClientConfig config)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.propertiesFactory.isSet(IRule.class, name)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.propertiesFactory.get(IRule.class, config, name);</span><br><span class="line">	&#125;</span><br><span class="line">	ZoneAvoidanceRule rule = <span class="keyword">new</span> ZoneAvoidanceRule();</span><br><span class="line">	rule.initWithNiwsConfig(config);</span><br><span class="line">	<span class="keyword">return</span> rule;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IPing <span class="title">ribbonPing</span><span class="params">(IClientConfig config)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.propertiesFactory.isSet(IPing.class, name)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.propertiesFactory.get(IPing.class, config, name);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> DummyPing();</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ServerList&lt;Server&gt; <span class="title">ribbonServerList</span><span class="params">(IClientConfig config)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.propertiesFactory.isSet(ServerList.class, name)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.propertiesFactory.get(ServerList.class, config, name);</span><br><span class="line">	&#125;</span><br><span class="line">	ConfigurationBasedServerList serverList = <span class="keyword">new</span> ConfigurationBasedServerList();</span><br><span class="line">	serverList.initWithNiwsConfig(config);</span><br><span class="line">	<span class="keyword">return</span> serverList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ILoadBalancer <span class="title">ribbonLoadBalancer</span><span class="params">(IClientConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">		ServerList&lt;Server&gt; serverList, ServerListFilter&lt;Server&gt; serverListFilter,</span></span></span><br><span class="line"><span class="function"><span class="params">		IRule rule, IPing ping, ServerListUpdater serverListUpdater)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.propertiesFactory.isSet(ILoadBalancer.class, name)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.propertiesFactory.get(ILoadBalancer.class, config, name);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ZoneAwareLoadBalancer&lt;&gt;(config, rule, ping, serverList,</span><br><span class="line">			serverListFilter, serverListUpdater);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RibbonLoadBalancerContext <span class="title">ribbonLoadBalancerContext</span><span class="params">(ILoadBalancer loadBalancer,</span></span></span><br><span class="line"><span class="function"><span class="params">		IClientConfig config, RetryHandler retryHandler)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> RibbonLoadBalancerContext(loadBalancer, config, retryHandler);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RetryHandler <span class="title">retryHandler</span><span class="params">(IClientConfig config)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> DefaultLoadBalancerRetryHandler(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>条件装配，一目了然</p>
</blockquote>
<h1 id="分析调用链路"><a href="#分析调用链路" class="headerlink" title="分析调用链路"></a>分析调用链路</h1><h2 id="选择服务器逻辑"><a href="#选择服务器逻辑" class="headerlink" title="选择服务器逻辑"></a>选择服务器逻辑</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">""</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setId(<span class="number">1L</span>);</span><br><span class="line">    user.setName(<span class="string">"ajin"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选择指定的 serviceId对应的一台服务实例，也就是一个ip+port+"......"</span></span><br><span class="line">    ServiceInstance serviceInstance = loadBalancerClient.choose(serviceProviderAppName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行服务</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loadBalancerClient.execute(serviceProviderAppName, serviceInstance, instance -&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 服务器实例，获取 主机名（IP) 和端口</span></span><br><span class="line">        String host = instance.getHost();</span><br><span class="line">        <span class="keyword">int</span> port = instance.getPort();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拼接请求url</span></span><br><span class="line">        String url = <span class="string">"http://"</span> + host + <span class="string">":"</span> + port + <span class="string">"/user/save"</span>;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(url, user, String.class);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ServiceInstance serviceInstance = loadBalancerClient.choose(serviceProviderAppName);</code></p>
<p><code>LoadBalancerClient</code>（LoadBalancerClient） -&gt; <code>ILoadBalancer</code>（ZoneAwareLoadBalancer） -&gt; <code>IRule</code>(ZoneAvoidanceRule)</p>
<blockquote>
<p>整个<code>LoadBalancerClient#choose()</code>选择指定一台服务器的逻辑，就是去从<code>ZoneAwareLoadBalancer</code>里去取服务器。</p>
</blockquote>
<p>我们看一下<code>ZoneAwareLoadBalancer#choose()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (zone != <span class="keyword">null</span>) &#123;</span><br><span class="line"> BaseLoadBalancer zoneLoadBalancer = getLoadBalancer(zone);</span><br><span class="line"> server = zoneLoadBalancer.chooseServer(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>再接着<code>zoneLoadBalancer.chooseServer(key)</code>找到负载均衡器，调用<code>chooseServer(key)</code></p>
</blockquote>
<p>go on to <code></code>chooseServer(key)`</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Server <span class="title">chooseServer</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (counter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            counter = createCounter();</span><br><span class="line">        &#125;</span><br><span class="line">        counter.increment();</span><br><span class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 这个不就是Rule吗？？？</span></span><br><span class="line">                <span class="keyword">return</span> rule.choose(key);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.warn(<span class="string">"LoadBalancer [&#123;&#125;]:  Error choosing server for key &#123;&#125;"</span>, name, key, e);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一目了然</p>
</blockquote>
<h3 id="自定义IRule"><a href="#自定义IRule" class="headerlink" title="自定义IRule"></a>自定义IRule</h3><p>我们可以自定义IRule来实现自定义的选择服务器的规则。我们自定义的规则，会覆盖掉框架默认的规则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义&#123;<span class="doctag">@link</span> com.netflix.loadbalancer.IRule&#125;实现</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ajin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/4/29 20:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRule</span> <span class="keyword">extends</span> <span class="title">AbstractLoadBalancerRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWithNiwsConfig</span><span class="params">(IClientConfig clientConfig)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">choose</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ILoadBalancer loadBalancer = getLoadBalancer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取所有可达服务器</span></span><br><span class="line">        List&lt;Server&gt; reachableServers = loadBalancer.getReachableServers();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(reachableServers==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 随机访问一台服务器</span></span><br><span class="line">        <span class="keyword">int</span> serverNum = reachableServers.size();</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">int</span> randomServerNum = random.nextInt(serverNum);</span><br><span class="line">        <span class="keyword">return</span> reachableServers.get(randomServerNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要将其暴露成bean交给IoC</p>
<blockquote>
<p>参考之前的自动装配</p>
</blockquote>
<p><code>org.springframework.cloud.netflix.ribbon.RibbonClientConfiguration</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IRule <span class="title">ribbonRule</span><span class="params">(IClientConfig config)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.propertiesFactory.isSet(IRule.class, name)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.propertiesFactory.get(IRule.class, config, name);</span><br><span class="line">	&#125;</span><br><span class="line">	ZoneAvoidanceRule rule = <span class="keyword">new</span> ZoneAvoidanceRule();</span><br><span class="line">	rule.initWithNiwsConfig(config);</span><br><span class="line">	<span class="keyword">return</span> rule;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们将自定义的或则MyRule暴露给Bean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将 &#123;<span class="doctag">@link</span> MyRule&#125;暴露给&#123;<span class="doctag">@link</span> Bean&#125;</span></span><br><span class="line"><span class="comment">   * */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IRule <span class="title">iRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MyRule();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过debug启动项目发现的确是我们的<code>MyRule</code>在起作用</p>
</blockquote>
<p><img src="https://liutianruo-2019-go-go-go.oss-cn-shanghai.aliyuncs.com/images/picture334.png" alt=""></p>
<h1 id="Netflix-Ribbon-配置化组件"><a href="#Netflix-Ribbon-配置化组件" class="headerlink" title="Netflix Ribbon 配置化组件"></a>Netflix Ribbon 配置化组件</h1><blockquote>
<p>通过学习<code>PropertiesFactory</code> 源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; 	<span class="function"><span class="keyword">public</span> <span class="title">PropertiesFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&gt; 		classToProperty.put(ILoadBalancer.class, <span class="string">"NFLoadBalancerClassName"</span>);</span><br><span class="line">&gt; 		classToProperty.put(IPing.class, <span class="string">"NFLoadBalancerPingClassName"</span>);</span><br><span class="line">&gt; 		classToProperty.put(IRule.class, <span class="string">"NFLoadBalancerRuleClassName"</span>);</span><br><span class="line">&gt; 		classToProperty.put(ServerList.class, <span class="string">"NIWSServerListClassName"</span>);</span><br><span class="line">&gt; 		classToProperty.put(ServerListFilter.class, <span class="string">"NIWSServerListFilterClassName"</span>);</span><br><span class="line">&gt; 	&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>可知<code>NFLoadBalancerClassName</code> 等是可以配置的</p>
</blockquote>
<h2 id="实现-IPing-MyPing"><a href="#实现-IPing-MyPing" class="headerlink" title="实现 IPing : MyPing"></a>实现 <code>IPing</code> : <code>MyPing</code></h2><p>我们浏览器地址栏输入：<a href="http://localhost:9090/health（服务提供方的health端口）返回：" target="_blank" rel="noopener">http://localhost:9090/health（服务提供方的health端口）返回：</a></p>
<blockquote>
<p>{</p>
<p><strong>status</strong>: “UP”</p>
<p>}</p>
</blockquote>
<p>所以说我们<code>MyPing</code>去ping一下这个地址，看状态码。这样就实现了对服务端的health check.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.segumentfault.spring.cloud.lesson7.user.ribbon.client.ping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.IPing;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.Server;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.util.UriComponentsBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现 &#123;<span class="doctag">@link</span> IPing&#125; 接口：检查对象 /health 是否正常状态码:200</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPing</span> <span class="keyword">implements</span> <span class="title">IPing</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAlive</span><span class="params">(Server server)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host = server.getHost();</span><br><span class="line">        <span class="keyword">int</span> port = server.getPort();</span><br><span class="line">        <span class="comment">// /health endpoint</span></span><br><span class="line">        <span class="comment">// 通过 Spring 组件来实现URL 拼装</span></span><br><span class="line">        UriComponentsBuilder builder = UriComponentsBuilder.newInstance();</span><br><span class="line">        builder.scheme(<span class="string">"http"</span>);</span><br><span class="line">        builder.host(host);</span><br><span class="line">        builder.port(port);</span><br><span class="line">        builder.path(<span class="string">"/health"</span>);</span><br><span class="line">        URI uri = builder.build().toUri();</span><br><span class="line"></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">        ResponseEntity responseEntity = restTemplate.getForEntity(uri, String.class);</span><br><span class="line">        <span class="comment">// 当响应状态等于 200 时，返回 true ，否则 false</span></span><br><span class="line">        <span class="keyword">return</span> HttpStatus.OK.equals(responseEntity.getStatusCode());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="增加配置"><a href="#增加配置" class="headerlink" title="增加配置"></a>增加配置</h2><p><code>application.properties</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## 扩展 IPing 实现</span><br><span class="line">user-service-provider.ribbon.NFLoadBalancerPingClassName = \</span><br><span class="line">  com.segumentfault.spring.cloud.lesson7.user.ribbon.client.ping.MyPing</span><br></pre></td></tr></table></figure>
<h1 id="条件装配的总结"><a href="#条件装配的总结" class="headerlink" title="条件装配的总结"></a>条件装配的总结</h1><p><code>@ConditionalOnBean</code>（仅仅在当前上下文中存在某个对象时，才会实例化一个Bean）<br><code>@ConditionalOnClass</code>（某个class位于类路径上，才会实例化一个Bean）<br><code>@ConditionalOnExpression</code>（当表达式为true的时候，才会实例化一个Bean）<br><code>@ConditionalOnMissingBean</code>（仅仅在当前上下文中不存在某个对象时，才会实例化一个Bean）</p>
<blockquote>
<p>只有在<code>BeanFactory</code>中未包含指定的bean类和/或名称时才匹配。</p>
</blockquote>
<p><code>@ConditionalOnMissingClass</code>（某个class类路径上不存在的时候，才会实例化一个Bean）<br><code>@ConditionalOnNotWebApplication</code>（不是web应用）</p>
<h1 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>@LoadBalanced</code>给Ribbon带来了什么?</strong></p>
<p>最核心的是<code>@LoadBalanced</code>调了最下面那个方法</p>
<p><code>// private LoadBalancerClient loadBalancer;</code></p>
<p><code>this.loadBalancer.execute(serviceName, requestFactory.createRequest(request, body, execution));</code></p>
<p>其实就是我们刚开始写的一个代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">	User user = <span class="keyword">new</span> User();</span><br><span class="line">     user.setId(<span class="number">1L</span>);</span><br><span class="line">     user.setName(<span class="string">"ajin"</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 选择指定的 serviceId对应的一台服务实例，也就是一个ip+port+"......"</span></span><br><span class="line">     ServiceInstance serviceInstance = loadBalancerClient.choose(serviceProviderAppName);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 执行服务</span></span><br><span class="line"><span class="comment">// @LoadBalanced</span></span><br><span class="line">     <span class="keyword">return</span> loadBalancerClient.execute(serviceProviderAppName, serviceInstance, instance -&gt; &#123;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 服务器实例，获取 主机名（IP) 和端口</span></span><br><span class="line">         String host = instance.getHost();</span><br><span class="line">         <span class="keyword">int</span> port = instance.getPort();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 拼接请求url</span></span><br><span class="line">         String url = <span class="string">"http://"</span> + host + <span class="string">":"</span> + port + <span class="string">"/user/save"</span>;</span><br><span class="line">         RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> restTemplate.postForObject(url, user, String.class);</span><br><span class="line">     &#125;);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/04/26/Hystrix学习与总结/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/26/Hystrix学习与总结/" itemprop="url">Hystrix学习与总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-26T14:12:36+08:00">
                2019-04-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>服务短路的概念是从家用电器中的短路演变而来。</p>
<blockquote>
<p>系统整体性保护</p>
</blockquote>
<p>相近的词：</p>
<p>服务容错：强调容忍错误，不至于整体故障</p>
<p>服务降级：强调服务非依赖项，不影响主要流程</p>
<blockquote>
<p>使用Spring Cloud的时候，一定要将Spring Cloud版本和Spring Boot的版本相对应。</p>
</blockquote>
<blockquote>
<p>学习Hystrix的过程中定义了一个多module的maven Project（Spring Cloud)，只要在项目中定义好Spring Boot和Spring Cloud的版本以及它的子module，然后各个module定义自己的Spring Cloud具体依赖关系 ，如ribbon等。</p>
<p>项目的pom.xml只定义公共部分，如Spring Boot和Spring Cloud的版本，和项目包含的module。</p>
</blockquote>
<h2 id="Hystrix-的设计原则"><a href="#Hystrix-的设计原则" class="headerlink" title="Hystrix 的设计原则"></a>Hystrix 的设计原则</h2><ul>
<li>对依赖服务调用时出现的调用延迟和调用失败进行<strong>控制和容错保护</strong>。</li>
<li>在复杂的分布式系统中，阻止某一个依赖服务的故障在整个系统中蔓延。比如某一个服务故障了，导致其它服务也跟着故障。</li>
<li>提供 <code>fail-fast</code>（快速失败）和快速恢复的支持。</li>
<li>提供 fallback 优雅降级的支持。</li>
<li>支持近实时的监控、报警以及运维操作。</li>
</ul>
<h2 id="Hystrix-更加细节的设计原则"><a href="#Hystrix-更加细节的设计原则" class="headerlink" title="Hystrix 更加细节的设计原则"></a>Hystrix 更加细节的设计原则</h2><ul>
<li>阻止任何一个依赖服务耗尽所有的资源，比如 tomcat 中的所有线程资源。</li>
<li>避免请求排队和积压，采用限流和 <code>fail fast</code> 来控制故障。</li>
<li>提供 fallback 降级机制来应对故障。</li>
<li>使用资源隔离技术，比如 <code>bulkhead</code>（舱壁隔离技术）、<code>swimlane</code>（泳道技术）、<code>circuit breaker</code>（断路技术）来限制任何一个依赖服务的故障的影响。</li>
<li>通过近实时的统计/监控/报警功能，来提高故障发现的速度。</li>
<li>通过近实时的属性和配置<strong>热修改</strong>功能，来提高故障处理和恢复的速度。</li>
<li>保护依赖服务调用的所有故障情况，而不仅仅只是网络故障情况。</li>
</ul>
<h1 id="Spring-Cloud-Hystrix-源码解读"><a href="#Spring-Cloud-Hystrix-源码解读" class="headerlink" title="Spring Cloud Hystrix 源码解读"></a>Spring Cloud Hystrix 源码解读</h1><h2 id="EnableCircuitBreaker"><a href="#EnableCircuitBreaker" class="headerlink" title="@EnableCircuitBreaker"></a><code>@EnableCircuitBreaker</code></h2><p>主要职责：</p>
<ul>
<li><p>激活服务短路能力</p>
</li>
<li><p>自动装配：<code>HystrixCircuitBreakerConfiguration</code> </p>
<blockquote>
<p>这个自动装配类是通过<code>SpringFactoriesLoader</code>在jar包下META-INF/spring.factories中找到的</p>
<p>E:\mavenRepository\org\springframework\cloud\spring-cloud-netflix-core\1.4.6.RELEASE\spring-cloud-netflix-core-1.4.6.RELEASE-sources.jar!\META-INF\spring.factories</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker=\</span><br><span class="line">org.springframework.cloud.netflix.hystrix.HystrixCircuitBreakerConfiguration</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>导⼊选择器： <code>EnableCircuitBreakerImportSelector</code></p>
<p>设计缺陷：覆盖默认实现 Hystrix 操作繁琐 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(EnableCircuitBreakerImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableCircuitBreaker &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看一下<code>EnableCircuitBreakerImportSelector.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(Ordered.LOWEST_PRECEDENCE - <span class="number">100</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableCircuitBreakerImportSelector</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">		<span class="title">SpringFactoryImportSelector</span>&lt;<span class="title">EnableCircuitBreaker</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RelaxedPropertyResolver(getEnvironment()).getProperty(</span><br><span class="line">				<span class="string">"spring.cloud.circuit.breaker.enabled"</span>, Boolean.class, Boolean.TRUE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化顺序"><a href="#初始化顺序" class="headerlink" title="初始化顺序"></a>初始化顺序</h3><ul>
<li><code>@EnableCircuitBreaker</code><ul>
<li><code>EnableCircuitBreakerImportSelector</code><ul>
<li><code>HystrixCircuitBreakerConfiguration</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="HystrixCircuitBreakerConfiguration"><a href="#HystrixCircuitBreakerConfiguration" class="headerlink" title="HystrixCircuitBreakerConfiguration"></a><code>HystrixCircuitBreakerConfiguration</code></h2><p>​    <strong>初始化组件</strong></p>
<ul>
<li><code>HystrixCommandAspect</code></li>
<li><code>HystrixShutdownHook</code></li>
<li><code>HystrixStreamEndpoint</code> ： Servlet </li>
<li><code>HystrixMetricsPollerConfiguration</code></li>
</ul>
<ul>
<li><p>Hystrix 命令切⾯： <code>HystrixCommandAspect</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HystrixCommandAspect <span class="title">hystrixCommandAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> HystrixCommandAspect();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>Hystrix Endpoint： <code>HystrixStreamEndpoint</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"hystrix.stream.endpoint.enabled"</span>, matchIfMissing = <span class="keyword">true</span>) <span class="comment">// 如果没配置hystrix.stream.endpoint.enabled，则默认值为true</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Endpoint.class, HystrixMetricsStreamServlet.class &#125;)</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixWebConfiguration</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> HystrixStreamEndpoint <span class="title">hystrixStreamEndpoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> HystrixStreamEndpoint();</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hystrix 指标： <code>HystrixMetricsPollerConfiguration</code> </p>
</li>
</ul>
<h1 id="Netflix-Hystrix-源码解读"><a href="#Netflix-Hystrix-源码解读" class="headerlink" title="Netflix Hystrix 源码解读"></a>Netflix Hystrix 源码解读</h1><h2 id="HystrixCommandAspect"><a href="#HystrixCommandAspect" class="headerlink" title="HystrixCommandAspect"></a>HystrixCommandAspect</h2><h3 id="依赖组件"><a href="#依赖组件" class="headerlink" title="依赖组件"></a>依赖组件</h3><ul>
<li><code>MetaHolderFactory</code></li>
<li><code>HystrixCommandFactory</code>: 生成<code>HystrixInvokable</code></li>
<li><code>HystrixInvokable</code></li>
<li><code>CommandCollapser</code></li>
<li><code>GenericObservableCommand</code></li>
<li><code>GenericCommand</code></li>
</ul>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><ul>
<li><p>拦截标注 <code>@HystrixCommand</code> 或 <code>@HystrixCollapser</code> 的⽅法（<code>@Around</code>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  	  <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand)"</span>)</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hystrixCommandAnnotationPointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">      <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.netflix.hystrix.contrib.javanica.annotation.HystrixCollapser)"</span>)</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hystrixCollapserAnnotationPointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Around</span>(<span class="string">"hystrixCommandAnnotationPointcut() || hystrixCollapserAnnotationPointcut()"</span>)</span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">methodsAnnotatedWithHystrixCommand</span><span class="params">(<span class="keyword">final</span> ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">          Method method = getMethodFromTarget(joinPoint);</span><br><span class="line">          </span><br><span class="line">      <span class="comment">// 省略其他部分源码</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>⽣成拦截⽅法原信息（<code>MetaHolderFactory</code>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MetaHolderFactory metaHolderFactory =META_HOLDER_FACTORY_MAP.get(HystrixPointcutType.of(method));</span><br><span class="line"></span><br><span class="line">MetaHolder metaHolder = metaHolderFactory.create(joinPoint); <span class="comment">// 模板方法，交给子类实现</span></span><br></pre></td></tr></table></figure>
<p><code>MetaHolderFactory</code>有两个具体的子类，分别对应<code>@HystrixCommand</code>和<code>@HystrixCollapser</code></p>
<blockquote>
<p>我们看下前者对应的<code>CommandMetaHolderFactory</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandMetaHolderFactory</span> <span class="keyword">extends</span> <span class="title">MetaHolderFactory</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 实现父类的模板方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MetaHolder <span class="title">create</span><span class="params">(Object proxy, Method method, Object obj, Object[] args, <span class="keyword">final</span> ProceedingJoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取HystrixCommand注解</span></span><br><span class="line">        HystrixCommand hystrixCommand = method.getAnnotation(HystrixCommand.class);</span><br><span class="line">        ExecutionType executionType = ExecutionType.getExecutionType(method.getReturnType());</span><br><span class="line">        MetaHolder.Builder builder = metaHolderBuilder(proxy, method, obj, args, joinPoint);</span><br><span class="line">        <span class="keyword">if</span> (isCompileWeaving()) &#123;</span><br><span class="line">            builder.ajcMethod(getAjcMethodFromTarget(joinPoint));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.defaultCommandKey(method.getName())</span><br><span class="line">                        .hystrixCommand(hystrixCommand)</span><br><span class="line">                        .observableExecutionMode(hystrixCommand.observableExecutionMode())</span><br><span class="line">                        .executionType(executionType)</span><br><span class="line">                        .observable(ExecutionType.OBSERVABLE == executionType)</span><br><span class="line">                        .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>⽣成 <code>HystrixInvokable</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixInvokable invokable = HystrixCommandFactory.getInstance().create(metaHolder);</span><br></pre></td></tr></table></figure>
<p><code>HystrixCommandFactory.getInstance()</code>就是一个单例模式，创建一个<code>HystrixCommandFactory</code>对象，</p>
<blockquote>
<p>我们还原一下create()的详细源码：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HystrixInvokable <span class="title">create</span><span class="params">(MetaHolder metaHolder)</span> </span>&#123;</span><br><span class="line">      HystrixInvokable executable;</span><br><span class="line">      <span class="keyword">if</span> (metaHolder.isCollapserAnnotationPresent()) &#123; <span class="comment">// @HystrixCollapser</span></span><br><span class="line">          executable = <span class="keyword">new</span> CommandCollapser(metaHolder);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (metaHolder.isObservable()) &#123; <span class="comment">// Reactive模式</span></span><br><span class="line">          executable = <span class="keyword">new</span> 		   GenericObservableCommand(HystrixCommandBuilderFactory.getInstance().create(metaHolder));</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// @HystrixCommand应该是这种类型</span></span><br><span class="line">         executable = <span class="keyword">new</span> GenericCommand(HystrixCommandBuilderFactory.getInstance().create(metaHolder)); </span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">return</span> executable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>metaHolder.isObservable()</code></li>
</ul>
</li>
</ul>
<ul>
<li><code>GenericCommand</code>继承自抽象类<code>HystrixCommand</code></li>
</ul>
<ul>
<li><p>选择执⾏模式（<code>Observable</code> 或⾮ <code>Observable</code>） </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Object result;</span><br><span class="line"><span class="keyword">if</span> (!metaHolder.isObservable()) &#123; <span class="comment">// 如果是非观察者模式</span></span><br><span class="line">     result = CommandExecutor.execute(invokable, executionType, metaHolder);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   result = executeObservable(invokable, executionType, metaHolder);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="HystrixStreamEndpoint"><a href="#HystrixStreamEndpoint" class="headerlink" title="HystrixStreamEndpoint"></a>HystrixStreamEndpoint</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixStreamEndpoint</span> <span class="keyword">extends</span> <span class="title">ServletWrappingEndpoint</span> </span>&#123;</span><br><span class="line">	<span class="comment">// http://localhost:8080/hystrix.stream</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HystrixStreamEndpoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Servelt类型，servlet名称，servlet的路径</span></span><br><span class="line">		<span class="keyword">super</span>(HystrixMetricsStreamServlet.class, <span class="string">"hystrixStream"</span>, <span class="string">"/hystrix.stream"</span>,</span><br><span class="line">				<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>相当于将其变成一个Servlet供外界访问，不可修改。</p>
</blockquote>
<h2 id="Future实现服务熔断"><a href="#Future实现服务熔断" class="headerlink" title="Future实现服务熔断"></a>Future实现服务熔断</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.segmentfault.springcloudlesson9.future;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过&#123;<span class="doctag">@link</span> java.util.concurrent.Future&#125;来实现服务熔断</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ajin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureCircuitBreakerDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"all"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化线程池 创建一个Executor，它使用单个工作线程操作</span></span><br><span class="line">        ExecutorService executorService = Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">        RandomCommand command = <span class="keyword">new</span> RandomCommand();</span><br><span class="line"></span><br><span class="line">        Future&lt;String&gt; future = executorService.submit(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> command.run(); <span class="comment">// 获取run()计算结果</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        String result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 100毫秒超时时间</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            result=future.get(<span class="number">100</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// fallback方法</span></span><br><span class="line">            result = command.fallback();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机事件执行命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomCommand</span> <span class="keyword">implements</span> <span class="title">Command</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> executeTime = random.nextInt(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过休眠来模拟执行时间</span></span><br><span class="line">            System.out.println(<span class="string">"Execute Time :"</span> + executeTime);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(executeTime);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello World"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">fallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Fall back"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">Command</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 正常执行并且返回结果</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function">T <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 错误时返回的容错结果</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function">T <span class="title">fallback</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liutianruo.com/2019/04/25/MySQL主从同步深入总结/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘天霸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间旅行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/25/MySQL主从同步深入总结/" itemprop="url">MySQL主从同步深入总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-25T21:32:59+08:00">
                2019-04-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何实现-MySQL-的读写分离？"><a href="#如何实现-MySQL-的读写分离？" class="headerlink" title="如何实现 MySQL 的读写分离？"></a>如何实现 MySQL 的读写分离？</h1><p>其实很简单，就是基于主从复制架构，简单来说，就搞一个主库，挂多个从库，然后我们就单单只是写主库，然后主库会自动把数据给同步到从库上去。</p>
<h1 id="MySQL-主从复制原理的是啥？"><a href="#MySQL-主从复制原理的是啥？" class="headerlink" title="MySQL 主从复制原理的是啥？"></a>MySQL 主从复制原理的是啥？</h1><p>主库将变更写入 binlog 日志，然后从库连接到主库之后，从库有一个 IO 线程，将主库的 binlog 日志拷贝到自己本地，写入一个 relay 中继日志中。接着从库中有一个 SQL 线程会从中继日志读取 binlog，然后执行 binlog 日志中的内容，也就是在自己本地再次执行一遍 SQL，这样就可以保证自己跟主库的数据是一样的。</p>
<p><img src="https://liutianruo-2019-go-go-go.oss-cn-shanghai.aliyuncs.com/images/mysql-master-slave.png" alt=""></p>
<p>这里有一个非常重要的一点，就是从库同步主库数据的过程是串行化的，也就是说主库上并行的操作，在从库上会串行执行。所以这就是一个非常重要的点了，由于从库从主库拷贝日志以及串行执行 SQL 的特点，在高并发场景下，从库的数据一定会比主库慢一些，是<strong>有延时</strong>的。所以经常出现，刚写入主库的数据可能是读不到的，要过几十毫秒，甚至几百毫秒才能读取到。</p>
<p>而且这里还有另外一个问题，就是如果主库突然宕机，然后恰好数据还没同步到从库，那么有些数据可能在从库上是没有的，有些数据可能就丢失了。</p>
<p>所以 MySQL 实际上在这一块有两个机制，一个是<strong>半同步复制</strong>，用来解决主库数据丢失问题；一个是<strong>并行复制</strong>，用来解决主从同步延时问题。</p>
<p>这个所谓<strong>半同步复制</strong>，也叫 <code>semi-sync</code> 复制，指的就是主库写入 binlog 日志之后，就会将<strong>强制</strong>此时立即将数据同步到从库，从库将日志写入自己本地的 relay log 之后，接着会返回一个 ack 给主库，主库接收到<strong>至少一个从库</strong>的 ack 之后才会认为写操作完成了。</p>
<p>所谓<strong>并行复制</strong>，指的是从库开启多个线程，并行读取 relay log 中不同库的日志，然后<strong>并行重放不同库的日志</strong>，这是库级别的并行。</p>
<h1 id="MySQL-主从同步延时问题（精华）"><a href="#MySQL-主从同步延时问题（精华）" class="headerlink" title="MySQL 主从同步延时问题（精华）"></a>MySQL 主从同步延时问题（精华）</h1><p>有个同学是这样写代码逻辑的。先插入一条数据，再把它查出来，然后更新这条数据。在生产环境高峰期，写并发达到了 2000/s，这个时候，主从复制延时大概是在小几十毫秒。线上会发现，每天总有那么一些数据，我们期望更新一些重要的数据状态，但在高峰期时候却没更新。用户跟客服反馈，而客服就会反馈给我们。</p>
<p>我们通过 MySQL 命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status</span><br></pre></td></tr></table></figure>
<p>查看 <code>Seconds_Behind_Master</code>，可以看到从库复制主库的数据落后了几 ms。</p>
<p>一般来说，如果主从延迟较为严重，有以下解决方案：</p>
<ul>
<li>分库，将一个主库拆分为多个主库，每个主库的写并发就减少了几倍，此时主从延迟可以忽略不计。</li>
<li>打开 MySQL 支持的并行复制，多个库并行复制。如果说某个库的写入并发就是特别高，单库写并发达到了 2000/s，并行复制还是没意义。</li>
<li>重写代码，写代码的同学，要慎重，插入数据时立马查询可能查不到。</li>
<li>如果确实是存在必须先插入，立马要求就查询到，然后立马就要反过来执行一些操作，对这个查询<strong>设置直连主库</strong>。<strong>不推荐</strong>这种方法，你要是这么搞，读写分离的意义就丧失了。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘天霸</p>
              <p class="site-description motion-element" itemprop="description">Java学习记录博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘天霸</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
